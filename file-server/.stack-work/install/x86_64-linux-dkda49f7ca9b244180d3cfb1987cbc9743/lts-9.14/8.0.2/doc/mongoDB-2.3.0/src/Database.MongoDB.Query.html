<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Query and update documents</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, RecordWildCards, NamedFieldPuns, TupleSections, FlexibleContexts, FlexibleInstances, UndecidableInstances, MultiParamTypeClasses, GeneralizedNewtypeDeriving, StandaloneDeriving, TypeSynonymInstances, TypeFamilies, CPP, DeriveDataTypeable, ScopedTypeVariables, BangPatterns #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>    </span><span class="hs-comment">-- * Monad</span><span>
</span><a name="line-7"></a><span>    </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#ErrorCode"><span class="hs-identifier hs-type">ErrorCode</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>    </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#GetLastError"><span class="hs-identifier hs-type">GetLastError</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#master"><span class="hs-identifier hs-var">master</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#accessMode"><span class="hs-identifier hs-var">accessMode</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>    </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#HasMongoContext"><span class="hs-identifier hs-type">HasMongoContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>    </span><span class="hs-comment">-- * Database</span><span>
</span><a name="line-12"></a><span>    </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#allDatabases"><span class="hs-identifier hs-var">allDatabases</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- ** Authentication</span><span>
</span><a name="line-14"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#auth"><span class="hs-identifier hs-var">auth</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#authMongoCR"><span class="hs-identifier hs-var">authMongoCR</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#authSCRAMSHA1"><span class="hs-identifier hs-var">authSCRAMSHA1</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- * Collection</span><span>
</span><a name="line-16"></a><span>    </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#allCollections"><span class="hs-identifier hs-var">allCollections</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-comment">-- ** Selection</span><span>
</span><a name="line-18"></a><span>    </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#whereJS"><span class="hs-identifier hs-var">whereJS</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-type">Select</span></a><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><span class="hs-comment">-- * Write</span><span>
</span><a name="line-21"></a><span>    </span><span class="hs-comment">-- ** Insert</span><span>
</span><a name="line-22"></a><span>    </span><a href="Database.MongoDB.Query.html#insert"><span class="hs-identifier hs-var">insert</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#insert_"><span class="hs-identifier hs-var">insert_</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#insertMany"><span class="hs-identifier hs-var">insertMany</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#insertMany_"><span class="hs-identifier hs-var">insertMany_</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#insertAll"><span class="hs-identifier hs-var">insertAll</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#insertAll_"><span class="hs-identifier hs-var">insertAll_</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><span class="hs-comment">-- ** Update</span><span>
</span><a name="line-24"></a><span>    </span><a href="Database.MongoDB.Query.html#save"><span class="hs-identifier hs-var">save</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#replace"><span class="hs-identifier hs-var">replace</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#repsert"><span class="hs-identifier hs-var">repsert</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#upsert"><span class="hs-identifier hs-var">upsert</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Modifier"><span class="hs-identifier hs-type">Modifier</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#modify"><span class="hs-identifier hs-var">modify</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#updateMany"><span class="hs-identifier hs-var">updateMany</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#updateAll"><span class="hs-identifier hs-var">updateAll</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>    </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier hs-type">Upserted</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-comment">-- ** Delete</span><span>
</span><a name="line-27"></a><span>    </span><a href="Database.MongoDB.Query.html#delete"><span class="hs-identifier hs-var">delete</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#deleteOne"><span class="hs-identifier hs-var">deleteOne</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#deleteMany"><span class="hs-identifier hs-var">deleteMany</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#deleteAll"><span class="hs-identifier hs-var">deleteAll</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>    </span><span class="hs-comment">-- * Read</span><span>
</span><a name="line-29"></a><span>    </span><span class="hs-comment">-- ** Query</span><span>
</span><a name="line-30"></a><span>    </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#NoCursorTimeout"><span class="hs-identifier hs-var">NoCursorTimeout</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#TailableCursor"><span class="hs-identifier hs-var">TailableCursor</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#AwaitData"><span class="hs-identifier hs-var">AwaitData</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Partial"><span class="hs-identifier hs-var">Partial</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>    </span><a href="Database.MongoDB.Query.html#Projector"><span class="hs-identifier hs-type">Projector</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>    </span><a href="Database.MongoDB.Query.html#explain"><span class="hs-identifier hs-var">explain</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#fetch"><span class="hs-identifier hs-var">fetch</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>    </span><a href="Database.MongoDB.Query.html#findAndModify"><span class="hs-identifier hs-var">findAndModify</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#findAndModifyOpts"><span class="hs-identifier hs-var">findAndModifyOpts</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#FindAndModifyOpts"><span class="hs-identifier hs-type">FindAndModifyOpts</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#defFamUpdateOpts"><span class="hs-identifier hs-var">defFamUpdateOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>    </span><a href="Database.MongoDB.Query.html#count"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#distinct"><span class="hs-identifier hs-var">distinct</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-comment">-- *** Cursor</span><span>
</span><a name="line-36"></a><span>    </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#nextBatch"><span class="hs-identifier hs-var">nextBatch</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#next"><span class="hs-identifier hs-var">next</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#nextN"><span class="hs-identifier hs-var">nextN</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#closeCursor"><span class="hs-identifier hs-var">closeCursor</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#isCursorClosed"><span class="hs-identifier hs-var">isCursorClosed</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-comment">-- ** Aggregate</span><span>
</span><a name="line-38"></a><span>    </span><a href="Database.MongoDB.Query.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#aggregate"><span class="hs-identifier hs-var">aggregate</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>    </span><span class="hs-comment">-- ** Group</span><span>
</span><a name="line-40"></a><span>    </span><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier hs-type">Group</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#GroupKey"><span class="hs-identifier hs-type">GroupKey</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#group"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-comment">-- ** MapReduce</span><span>
</span><a name="line-42"></a><span>    </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-type">MapReduce</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#MapFun"><span class="hs-identifier hs-type">MapFun</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#ReduceFun"><span class="hs-identifier hs-type">ReduceFun</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#FinalizeFun"><span class="hs-identifier hs-type">FinalizeFun</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#MROut"><span class="hs-identifier hs-type">MROut</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#MRMerge"><span class="hs-identifier hs-type">MRMerge</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>    </span><a href="Database.MongoDB.Query.html#MRResult"><span class="hs-identifier hs-type">MRResult</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#mapReduce"><span class="hs-identifier hs-var">mapReduce</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runMR"><span class="hs-identifier hs-var">runMR</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runMR%27"><span class="hs-identifier hs-var">runMR'</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-comment">-- * Command</span><span>
</span><a name="line-45"></a><span>    </span><a href="Database.MongoDB.Query.html#Command"><span class="hs-identifier hs-type">Command</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runCommand1"><span class="hs-identifier hs-var">runCommand1</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>    </span><a href="Database.MongoDB.Query.html#eval"><span class="hs-identifier hs-var">eval</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier hs-var">retrieveServerData</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftM2</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lefts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">rights</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl1'</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,8,0)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mappend</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Typeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Mem</span><span class="hs-operator">.</span><span class="hs-identifier">Weak</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Weak</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MV</span><span>
</span><a name="line-64"></a><span class="hs-cpp">#if MIN_VERSION_base(4,6,0)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>                                       </span><span class="hs-identifier hs-var">readMVar</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addMVarFinalizer</span><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>                                         </span><span class="hs-identifier">readMVar</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Error</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Reader</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadReader</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">asks</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">local</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Put</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runPut</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Field</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Label</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Val</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">(</span><span class="hs-identifier hs-var">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Doc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Bool</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>                  </span><span class="hs-identifier hs-type">Javascript</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">valueAt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">look</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">genObjectId</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">=:</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>                  </span><span class="hs-special">(</span><span class="hs-operator hs-var">=?</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!?</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Val</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ObjectId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Value</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putDocument</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier hs-type">ResponseFlag</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#GetMore"><span class="hs-identifier hs-var">GetMore</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qOptions</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qSkip</span><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>                                           </span><span class="hs-identifier">qFullCollection</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qBatchSize</span><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>                                           </span><span class="hs-identifier">qSelector</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qProjector</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>                                           </span><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier hs-var">pwKey</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Util.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#loop"><span class="hs-identifier hs-var">loop</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">P</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Nonce</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Nonce</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LBS</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Base16</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B16</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Base64</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B64</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Either</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hash</span><span class="hs-operator">.</span><span class="hs-identifier">MD5</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MD5</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hash</span><span class="hs-operator">.</span><span class="hs-identifier">SHA1</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SHA1</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">MAC</span><span class="hs-operator">.</span><span class="hs-identifier">HMAC</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HMAC</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Read</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">-- * Monad</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-keyword">type</span><span> </span><a name="Action"><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier">Action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- ^ A monad on top of m (which must be a MonadIO) that may access the database and may fail with a DB 'Failure'</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">access</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090472"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090472"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090473"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090472"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090473"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- ^ Run action against database on server at other end of pipe. Use access mode for any reads and writes.</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- Throw 'Failure' in case of any error.</span><span>
</span><a name="line-120"></a><a name="access"><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier">access</span></a></a><span> </span><a name="local-6989586621679090474"><a href="#local-6989586621679090474"><span class="hs-identifier">mongoPipe</span></a></a><span> </span><a name="local-6989586621679090475"><a href="#local-6989586621679090475"><span class="hs-identifier">mongoAccessMode</span></a></a><span> </span><a name="local-6989586621679090476"><a href="#local-6989586621679090476"><span class="hs-identifier">mongoDatabase</span></a></a><span> </span><a name="local-6989586621679090477"><a href="#local-6989586621679090477"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679090477"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-var">MongoContext</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">-- | A connection failure, or a read or write exception like cursor expired or inserting a duplicate key.</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- Note, unexpected data from the server is not a Failure, rather it is a programming error (you should call 'error' in this case) because the client and server are incompatible and requires a programming change.</span><span>
</span><a name="line-124"></a><span class="hs-keyword">data</span><span> </span><a name="Failure"><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier">Failure</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-125"></a><span>     </span><a name="ConnectionFailure"><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier">ConnectionFailure</span></a></a><span> </span><span class="hs-identifier hs-type">IOError</span><span>  </span><span class="hs-comment">-- ^ TCP connection ('Pipeline') failed. May work if you try again on the same Mongo 'Connection' which will create a new Pipe.</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="CursorNotFoundFailure"><a href="Database.MongoDB.Query.html#CursorNotFoundFailure"><span class="hs-identifier">CursorNotFoundFailure</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span>  </span><span class="hs-comment">-- ^ Cursor expired because it wasn't accessed for over 10 minutes, or this cursor came from a different server that the one you are currently connected to (perhaps a fail over happen between servers in a replica set)</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="QueryFailure"><a href="Database.MongoDB.Query.html#QueryFailure"><span class="hs-identifier">QueryFailure</span></a></a><span> </span><a href="Database.MongoDB.Query.html#ErrorCode"><span class="hs-identifier hs-type">ErrorCode</span></a><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ Query failed for some reason as described in the string</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="WriteFailure"><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier">WriteFailure</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><a href="Database.MongoDB.Query.html#ErrorCode"><span class="hs-identifier hs-type">ErrorCode</span></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ Error observed by getLastError after a write, error description is in string, index of failed document is the first argument</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="WriteConcernFailure"><a href="Database.MongoDB.Query.html#WriteConcernFailure"><span class="hs-identifier">WriteConcernFailure</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ Write concern error. It's reported only by insert, update, delete commands. Not by wire protocol.</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="DocNotFound"><a href="Database.MongoDB.Query.html#DocNotFound"><span class="hs-identifier">DocNotFound</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span>  </span><span class="hs-comment">-- ^ 'fetch' found no document matching selection</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="AggregateFailure"><a href="Database.MongoDB.Query.html#AggregateFailure"><span class="hs-identifier">AggregateFailure</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ 'aggregate' returned an error</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="CompoundFailure"><a href="Database.MongoDB.Query.html#CompoundFailure"><span class="hs-identifier">CompoundFailure</span></a></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ When we need to aggregate several failures and report them.</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ProtocolFailure"><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier">ProtocolFailure</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The structure of the returned documents doesn't match what we expected</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-keyword">type</span><span> </span><a name="ErrorCode"><a href="Database.MongoDB.Query.html#ErrorCode"><span class="hs-identifier">ErrorCode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- ^ Error code from getLastError or query failure</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Error</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-8214565720323803412"><span class="hs-identifier">strMsg</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- ^ 'fail' is treated the same as a programming 'error'. In other words, don't use it.</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Type of reads and writes to perform</span><span>
</span><a name="line-144"></a><span class="hs-keyword">data</span><span> </span><a name="AccessMode"><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier">AccessMode</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-145"></a><span>     </span><a name="ReadStaleOk"><a href="Database.MongoDB.Query.html#ReadStaleOk"><span class="hs-identifier">ReadStaleOk</span></a></a><span>  </span><span class="hs-comment">-- ^ Read-only action, reading stale data from a slave is OK.</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="UnconfirmedWrites"><a href="Database.MongoDB.Query.html#UnconfirmedWrites"><span class="hs-identifier">UnconfirmedWrites</span></a></a><span>  </span><span class="hs-comment">-- ^ Read-write action, slave not OK, every write is fire &amp; forget.</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ConfirmWrites"><a href="Database.MongoDB.Query.html#ConfirmWrites"><span class="hs-identifier">ConfirmWrites</span></a></a><span> </span><a href="Database.MongoDB.Query.html#GetLastError"><span class="hs-identifier hs-type">GetLastError</span></a><span>  </span><span class="hs-comment">-- ^ Read-write action, slave not OK, every write is confirmed with getLastError.</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-keyword">type</span><span> </span><a name="GetLastError"><a href="Database.MongoDB.Query.html#GetLastError"><span class="hs-identifier">GetLastError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- ^ Parameters for getLastError command. For example @[\&quot;w\&quot; =: 2]@ tells the server to wait for the write to reach at least two servers in replica set before acknowledging. See &lt;http://www.mongodb.org/display/DOCS/Last+Error+Commands&gt; for more options.</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">class</span><span> </span><a name="Result"><a href="Database.MongoDB.Query.html#Result"><span class="hs-identifier">Result</span></a></a><span> </span><a name="local-6989586621679090234"><a href="#local-6989586621679090234"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-identifier">isFailed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679090234"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-keyword">data</span><span> </span><a name="WriteResult"><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier">WriteResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WriteResult"><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier">WriteResult</span></a></a><span>
</span><a name="line-157"></a><span>                  </span><span class="hs-special">{</span><span> </span><a name="failed"><a href="Database.MongoDB.Query.html#failed"><span class="hs-identifier">failed</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-158"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="nMatched"><a href="Database.MongoDB.Query.html#nMatched"><span class="hs-identifier">nMatched</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-159"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="nModified"><a href="Database.MongoDB.Query.html#nModified"><span class="hs-identifier">nModified</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-160"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="nRemoved"><a href="Database.MongoDB.Query.html#nRemoved"><span class="hs-identifier">nRemoved</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-161"></a><span>                  </span><span class="hs-comment">-- ^ Mongodb server before 2.6 doesn't allow to calculate this value.</span><span>
</span><a name="line-162"></a><span>                  </span><span class="hs-comment">-- This field is meaningless if we can't calculate the number of modified documents.</span><span>
</span><a name="line-163"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="upserted"><a href="Database.MongoDB.Query.html#upserted"><span class="hs-identifier">upserted</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier hs-type">Upserted</span></a><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="writeErrors"><a href="Database.MongoDB.Query.html#writeErrors"><span class="hs-identifier">writeErrors</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="writeConcernErrors"><a href="Database.MongoDB.Query.html#writeConcernErrors"><span class="hs-identifier">writeConcernErrors</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">]</span><span>
</span><a name="line-166"></a><span>                  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.MongoDB.Query.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>  </span><a name="local-8214565720323865028"><a href="Database.MongoDB.Query.html#isFailed"><span class="hs-identifier">isFailed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">failed</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.MongoDB.Query.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679091012"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679091013"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-172"></a><span>  </span><a name="local-8214565720323865028"><a href="Database.MongoDB.Query.html#isFailed"><span class="hs-identifier">isFailed</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-identifier">isFailed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-keyword">data</span><span> </span><a name="Upserted"><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier">Upserted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Upserted"><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier">Upserted</span></a></a><span>
</span><a name="line-176"></a><span>              </span><span class="hs-special">{</span><span> </span><a name="upsertedIndex"><a href="Database.MongoDB.Query.html#upsertedIndex"><span class="hs-identifier">upsertedIndex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-177"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="upsertedId"><a href="Database.MongoDB.Query.html#upsertedId"><span class="hs-identifier">upsertedId</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ObjectId</span><span>
</span><a name="line-178"></a><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">master</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- ^ Same as 'ConfirmWrites' []</span><span>
</span><a name="line-182"></a><a name="master"><a href="Database.MongoDB.Query.html#master"><span class="hs-identifier">master</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#ConfirmWrites"><span class="hs-identifier hs-var">ConfirmWrites</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">slaveOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- ^ Same as 'ReadStaleOk'</span><span>
</span><a name="line-186"></a><a name="slaveOk"><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier">slaveOk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#ReadStaleOk"><span class="hs-identifier hs-var">ReadStaleOk</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">accessMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679090470"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090470"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090471"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090470"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090471"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- ^ Run action with given 'AccessMode'</span><span>
</span><a name="line-190"></a><a name="accessMode"><a href="Database.MongoDB.Query.html#accessMode"><span class="hs-identifier">accessMode</span></a></a><span> </span><a name="local-6989586621679090478"><a href="#local-6989586621679090478"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679090479"><a href="#local-6989586621679090479"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679090480"><a href="#local-6989586621679090480"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090480"><span class="hs-identifier hs-var">ctx</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">mongoAccessMode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090478"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090479"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-identifier">readMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#ReadMode"><span class="hs-identifier hs-type">ReadMode</span></a><span>
</span><a name="line-193"></a><a name="readMode"><a href="Database.MongoDB.Query.html#readMode"><span class="hs-identifier">readMode</span></a></a><span> </span><a href="Database.MongoDB.Query.html#ReadStaleOk"><span class="hs-identifier hs-var">ReadStaleOk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#StaleOk"><span class="hs-identifier hs-var">StaleOk</span></a><span>
</span><a name="line-194"></a><span class="hs-identifier">readMode</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-identifier">writeMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteMode"><span class="hs-identifier hs-type">WriteMode</span></a><span>
</span><a name="line-197"></a><a name="writeMode"><a href="Database.MongoDB.Query.html#writeMode"><span class="hs-identifier">writeMode</span></a></a><span> </span><a href="Database.MongoDB.Query.html#ReadStaleOk"><span class="hs-identifier hs-var">ReadStaleOk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-198"></a><span class="hs-identifier">writeMode</span><span> </span><a href="Database.MongoDB.Query.html#UnconfirmedWrites"><span class="hs-identifier hs-var">UnconfirmedWrites</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span>
</span><a name="line-199"></a><span class="hs-identifier">writeMode</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#ConfirmWrites"><span class="hs-identifier hs-var">ConfirmWrites</span></a><span> </span><a name="local-6989586621679090481"><a href="#local-6989586621679090481"><span class="hs-identifier">z</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a href="#local-6989586621679090481"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">-- | Values needed when executing a db operation</span><span>
</span><a name="line-202"></a><span class="hs-keyword">data</span><span> </span><a name="MongoContext"><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier">MongoContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MongoContext"><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier">MongoContext</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-203"></a><span>    </span><a name="mongoPipe"><a href="Database.MongoDB.Query.html#mongoPipe"><span class="hs-identifier">mongoPipe</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ operations read/write to this pipelined TCP connection to a MongoDB server</span><span>
</span><a name="line-204"></a><span>    </span><a name="mongoAccessMode"><a href="Database.MongoDB.Query.html#mongoAccessMode"><span class="hs-identifier">mongoAccessMode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#AccessMode"><span class="hs-identifier hs-type">AccessMode</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ read/write operation will use this access mode</span><span>
</span><a name="line-205"></a><span>    </span><a name="mongoDatabase"><a href="Database.MongoDB.Query.html#mongoDatabase"><span class="hs-identifier">mongoDatabase</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- ^ operations query/update this database</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-identifier">mongoReadMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#ReadMode"><span class="hs-identifier hs-type">ReadMode</span></a><span>
</span><a name="line-208"></a><a name="mongoReadMode"><a href="Database.MongoDB.Query.html#mongoReadMode"><span class="hs-identifier">mongoReadMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#readMode"><span class="hs-identifier hs-var">readMode</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">mongoAccessMode</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">mongoWriteMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteMode"><span class="hs-identifier hs-type">WriteMode</span></a><span>
</span><a name="line-211"></a><a name="mongoWriteMode"><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier">mongoWriteMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#writeMode"><span class="hs-identifier hs-var">writeMode</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">mongoAccessMode</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-keyword">class</span><span> </span><a name="HasMongoContext"><a href="Database.MongoDB.Query.html#HasMongoContext"><span class="hs-identifier">HasMongoContext</span></a></a><span> </span><a name="local-6989586621679090233"><a href="#local-6989586621679090233"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-identifier">mongoContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679090233"><span class="hs-identifier hs-type">env</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span>
</span><a name="line-215"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.MongoDB.Query.html#HasMongoContext"><span class="hs-identifier hs-type">HasMongoContext</span></a><span> </span><a href="Database.MongoDB.Query.html#MongoContext"><span class="hs-identifier hs-type">MongoContext</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-8214565720323865008"><a href="Database.MongoDB.Query.html#mongoContext"><span class="hs-identifier">mongoContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-identifier">liftDB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="#local-6989586621679090302"><span class="hs-identifier hs-type">env</span></a><span> </span><a href="#local-6989586621679090303"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#HasMongoContext"><span class="hs-identifier hs-type">HasMongoContext</span></a><span> </span><a href="#local-6989586621679090302"><span class="hs-identifier hs-type">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090303"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679090304"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-220"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090303"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090304"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-221"></a><a name="liftDB"><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier">liftDB</span></a></a><span> </span><a name="local-6989586621679090482"><a href="#local-6989586621679090482"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621679090483"><a href="#local-6989586621679090483"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679090482"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#mongoContext"><span class="hs-identifier hs-var">mongoContext</span></a><span> </span><a href="#local-6989586621679090483"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- * Database</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-keyword">type</span><span> </span><a name="Database"><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier">Database</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-identifier">allDatabases</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090301"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090301"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span class="hs-special">]</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- ^ List all databases residing on server</span><span>
</span><a name="line-231"></a><a name="allDatabases"><a href="Database.MongoDB.Query.html#allDatabases"><span class="hs-identifier">allDatabases</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;name&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;databases&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><span class="hs-string">&quot;admin&quot;</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#runCommand1"><span class="hs-identifier hs-var">runCommand1</span></a><span> </span><span class="hs-string">&quot;listDatabases&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-identifier">thisDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679090300"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090300"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- ^ Current database in use</span><span>
</span><a name="line-235"></a><a name="thisDatabase"><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier">thisDatabase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoDatabase</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">useDb</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679090298"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090298"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090299"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090298"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090299"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-238"></a><span class="hs-comment">-- ^ Run action against given database</span><span>
</span><a name="line-239"></a><a name="useDb"><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier">useDb</span></a></a><span> </span><a name="local-6989586621679090484"><a href="#local-6989586621679090484"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679090485"><a href="#local-6989586621679090485"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">local</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679090486"><a href="#local-6989586621679090486"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090486"><span class="hs-identifier hs-var">ctx</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">mongoDatabase</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090484"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090485"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">-- * Authentication</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">auth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090297"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090297"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- ^ Authenticate with the current database (if server is running in secure mode). Return whether authentication was successful or not. Reauthentication is required for every new pipe. SCRAM-SHA-1 will be used for server versions 3.0+, MONGO-CR for lower versions.</span><span>
</span><a name="line-245"></a><a name="auth"><a href="Database.MongoDB.Query.html#auth"><span class="hs-identifier">auth</span></a></a><span> </span><a name="local-6989586621679090487"><a href="#local-6989586621679090487"><span class="hs-identifier">un</span></a></a><span> </span><a name="local-6989586621679090488"><a href="#local-6989586621679090488"><span class="hs-identifier">pw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090491"><a href="#local-6989586621679090491"><span class="hs-identifier">serverVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;version&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><span class="hs-string">&quot;admin&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;buildinfo&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621679090492"><a href="#local-6989586621679090492"><span class="hs-identifier">mmv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">splitOn</span><span> </span><span class="hs-string">&quot;.&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090491"><span class="hs-identifier hs-var">serverVersion</span></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090489"><span class="hs-identifier hs-var">performAuth</span></a><span> </span><a href="#local-6989586621679090492"><span class="hs-identifier hs-var">mmv</span></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-250"></a><span>    </span><a name="local-6989586621679090489"><a href="#local-6989586621679090489"><span class="hs-identifier">performAuth</span></a></a><span> </span><a name="local-6989586621679090490"><a href="#local-6989586621679090490"><span class="hs-identifier">majorVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090490"><span class="hs-identifier hs-var">majorVersion</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-number">3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-252"></a><span>            </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#authSCRAMSHA1"><span class="hs-identifier hs-var">authSCRAMSHA1</span></a><span> </span><a href="#local-6989586621679090487"><span class="hs-identifier hs-var">un</span></a><span> </span><a href="#local-6989586621679090488"><span class="hs-identifier hs-var">pw</span></a><span>
</span><a name="line-253"></a><span>            </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#authMongoCR"><span class="hs-identifier hs-var">authMongoCR</span></a><span> </span><a href="#local-6989586621679090487"><span class="hs-identifier hs-var">un</span></a><span> </span><a href="#local-6989586621679090488"><span class="hs-identifier hs-var">pw</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">authMongoCR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090296"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090296"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- ^ Authenticate with the current database, using the MongoDB-CR authentication mechanism (default in MongoDB server &lt; 3.0)</span><span>
</span><a name="line-257"></a><a name="authMongoCR"><a href="Database.MongoDB.Query.html#authMongoCR"><span class="hs-identifier">authMongoCR</span></a></a><span> </span><a name="local-6989586621679090493"><a href="#local-6989586621679090493"><span class="hs-identifier">usr</span></a></a><span> </span><a name="local-6989586621679090494"><a href="#local-6989586621679090494"><span class="hs-identifier">pss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>    </span><a name="local-6989586621679090495"><a href="#local-6989586621679090495"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;nonce&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;getnonce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-259"></a><span>    </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;authenticate&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090493"><span class="hs-identifier hs-var">usr</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;nonce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090495"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;key&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier hs-var">pwKey</span></a><span> </span><a href="#local-6989586621679090495"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679090493"><span class="hs-identifier hs-var">usr</span></a><span> </span><a href="#local-6989586621679090494"><span class="hs-identifier hs-var">pss</span></a><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-identifier">authSCRAMSHA1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090295"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090295"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- ^ Authenticate with the current database, using the SCRAM-SHA-1 authentication mechanism (default in MongoDB server &gt;= 3.0)</span><span>
</span><a name="line-263"></a><a name="authSCRAMSHA1"><a href="Database.MongoDB.Query.html#authSCRAMSHA1"><span class="hs-identifier">authSCRAMSHA1</span></a></a><span> </span><a name="local-6989586621679090496"><a href="#local-6989586621679090496"><span class="hs-identifier">un</span></a></a><span> </span><a name="local-6989586621679090497"><a href="#local-6989586621679090497"><span class="hs-identifier">pw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090500"><a href="#local-6989586621679090500"><span class="hs-identifier">hmac</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HMAC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hmac</span><span> </span><span class="hs-identifier hs-var">SHA1</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><span class="hs-number">64</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621679090501"><a href="#local-6989586621679090501"><span class="hs-identifier">nonce</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nonce</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">new</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">Nonce</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">nonce128</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090502"><a href="#local-6989586621679090502"><span class="hs-identifier">firstBare</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;n=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679090496"><span class="hs-identifier hs-var">un</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;,r=&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090501"><span class="hs-identifier hs-var">nonce</span></a><span class="hs-special">]</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090503"><a href="#local-6989586621679090503"><span class="hs-identifier">client1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;saslStart&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;mechanism&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;SCRAM-SHA-1&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;payload&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;n,,&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090502"><span class="hs-identifier hs-var">firstBare</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;autoAuthorize&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679090504"><a href="#local-6989586621679090504"><span class="hs-identifier">server1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><a href="#local-6989586621679090503"><span class="hs-identifier hs-var">client1</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>    </span><a href="#local-6989586621679090498"><span class="hs-identifier hs-var">shortcircuit</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090504"><span class="hs-identifier hs-var">server1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090505"><a href="#local-6989586621679090505"><span class="hs-identifier">serverPayload1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeLenient</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;payload&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090504"><span class="hs-identifier hs-var">server1</span></a><span>
</span><a name="line-272"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090506"><a href="#local-6989586621679090506"><span class="hs-identifier">serverData1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#parseSCRAM"><span class="hs-identifier hs-var">parseSCRAM</span></a><span> </span><a href="#local-6989586621679090505"><span class="hs-identifier hs-var">serverPayload1</span></a><span>
</span><a name="line-273"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090507"><a href="#local-6989586621679090507"><span class="hs-identifier">iterations</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span> </span><span class="hs-string">&quot;1&quot;</span><span> </span><span class="hs-string">&quot;i&quot;</span><span> </span><a href="#local-6989586621679090506"><span class="hs-identifier hs-var">serverData1</span></a><span>
</span><a name="line-274"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090508"><a href="#local-6989586621679090508"><span class="hs-identifier">salt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeLenient</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;s&quot;</span><span> </span><a href="#local-6989586621679090506"><span class="hs-identifier hs-var">serverData1</span></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090509"><a href="#local-6989586621679090509"><span class="hs-identifier">snonce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;r&quot;</span><span> </span><a href="#local-6989586621679090506"><span class="hs-identifier hs-var">serverData1</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span>        </span><a href="#local-6989586621679090498"><span class="hs-identifier hs-var">shortcircuit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isInfixOf</span><span> </span><a href="#local-6989586621679090501"><span class="hs-identifier hs-var">nonce</span></a><span> </span><a href="#local-6989586621679090509"><span class="hs-identifier hs-var">snonce</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090510"><a href="#local-6989586621679090510"><span class="hs-identifier">withoutProof</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;c=biws,r=&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090509"><span class="hs-identifier hs-var">snonce</span></a><span class="hs-special">]</span><span>
</span><a name="line-279"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090511"><a href="#local-6989586621679090511"><span class="hs-identifier">digestS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679090496"><span class="hs-identifier hs-var">un</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;:mongo:&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679090497"><span class="hs-identifier hs-var">pw</span></a><span>
</span><a name="line-280"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090512"><a href="#local-6989586621679090512"><span class="hs-identifier">digest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B16</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">MD5</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><a href="#local-6989586621679090511"><span class="hs-identifier hs-var">digestS</span></a><span>
</span><a name="line-281"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090513"><a href="#local-6989586621679090513"><span class="hs-identifier">saltedPass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#scramHI"><span class="hs-identifier hs-var">scramHI</span></a><span> </span><a href="#local-6989586621679090512"><span class="hs-identifier hs-var">digest</span></a><span> </span><a href="#local-6989586621679090508"><span class="hs-identifier hs-var">salt</span></a><span> </span><a href="#local-6989586621679090507"><span class="hs-identifier hs-var">iterations</span></a><span>
</span><a name="line-282"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090514"><a href="#local-6989586621679090514"><span class="hs-identifier">clientKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090500"><span class="hs-identifier hs-var">hmac</span></a><span> </span><a href="#local-6989586621679090513"><span class="hs-identifier hs-var">saltedPass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;Client Key&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090515"><a href="#local-6989586621679090515"><span class="hs-identifier">storedKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SHA1</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><a href="#local-6989586621679090514"><span class="hs-identifier hs-var">clientKey</span></a><span>
</span><a name="line-284"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090516"><a href="#local-6989586621679090516"><span class="hs-identifier">authMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090502"><span class="hs-identifier hs-var">firstBare</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;,&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090505"><span class="hs-identifier hs-var">serverPayload1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;,&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090510"><span class="hs-identifier hs-var">withoutProof</span></a><span class="hs-special">]</span><span>
</span><a name="line-285"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090517"><a href="#local-6989586621679090517"><span class="hs-identifier">clientSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090500"><span class="hs-identifier hs-var">hmac</span></a><span> </span><a href="#local-6989586621679090515"><span class="hs-identifier hs-var">storedKey</span></a><span> </span><a href="#local-6989586621679090516"><span class="hs-identifier hs-var">authMsg</span></a><span>
</span><a name="line-286"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090518"><a href="#local-6989586621679090518"><span class="hs-identifier">pval</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">xor</span><span> </span><a href="#local-6989586621679090514"><span class="hs-identifier hs-var">clientKey</span></a><span> </span><a href="#local-6989586621679090517"><span class="hs-identifier hs-var">clientSig</span></a><span>
</span><a name="line-287"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090519"><a href="#local-6989586621679090519"><span class="hs-identifier">clientFinal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090510"><span class="hs-identifier hs-var">withoutProof</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;,p=&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090518"><span class="hs-identifier hs-var">pval</span></a><span class="hs-special">]</span><span>
</span><a name="line-288"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090520"><a href="#local-6989586621679090520"><span class="hs-identifier">serverKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090500"><span class="hs-identifier hs-var">hmac</span></a><span> </span><a href="#local-6989586621679090513"><span class="hs-identifier hs-var">saltedPass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-string">&quot;Server Key&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090521"><a href="#local-6989586621679090521"><span class="hs-identifier">serverSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090500"><span class="hs-identifier hs-var">hmac</span></a><span> </span><a href="#local-6989586621679090520"><span class="hs-identifier hs-var">serverKey</span></a><span> </span><a href="#local-6989586621679090516"><span class="hs-identifier hs-var">authMsg</span></a><span>
</span><a name="line-290"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090522"><a href="#local-6989586621679090522"><span class="hs-identifier">client2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;saslContinue&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;conversationId&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;conversationId&quot;</span><span> </span><a href="#local-6989586621679090504"><span class="hs-identifier hs-var">server1</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;payload&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span><span> </span><a href="#local-6989586621679090519"><span class="hs-identifier hs-var">clientFinal</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-291"></a><span>            </span><a name="local-6989586621679090523"><a href="#local-6989586621679090523"><span class="hs-identifier">server2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><a href="#local-6989586621679090522"><span class="hs-identifier hs-var">client2</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span>            </span><a href="#local-6989586621679090498"><span class="hs-identifier hs-var">shortcircuit</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090523"><span class="hs-identifier hs-var">server2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-294"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090524"><a href="#local-6989586621679090524"><span class="hs-identifier">serverPayload2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B64</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeLenient</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;payload&quot;</span><span> </span><a href="#local-6989586621679090523"><span class="hs-identifier hs-var">server2</span></a><span>
</span><a name="line-295"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090525"><a href="#local-6989586621679090525"><span class="hs-identifier">serverData2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#parseSCRAM"><span class="hs-identifier hs-var">parseSCRAM</span></a><span> </span><a href="#local-6989586621679090524"><span class="hs-identifier hs-var">serverPayload2</span></a><span>
</span><a name="line-296"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090526"><a href="#local-6989586621679090526"><span class="hs-identifier">serverSigComp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">findWithDefault</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;v&quot;</span><span> </span><a href="#local-6989586621679090525"><span class="hs-identifier hs-var">serverData2</span></a><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>                </span><a href="#local-6989586621679090498"><span class="hs-identifier hs-var">shortcircuit</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090521"><span class="hs-identifier hs-var">serverSig</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679090526"><span class="hs-identifier hs-var">serverSigComp</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-299"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090527"><a href="#local-6989586621679090527"><span class="hs-identifier">done</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span> </span><a href="#local-6989586621679090523"><span class="hs-identifier hs-var">server2</span></a><span>
</span><a name="line-300"></a><span>                  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090527"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-301"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-302"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-303"></a><span>                      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090528"><a href="#local-6989586621679090528"><span class="hs-identifier">client2Step2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;saslContinue&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;conversationId&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;conversationId&quot;</span><span> </span><a href="#local-6989586621679090504"><span class="hs-identifier hs-var">server1</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;payload&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">String</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-306"></a><span>                      </span><a name="local-6989586621679090529"><a href="#local-6989586621679090529"><span class="hs-identifier">server3</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><a href="#local-6989586621679090528"><span class="hs-identifier hs-var">client2Step2</span></a><span>
</span><a name="line-307"></a><span>                      </span><a href="#local-6989586621679090498"><span class="hs-identifier hs-var">shortcircuit</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090529"><span class="hs-identifier hs-var">server3</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-308"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-310"></a><span>    </span><a name="local-6989586621679090498"><a href="#local-6989586621679090498"><span class="hs-identifier">shortcircuit</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621679090499"><a href="#local-6989586621679090499"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090499"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-311"></a><span>    </span><span class="hs-identifier">shortcircuit</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span class="hs-identifier">scramHI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-314"></a><a name="scramHI"><a href="Database.MongoDB.Query.html#scramHI"><span class="hs-identifier">scramHI</span></a></a><span> </span><a name="local-6989586621679090530"><a href="#local-6989586621679090530"><span class="hs-identifier">digest</span></a></a><span> </span><a name="local-6989586621679090531"><a href="#local-6989586621679090531"><span class="hs-identifier">salt</span></a></a><span> </span><a name="local-6989586621679090532"><a href="#local-6989586621679090532"><span class="hs-identifier">iters</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="#local-6989586621679090535"><span class="hs-identifier hs-var">com</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090534"><span class="hs-identifier hs-var">u1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090534"><span class="hs-identifier hs-var">u1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">(</span><a href="#local-6989586621679090532"><span class="hs-identifier hs-var">iters</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-315"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-316"></a><span>    </span><a name="local-6989586621679090533"><a href="#local-6989586621679090533"><span class="hs-identifier">hmacd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HMAC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hmac</span><span> </span><span class="hs-identifier hs-var">SHA1</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><span class="hs-number">64</span><span> </span><a href="#local-6989586621679090530"><span class="hs-identifier hs-var">digest</span></a><span>
</span><a name="line-317"></a><span>    </span><a name="local-6989586621679090534"><a href="#local-6989586621679090534"><span class="hs-identifier">u1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090533"><span class="hs-identifier hs-var">hmacd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090531"><span class="hs-identifier hs-var">salt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>    </span><a name="local-6989586621679090535"><a href="#local-6989586621679090535"><span class="hs-identifier">com</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090536"><a href="#local-6989586621679090536"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><a name="local-6989586621679090537"><a href="#local-6989586621679090537"><span class="hs-identifier">uc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090538"><a href="#local-6989586621679090538"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090533"><span class="hs-identifier hs-var">hmacd</span></a><span> </span><a href="#local-6989586621679090536"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090538"><span class="hs-identifier hs-var">u'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">xor</span><span> </span><a href="#local-6989586621679090537"><span class="hs-identifier hs-var">uc</span></a><span> </span><a href="#local-6989586621679090538"><span class="hs-identifier hs-var">u'</span></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-identifier">parseSCRAM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-identifier hs-type">B</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-321"></a><a name="parseSCRAM"><a href="Database.MongoDB.Query.html#parseSCRAM"><span class="hs-identifier">parseSCRAM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679090539"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">breakOn</span><span> </span><span class="hs-string">&quot;=&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">splitOn</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span>
</span><a name="line-322"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679090539"><a href="#local-6989586621679090539"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090540"><a href="#local-6989586621679090540"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090541"><a href="#local-6989586621679090541"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679090540"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679090541"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">retrieveServerData</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090294"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090294"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span>
</span><a name="line-325"></a><a name="retrieveServerData"><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier">retrieveServerData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-326"></a><span>  </span><a name="local-6989586621679090542"><a href="#local-6989586621679090542"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand1"><span class="hs-identifier hs-var">runCommand1</span></a><span> </span><span class="hs-string">&quot;isMaster&quot;</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090543"><a href="#local-6989586621679090543"><span class="hs-identifier">newSd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-var">ServerData</span></a><span>
</span><a name="line-328"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">isMaster</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;ismaster&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">minWireVersion</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;minWireVersion&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxWireVersion</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;maxWireVersion&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxMessageSizeBytes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">48000000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;maxMessageSizeBytes&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxBsonObjectSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-number">16</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">1024</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">1024</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;maxBsonObjectSize&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxWriteBatchSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">1000</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;maxWriteBatchSize&quot;</span><span> </span><a href="#local-6989586621679090542"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090543"><span class="hs-identifier hs-var">newSd</span></a><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-comment">-- * Collection</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-keyword">type</span><span> </span><a name="Collection"><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier">Collection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- ^ Collection name (not prefixed with database)</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-identifier">allCollections</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090293"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090293"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">]</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- ^ List all collections in this database</span><span>
</span><a name="line-344"></a><a name="allCollections"><a href="Database.MongoDB.Query.html#allCollections"><span class="hs-identifier">allCollections</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>    </span><a name="local-6989586621679090548"><a href="#local-6989586621679090548"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-346"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090549"><a href="#local-6989586621679090549"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090548"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-347"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxWireVersion</span><span> </span><a href="#local-6989586621679090549"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-349"></a><span>        </span><a name="local-6989586621679090550"><a href="#local-6989586621679090550"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-350"></a><span>        </span><a name="local-6989586621679090551"><a href="#local-6989586621679090551"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;system.namespaces&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">sort</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;name&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679090545"><span class="hs-identifier hs-var">isSpecial</span></a><span> </span><a href="#local-6989586621679090550"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679090544"><span class="hs-identifier hs-var">dropDbPrefix</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;name&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090551"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-352"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>        </span><a name="local-6989586621679090552"><a href="#local-6989586621679090552"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand1"><span class="hs-identifier hs-var">runCommand1</span></a><span> </span><span class="hs-string">&quot;listCollections&quot;</span><span>
</span><a name="line-354"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090553"><a href="#local-6989586621679090553"><span class="hs-identifier">curData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-355"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Doc</span><span> </span><a name="local-6989586621679090554"><a href="#local-6989586621679090554"><span class="hs-identifier">curDoc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090552"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;cursor&quot;</span><span>
</span><a name="line-356"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621679090555"><a href="#local-6989586621679090555"><span class="hs-identifier">curId</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090554"><span class="hs-identifier hs-var">curDoc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;id&quot;</span><span>
</span><a name="line-357"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621679090556"><a href="#local-6989586621679090556"><span class="hs-identifier">curNs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090554"><span class="hs-identifier hs-var">curDoc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;ns&quot;</span><span>
</span><a name="line-358"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621679090557"><a href="#local-6989586621679090557"><span class="hs-identifier">firstBatch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090554"><span class="hs-identifier hs-var">curDoc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;firstBatch&quot;</span><span>
</span><a name="line-359"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090555"><span class="hs-identifier hs-var">curId</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090556"><span class="hs-identifier hs-var">curNs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">cast'</span><span> </span><a href="#local-6989586621679090557"><span class="hs-identifier hs-var">firstBatch</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090553"><span class="hs-identifier hs-var">curData</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-361"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-362"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679090558"><a href="#local-6989586621679090558"><span class="hs-identifier">curId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090559"><a href="#local-6989586621679090559"><span class="hs-identifier">curNs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090560"><a href="#local-6989586621679090560"><span class="hs-identifier">firstBatch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-363"></a><span>            </span><a name="local-6989586621679090561"><a href="#local-6989586621679090561"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-364"></a><span>            </span><a name="local-6989586621679090562"><a href="#local-6989586621679090562"><span class="hs-identifier">nc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#newCursor"><span class="hs-identifier hs-var">newCursor</span></a><span> </span><a href="#local-6989586621679090561"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="#local-6989586621679090559"><span class="hs-identifier hs-var">curNs</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679090558"><span class="hs-identifier hs-var">curId</span></a><span> </span><a href="#local-6989586621679090560"><span class="hs-identifier hs-var">firstBatch</span></a><span>
</span><a name="line-365"></a><span>            </span><a name="local-6989586621679090563"><a href="#local-6989586621679090563"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-6989586621679090562"><span class="hs-identifier hs-var">nc</span></a><span>
</span><a name="line-366"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679090564"><a href="#local-6989586621679090564"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090564"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;name&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090563"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-367"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-368"></a><span>    </span><a name="local-6989586621679090544"><a href="#local-6989586621679090544"><span class="hs-identifier">dropDbPrefix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'.'</span><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621679090545"><a href="#local-6989586621679090545"><span class="hs-identifier">isSpecial</span></a></a><span> </span><a name="local-6989586621679090546"><a href="#local-6989586621679090546"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679090547"><a href="#local-6989586621679090547"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'$'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090547"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679090546"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679090547"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;local.oplog.$main&quot;</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-comment">-- * Selection</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">data</span><span> </span><a name="Selection"><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier">Selection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Select"><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier">Select</span></a></a><span> </span><span class="hs-special">{</span><a name="selector"><a href="Database.MongoDB.Query.html#selector"><span class="hs-identifier">selector</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><a name="coll"><a href="Database.MongoDB.Query.html#coll"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">}</span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- ^ Selects documents in collection that match selector</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-keyword">type</span><span> </span><a name="Selector"><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier">Selector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- ^ Filter for a query, analogous to the where clause in SQL. @[]@ matches all documents in collection. @[\&quot;x\&quot; =: a, \&quot;y\&quot; =: b]@ is analogous to @where x = a and y = b@ in SQL. See &lt;http://www.mongodb.org/display/DOCS/Querying&gt; for full selector syntax.</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-identifier">whereJS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span>
</span><a name="line-380"></a><span class="hs-comment">-- ^ Add Javascript predicate to selector, in which case a document must match both selector and predicate</span><span>
</span><a name="line-381"></a><a name="whereJS"><a href="Database.MongoDB.Query.html#whereJS"><span class="hs-identifier">whereJS</span></a></a><span> </span><a name="local-6989586621679090565"><a href="#local-6989586621679090565"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090566"><a href="#local-6989586621679090566"><span class="hs-identifier">js</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$where&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090566"><span class="hs-identifier hs-var">js</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090565"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-keyword">class</span><span> </span><a name="Select"><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier">Select</span></a></a><span> </span><a name="local-6989586621679090232"><a href="#local-6989586621679090232"><span class="hs-identifier">aQueryOrSelection</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-384"></a><span>    </span><span class="hs-identifier">select</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090232"><span class="hs-identifier hs-type">aQueryOrSelection</span></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-comment">-- ^ 'Query' or 'Selection' that selects documents in collection that match selector. The choice of type depends on use, for example, in @'find' (select sel col)@ it is a Query, and in @'delete' (select sel col)@ it is a Selection.</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-388"></a><span>    </span><a name="local-8214565720323864999"><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-391"></a><span>    </span><a name="local-8214565720323864999"><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-comment">-- * Write</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-keyword">data</span><span> </span><a name="WriteMode"><a href="Database.MongoDB.Query.html#WriteMode"><span class="hs-identifier">WriteMode</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-396"></a><span>      </span><a name="NoConfirm"><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier">NoConfirm</span></a></a><span>  </span><span class="hs-comment">-- ^ Submit writes without receiving acknowledgments. Fast. Assumes writes succeed even though they may not.</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Confirm"><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier">Confirm</span></a></a><span> </span><a href="Database.MongoDB.Query.html#GetLastError"><span class="hs-identifier hs-type">GetLastError</span></a><span>  </span><span class="hs-comment">-- ^ Receive an acknowledgment after every write, and raise exception if one says the write failed. This is acomplished by sending the getLastError command, with given 'GetLastError' parameters, after every write.</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-identifier">write</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- ^ Send write to server, and if write-mode is 'Safe' then include getLastError request and raise 'WriteFailure' if it reports an error.</span><span>
</span><a name="line-402"></a><a name="write"><a href="Database.MongoDB.Query.html#write"><span class="hs-identifier">write</span></a></a><span> </span><a name="local-6989586621679090567"><a href="#local-6989586621679090567"><span class="hs-identifier">notice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679090568"><a href="#local-6989586621679090568"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090568"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-403"></a><span>    </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-404"></a><span>      </span><a name="local-6989586621679090569"><a href="#local-6989586621679090569"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-405"></a><span>      </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-6989586621679090569"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090567"><span class="hs-identifier hs-var">notice</span></a><span class="hs-special">]</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-407"></a><span>    </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090570"><a href="#local-6989586621679090570"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-408"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090571"><a href="#local-6989586621679090571"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-string">&quot;getlasterror&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090570"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;$cmd&quot;</span><span>
</span><a name="line-409"></a><span>        </span><a name="local-6989586621679090572"><a href="#local-6989586621679090572"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-410"></a><span>        </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679090575"><a href="#local-6989586621679090575"><span class="hs-identifier">doc</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>          </span><a name="local-6989586621679090573"><a href="#local-6989586621679090573"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#queryRequest"><span class="hs-identifier hs-var">queryRequest</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679090571"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">limit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span class="hs-special">}</span><span>
</span><a name="line-412"></a><span>          </span><a name="local-6989586621679090574"><a href="#local-6989586621679090574"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679090572"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090567"><span class="hs-identifier hs-var">notice</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090573"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-413"></a><span>          </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><a href="#local-6989586621679090574"><span class="hs-identifier hs-var">rr</span></a><span>
</span><a name="line-414"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679090575"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">-- ** Insert</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">insert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090292"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090292"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-419"></a><span class="hs-comment">-- ^ Insert document into collection and return its \&quot;_id\&quot; value, which is created automatically if not supplied</span><span>
</span><a name="line-420"></a><a name="insert"><a href="Database.MongoDB.Query.html#insert"><span class="hs-identifier">insert</span></a></a><span> </span><a name="local-6989586621679090576"><a href="#local-6989586621679090576"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090577"><a href="#local-6989586621679090577"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-421"></a><span>  </span><a name="local-6989586621679090578"><a href="#local-6989586621679090578"><span class="hs-identifier">doc'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#assignId"><span class="hs-identifier hs-var">assignId</span></a><span> </span><a href="#local-6989586621679090577"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-422"></a><span>  </span><a name="local-6989586621679090579"><a href="#local-6989586621679090579"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#insertBlock"><span class="hs-identifier hs-var">insertBlock</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090576"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090578"><span class="hs-identifier hs-var">doc'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090579"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679090580"><a href="#local-6989586621679090580"><span class="hs-identifier">failure</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><a href="#local-6989586621679090580"><span class="hs-identifier hs-var">failure</span></a><span>
</span><a name="line-425"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679090581"><a href="#local-6989586621679090581"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090581"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">insert_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090291"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090291"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- ^ Same as 'insert' except don't return _id</span><span>
</span><a name="line-429"></a><a name="insert_"><a href="Database.MongoDB.Query.html#insert_"><span class="hs-identifier">insert_</span></a></a><span> </span><a name="local-6989586621679090582"><a href="#local-6989586621679090582"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090583"><a href="#local-6989586621679090583"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insert"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621679090582"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090583"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">insertMany</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090290"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090290"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- ^ Insert documents into collection and return their \&quot;_id\&quot; values,</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- which are created automatically if not supplied.</span><span>
</span><a name="line-434"></a><span class="hs-comment">-- If a document fails to be inserted (eg. due to duplicate key)</span><span>
</span><a name="line-435"></a><span class="hs-comment">-- then remaining docs are aborted, and LastError is set.</span><span>
</span><a name="line-436"></a><span class="hs-comment">-- An exception will be throw if any error occurs.</span><span>
</span><a name="line-437"></a><a name="insertMany"><a href="Database.MongoDB.Query.html#insertMany"><span class="hs-identifier">insertMany</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insert%27"><span class="hs-identifier hs-var">insert'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">insertMany_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090289"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090289"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- ^ Same as 'insertMany' except don't return _ids</span><span>
</span><a name="line-441"></a><a name="insertMany_"><a href="Database.MongoDB.Query.html#insertMany_"><span class="hs-identifier">insertMany_</span></a></a><span> </span><a name="local-6989586621679090584"><a href="#local-6989586621679090584"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090585"><a href="#local-6989586621679090585"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insertMany"><span class="hs-identifier hs-var">insertMany</span></a><span> </span><a href="#local-6989586621679090584"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090585"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-identifier">insertAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090288"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090288"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- ^ Insert documents into collection and return their \&quot;_id\&quot; values,</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- which are created automatically if not supplied. If a document fails</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- to be inserted (eg. due to duplicate key) then remaining docs</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- are still inserted.</span><span>
</span><a name="line-448"></a><a name="insertAll"><a href="Database.MongoDB.Query.html#insertAll"><span class="hs-identifier">insertAll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insert%27"><span class="hs-identifier hs-var">insert'</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#KeepGoing"><span class="hs-identifier hs-var">KeepGoing</span></a><span class="hs-special">]</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">insertAll_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090287"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090287"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- ^ Same as 'insertAll' except don't return _ids</span><span>
</span><a name="line-452"></a><a name="insertAll_"><a href="Database.MongoDB.Query.html#insertAll_"><span class="hs-identifier">insertAll_</span></a></a><span> </span><a name="local-6989586621679090586"><a href="#local-6989586621679090586"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090587"><a href="#local-6989586621679090587"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insertAll"><span class="hs-identifier hs-var">insertAll</span></a><span> </span><a href="#local-6989586621679090586"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090587"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-identifier">insertCommandDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-455"></a><a name="insertCommandDocument"><a href="Database.MongoDB.Query.html#insertCommandDocument"><span class="hs-identifier">insertCommandDocument</span></a></a><span> </span><a name="local-6989586621679090588"><a href="#local-6989586621679090588"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679090589"><a href="#local-6989586621679090589"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090590"><a href="#local-6989586621679090590"><span class="hs-identifier">docs</span></a></a><span> </span><a name="local-6989586621679090591"><a href="#local-6989586621679090591"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-456"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;insert&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090589"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-457"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ordered&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#KeepGoing"><span class="hs-identifier hs-var">KeepGoing</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090588"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;documents&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090590"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-459"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;writeConcern&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090591"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-460"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-identifier">takeRightsUpToLeft</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679090285"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679090286"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090286"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-463"></a><a name="takeRightsUpToLeft"><a href="Database.MongoDB.Query.html#takeRightsUpToLeft"><span class="hs-identifier">takeRightsUpToLeft</span></a></a><span> </span><a name="local-6989586621679090592"><a href="#local-6989586621679090592"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">rights</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">isRight</span><span> </span><a href="#local-6989586621679090592"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">insert'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090284"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-466"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090284"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- ^ Insert documents into collection and return their \&quot;_id\&quot; values, which are created automatically if not supplied</span><span>
</span><a name="line-468"></a><a name="insert%27"><a href="Database.MongoDB.Query.html#insert%27"><span class="hs-identifier">insert'</span></a></a><span> </span><a name="local-6989586621679090593"><a href="#local-6989586621679090593"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679090594"><a href="#local-6989586621679090594"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090595"><a href="#local-6989586621679090595"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-469"></a><span>  </span><a name="local-6989586621679090596"><a href="#local-6989586621679090596"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090597"><a href="#local-6989586621679090597"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090596"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-471"></a><span>  </span><a name="local-6989586621679090598"><a href="#local-6989586621679090598"><span class="hs-identifier">docs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Database.MongoDB.Query.html#assignId"><span class="hs-identifier hs-var">assignId</span></a><span> </span><a href="#local-6989586621679090595"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-472"></a><span>  </span><a name="local-6989586621679090599"><a href="#local-6989586621679090599"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-473"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090600"><a href="#local-6989586621679090600"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090599"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-474"></a><span>                        </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-475"></a><span>                        </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090601"><a href="#local-6989586621679090601"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090601"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-476"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090602"><a href="#local-6989586621679090602"><span class="hs-identifier">docSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#insertCommandDocument"><span class="hs-identifier hs-var">insertCommandDocument</span></a><span> </span><a href="#local-6989586621679090593"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090594"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090600"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-477"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090603"><a href="#local-6989586621679090603"><span class="hs-identifier">ordered</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#KeepGoing"><span class="hs-identifier hs-var">KeepGoing</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090593"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090604"><a href="#local-6989586621679090604"><span class="hs-identifier">preChunks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#splitAtLimit"><span class="hs-identifier hs-var">splitAtLimit</span></a><span>
</span><a name="line-479"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">maxBsonObjectSize</span><span> </span><a href="#local-6989586621679090597"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679090602"><span class="hs-identifier hs-var">docSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>                                           </span><span class="hs-comment">-- size of auxiliary part of insert</span><span>
</span><a name="line-481"></a><span>                                           </span><span class="hs-comment">-- document should be subtracted from</span><span>
</span><a name="line-482"></a><span>                                           </span><span class="hs-comment">-- the overall size</span><span>
</span><a name="line-483"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">maxWriteBatchSize</span><span> </span><a href="#local-6989586621679090597"><span class="hs-identifier hs-var">sd</span></a><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>                      </span><a href="#local-6989586621679090598"><span class="hs-identifier hs-var">docs'</span></a><span>
</span><a name="line-485"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090605"><a href="#local-6989586621679090605"><span class="hs-identifier">chunks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-486"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090603"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-487"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="Database.MongoDB.Query.html#takeRightsUpToLeft"><span class="hs-identifier hs-var">takeRightsUpToLeft</span></a><span> </span><a href="#local-6989586621679090604"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-488"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621679090604"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090606"><a href="#local-6989586621679090606"><span class="hs-identifier">lens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679090605"><span class="hs-identifier hs-var">chunks</span></a><span>
</span><a name="line-491"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090607"><a href="#local-6989586621679090607"><span class="hs-identifier">lSums</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090607"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090606"><span class="hs-identifier hs-var">lens</span></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>  </span><a name="local-6989586621679090608"><a href="#local-6989586621679090608"><span class="hs-identifier">chunkResults</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#interruptibleFor"><span class="hs-identifier hs-var">interruptibleFor</span></a><span> </span><a href="#local-6989586621679090603"><span class="hs-identifier hs-var">ordered</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679090607"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090605"><span class="hs-identifier hs-var">chunks</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#insertBlock"><span class="hs-identifier hs-var">insertBlock</span></a><span> </span><a href="#local-6989586621679090593"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090594"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090609"><a href="#local-6989586621679090609"><span class="hs-identifier">lchunks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lefts</span><span> </span><a href="#local-6989586621679090604"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090609"><span class="hs-identifier hs-var">lchunks</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090609"><span class="hs-identifier hs-var">lchunks</span></a><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090610"><a href="#local-6989586621679090610"><span class="hs-identifier">lresults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lefts</span><span> </span><a href="#local-6989586621679090608"><span class="hs-identifier hs-var">chunkResults</span></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090610"><span class="hs-identifier hs-var">lresults</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090610"><span class="hs-identifier hs-var">lresults</span></a><span>
</span><a name="line-501"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621679090608"><span class="hs-identifier hs-var">chunkResults</span></a><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-identifier">insertBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090283"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090283"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- ^ This will fail if the list of documents is bigger than restrictions</span><span>
</span><a name="line-506"></a><a name="insertBlock"><a href="Database.MongoDB.Query.html#insertBlock"><span class="hs-identifier">insertBlock</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-507"></a><span class="hs-identifier">insertBlock</span><span> </span><a name="local-6989586621679090611"><a href="#local-6989586621679090611"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679090612"><a href="#local-6989586621679090612"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090613"><a href="#local-6989586621679090613"><span class="hs-identifier">prevCount</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090614"><a href="#local-6989586621679090614"><span class="hs-identifier">docs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-508"></a><span>    </span><a name="local-6989586621679090615"><a href="#local-6989586621679090615"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span>    </span><a name="local-6989586621679090616"><a href="#local-6989586621679090616"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090617"><a href="#local-6989586621679090617"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090616"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-512"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxWireVersion</span><span> </span><a href="#local-6989586621679090617"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-514"></a><span>        </span><a name="local-6989586621679090618"><a href="#local-6989586621679090618"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#write"><span class="hs-identifier hs-var">write</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Insert"><span class="hs-identifier hs-var">Insert</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090615"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679090612"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090611"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090614"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090619"><a href="#local-6989586621679090619"><span class="hs-identifier">errorMessage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-516"></a><span>              </span><a name="local-6989586621679090620"><a href="#local-6989586621679090620"><span class="hs-identifier">jRes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090618"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-517"></a><span>              </span><a name="local-6989586621679090621"><a href="#local-6989586621679090621"><span class="hs-identifier">em</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;err&quot;</span><span> </span><a href="#local-6989586621679090620"><span class="hs-identifier hs-var">jRes</span></a><span>
</span><a name="line-518"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;code&quot;</span><span> </span><a href="#local-6989586621679090620"><span class="hs-identifier hs-var">jRes</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621679090621"><span class="hs-identifier hs-var">em</span></a><span>
</span><a name="line-519"></a><span>              </span><span class="hs-comment">-- In older versions of ^^ the protocol we can't really say which document failed.</span><span>
</span><a name="line-520"></a><span>              </span><span class="hs-comment">-- So we just report the accumulated number of documents in the previous blocks.</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090619"><span class="hs-identifier hs-var">errorMessage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-523"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090622"><a href="#local-6989586621679090622"><span class="hs-identifier">failure</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679090622"><span class="hs-identifier hs-var">failure</span></a><span>
</span><a name="line-524"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">valueAt</span><span> </span><span class="hs-string">&quot;_id&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090614"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-525"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-526"></a><span>        </span><a name="local-6989586621679090623"><a href="#local-6989586621679090623"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-527"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090624"><a href="#local-6989586621679090624"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090623"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-528"></a><span>                              </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-529"></a><span>                              </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090625"><a href="#local-6989586621679090625"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090625"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-530"></a><span>        </span><a name="local-6989586621679090626"><a href="#local-6989586621679090626"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#insertCommandDocument"><span class="hs-identifier hs-var">insertCommandDocument</span></a><span> </span><a href="#local-6989586621679090611"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090612"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090614"><span class="hs-identifier hs-var">docs</span></a><span> </span><a href="#local-6989586621679090624"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-531"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeErrors&quot;</span><span> </span><a href="#local-6989586621679090626"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeConcernError&quot;</span><span> </span><a href="#local-6989586621679090626"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-532"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">valueAt</span><span> </span><span class="hs-string">&quot;_id&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090614"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-533"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Array</span><span> </span><a name="local-6989586621679090627"><a href="#local-6989586621679090627"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-534"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090628"><a href="#local-6989586621679090628"><span class="hs-identifier">writeErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#anyToWriteError"><span class="hs-identifier hs-var">anyToWriteError</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090627"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-535"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090629"><a href="#local-6989586621679090629"><span class="hs-identifier">errorsWithFailureIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#addFailureIndex"><span class="hs-identifier hs-var">addFailureIndex</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090628"><span class="hs-identifier hs-var">writeErrors</span></a><span>
</span><a name="line-536"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#CompoundFailure"><span class="hs-identifier hs-var">CompoundFailure</span></a><span> </span><a href="#local-6989586621679090629"><span class="hs-identifier hs-var">errorsWithFailureIndex</span></a><span>
</span><a name="line-537"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090630"><a href="#local-6989586621679090630"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-538"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span>
</span><a name="line-539"></a><span>                                    </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-540"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090626"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090630"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Array</span><span> </span><a name="local-6989586621679090631"><a href="#local-6989586621679090631"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090632"><a href="#local-6989586621679090632"><span class="hs-identifier">writeConcernErr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-543"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090633"><a href="#local-6989586621679090633"><span class="hs-identifier">writeErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#anyToWriteError"><span class="hs-identifier hs-var">anyToWriteError</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090631"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-544"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090634"><a href="#local-6989586621679090634"><span class="hs-identifier">errorsWithFailureIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#addFailureIndex"><span class="hs-identifier hs-var">addFailureIndex</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090633"><span class="hs-identifier hs-var">writeErrors</span></a><span>
</span><a name="line-545"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#CompoundFailure"><span class="hs-identifier hs-var">CompoundFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span>
</span><a name="line-546"></a><span>                                    </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-547"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090626"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090632"><span class="hs-identifier hs-var">writeConcernErr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090634"><span class="hs-identifier hs-var">errorsWithFailureIndex</span></a><span>
</span><a name="line-549"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090635"><a href="#local-6989586621679090635"><span class="hs-identifier">unknownValue</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-550"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected array of errors. Received: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090635"><span class="hs-identifier hs-var">unknownValue</span></a><span>
</span><a name="line-551"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090636"><a href="#local-6989586621679090636"><span class="hs-identifier">unknownValue</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090637"><a href="#local-6989586621679090637"><span class="hs-identifier">writeConcernErr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-552"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#CompoundFailure"><span class="hs-identifier hs-var">CompoundFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected array of errors. Received: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090636"><span class="hs-identifier hs-var">unknownValue</span></a><span>
</span><a name="line-553"></a><span>                                              </span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><a href="#local-6989586621679090613"><span class="hs-identifier hs-var">prevCount</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090626"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090637"><span class="hs-identifier hs-var">writeConcernErr</span></a><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-identifier">splitAtLimit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-556"></a><a name="splitAtLimit"><a href="Database.MongoDB.Query.html#splitAtLimit"><span class="hs-identifier">splitAtLimit</span></a></a><span> </span><a name="local-6989586621679090638"><a href="#local-6989586621679090638"><span class="hs-identifier">maxSize</span></a></a><span> </span><a name="local-6989586621679090639"><a href="#local-6989586621679090639"><span class="hs-identifier">maxCount</span></a></a><span> </span><a name="local-6989586621679090640"><a href="#local-6989586621679090640"><span class="hs-identifier">list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090642"><span class="hs-identifier hs-var">chop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090641"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090640"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-558"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621679090641"><a href="#local-6989586621679090641"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090645"><a href="#local-6989586621679090645"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679090645"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679090646"><a href="#local-6989586621679090646"><span class="hs-identifier">curSize</span></a></a><span> </span><a name="local-6989586621679090647"><a href="#local-6989586621679090647"><span class="hs-identifier">curCount</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679090648"><a href="#local-6989586621679090648"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679090649"><a href="#local-6989586621679090649"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679090646"><span class="hs-identifier hs-var">curSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><a href="#local-6989586621679090648"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679090647"><span class="hs-identifier hs-var">curCount</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679090638"><span class="hs-identifier hs-var">maxSize</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-562"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-string">&quot;One document is too big for the message&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090649"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679090650"><a href="#local-6989586621679090650"><span class="hs-identifier">curSize</span></a></a><span> </span><a name="local-6989586621679090651"><a href="#local-6989586621679090651"><span class="hs-identifier">curCount</span></a></a><span> </span><a name="local-6989586621679090652"><a href="#local-6989586621679090652"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090653"><a href="#local-6989586621679090653"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679090654"><a href="#local-6989586621679090654"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-564"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679090650"><span class="hs-identifier hs-var">curSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><a href="#local-6989586621679090653"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679090651"><span class="hs-identifier hs-var">curCount</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679090638"><span class="hs-identifier hs-var">maxSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>                                 </span><span class="hs-comment">-- we have ^ 2 brackets and curCount commas in</span><span>
</span><a name="line-566"></a><span>                                 </span><span class="hs-comment">-- the document that we need to take into</span><span>
</span><a name="line-567"></a><span>                                 </span><span class="hs-comment">-- account</span><span>
</span><a name="line-568"></a><span>          </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679090651"><span class="hs-identifier hs-var">curCount</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679090639"><span class="hs-identifier hs-var">maxCount</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>        </span><span class="hs-keyword">then</span><span>
</span><a name="line-570"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679090652"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090653"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679090654"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-572"></a><span>          </span><a href="#local-6989586621679090641"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090650"><span class="hs-identifier hs-var">curSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><a href="#local-6989586621679090653"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090651"><span class="hs-identifier hs-var">curCount</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090653"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679090652"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090654"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>    </span><span class="hs-identifier">chop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679090643"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090644"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090643"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090643"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090644"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-575"></a><span>    </span><a name="local-6989586621679090642"><a href="#local-6989586621679090642"><span class="hs-identifier">chop</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-576"></a><span>    </span><span class="hs-identifier">chop</span><span> </span><a name="local-6989586621679090655"><a href="#local-6989586621679090655"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679090657"><a href="#local-6989586621679090657"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090658"><a href="#local-6989586621679090658"><span class="hs-identifier">as'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090655"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679090657"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090642"><span class="hs-identifier hs-var">chop</span></a><span> </span><a href="#local-6989586621679090655"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679090658"><span class="hs-identifier hs-var">as'</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-identifier">sizeOfDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-579"></a><a name="sizeOfDocument"><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier">sizeOfDocument</span></a></a><span> </span><a name="local-6989586621679090659"><a href="#local-6989586621679090659"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">LBS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679090659"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-identifier">assignId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-582"></a><span class="hs-comment">-- ^ Assign a unique value to _id field if missing</span><span>
</span><a name="line-583"></a><a name="assignId"><a href="Database.MongoDB.Query.html#assignId"><span class="hs-identifier">assignId</span></a></a><span> </span><a name="local-6989586621679090660"><a href="#local-6989586621679090660"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-string">&quot;_id&quot;</span><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">label</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090660"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-584"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090660"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-585"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679090661"><a href="#local-6989586621679090661"><span class="hs-identifier">oid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;_id&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090661"><span class="hs-identifier hs-var">oid</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090660"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">genObjectId</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-comment">-- ** Update</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-identifier">save</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090282"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090282"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- ^ Save document to collection, meaning insert it if its new (has no \&quot;_id\&quot; field) or upsert it if its not new (has \&quot;_id\&quot; field)</span><span>
</span><a name="line-592"></a><a name="save"><a href="Database.MongoDB.Query.html#save"><span class="hs-identifier">save</span></a></a><span> </span><a name="local-6989586621679090662"><a href="#local-6989586621679090662"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090663"><a href="#local-6989586621679090663"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;_id&quot;</span><span> </span><a href="#local-6989586621679090663"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-593"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#insert_"><span class="hs-identifier hs-var">insert_</span></a><span> </span><a href="#local-6989586621679090662"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090663"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-594"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090664"><a href="#local-6989586621679090664"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#upsert"><span class="hs-identifier hs-var">upsert</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;_id&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><a href="#local-6989586621679090664"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090662"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090663"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-identifier">replace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090281"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090281"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- ^ Replace first document in selection with given document</span><span>
</span><a name="line-599"></a><a name="replace"><a href="Database.MongoDB.Query.html#replace"><span class="hs-identifier">replace</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span class="hs-identifier">repsert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090280"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090280"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span class="hs-comment">-- ^ Replace first document in selection with given document, or insert document if selection is empty</span><span>
</span><a name="line-604"></a><a name="repsert"><a href="Database.MongoDB.Query.html#repsert"><span class="hs-identifier">repsert</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Upsert"><span class="hs-identifier hs-var">Upsert</span></a><span class="hs-special">]</span><span>
</span><a name="line-605"></a><span class="hs-pragma">{-# DEPRECATED repsert &quot;use upsert instead&quot; #-}</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-identifier">upsert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090279"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090279"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- ^ Update first document in selection with given document, or insert document if selection is empty</span><span>
</span><a name="line-610"></a><a name="upsert"><a href="Database.MongoDB.Query.html#upsert"><span class="hs-identifier">upsert</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Upsert"><span class="hs-identifier hs-var">Upsert</span></a><span class="hs-special">]</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-keyword">type</span><span> </span><a name="Modifier"><a href="Database.MongoDB.Query.html#Modifier"><span class="hs-identifier">Modifier</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-613"></a><span class="hs-comment">-- ^ Update operations on fields in a document. See &lt;http://www.mongodb.org/display/DOCS/Updating#Updating-ModifierOperations&gt;</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">modify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090278"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Modifier"><span class="hs-identifier hs-type">Modifier</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090278"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- ^ Update all documents in selection using given modifier</span><span>
</span><a name="line-618"></a><a name="modify"><a href="Database.MongoDB.Query.html#modify"><span class="hs-identifier">modify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update"><span class="hs-identifier hs-var">update</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#MultiUpdate"><span class="hs-identifier hs-var">MultiUpdate</span></a><span class="hs-special">]</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span class="hs-identifier">update</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090277"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090277"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- ^ Update first document in selection using updater document, unless 'MultiUpdate' option is supplied then update all documents in selection. If 'Upsert' option is supplied then treat updater as document and insert it if selection is empty.</span><span>
</span><a name="line-623"></a><a name="update"><a href="Database.MongoDB.Query.html#update"><span class="hs-identifier">update</span></a></a><span> </span><a name="local-6989586621679090665"><a href="#local-6989586621679090665"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a name="local-6989586621679090666"><a href="#local-6989586621679090666"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090667"><a href="#local-6989586621679090667"><span class="hs-identifier">col</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679090668"><a href="#local-6989586621679090668"><span class="hs-identifier">up</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-624"></a><span>    </span><a name="local-6989586621679090669"><a href="#local-6989586621679090669"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-625"></a><span>    </span><a name="local-6989586621679090670"><a href="#local-6989586621679090670"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-626"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#write"><span class="hs-identifier hs-var">write</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Update"><span class="hs-identifier hs-var">Update</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090669"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679090667"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090665"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090666"><span class="hs-identifier hs-var">sel</span></a><span> </span><a href="#local-6989586621679090668"><span class="hs-identifier hs-var">up</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090670"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-identifier">updateCommandDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-629"></a><a name="updateCommandDocument"><a href="Database.MongoDB.Query.html#updateCommandDocument"><span class="hs-identifier">updateCommandDocument</span></a></a><span> </span><a name="local-6989586621679090671"><a href="#local-6989586621679090671"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090672"><a href="#local-6989586621679090672"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090673"><a href="#local-6989586621679090673"><span class="hs-identifier">updates</span></a></a><span> </span><a name="local-6989586621679090674"><a href="#local-6989586621679090674"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-630"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;update&quot;</span><span>  </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090671"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-631"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ordered&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090672"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-632"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;updates&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090673"><span class="hs-identifier hs-var">updates</span></a><span>
</span><a name="line-633"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;writeConcern&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090674"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-634"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-comment">{-| Bulk update operation. If one update fails it will not update the remaining
 - documents. Current returned value is only a place holder. With mongodb server
 - before 2.6 it will send update requests one by one. In order to receive
 - error messages in versions under 2.6 you need to user confirmed writes.
 - Otherwise even if the errors had place the list of errors will be empty and
 - the result will be success.  After 2.6 it will use bulk update feature in
 - mongodb.
 -}</span><span>
</span><a name="line-644"></a><span class="hs-identifier">updateMany</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090276"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-646"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-647"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090276"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-648"></a><a name="updateMany"><a href="Database.MongoDB.Query.html#updateMany"><span class="hs-identifier">updateMany</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update%27"><span class="hs-identifier hs-var">update'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">{-| Bulk update operation. If one update fails it will proceed with the
 - remaining documents. With mongodb server before 2.6 it will send update
 - requests one by one. In order to receive error messages in versions under
 - 2.6 you need to use confirmed writes.  Otherwise even if the errors had
 - place the list of errors will be empty and the result will be success.
 - After 2.6 it will use bulk update feature in mongodb.
 -}</span><span>
</span><a name="line-657"></a><span class="hs-identifier">updateAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090275"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-659"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-660"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090275"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-661"></a><a name="updateAll"><a href="Database.MongoDB.Query.html#updateAll"><span class="hs-identifier">updateAll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#update%27"><span class="hs-identifier hs-var">update'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span class="hs-identifier">update'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090274"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-665"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-666"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-667"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090274"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-668"></a><a name="update%27"><a href="Database.MongoDB.Query.html#update%27"><span class="hs-identifier">update'</span></a></a><span> </span><a name="local-6989586621679090675"><a href="#local-6989586621679090675"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090676"><a href="#local-6989586621679090676"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090677"><a href="#local-6989586621679090677"><span class="hs-identifier">updateDocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-669"></a><span>  </span><a name="local-6989586621679090678"><a href="#local-6989586621679090678"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-670"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090679"><a href="#local-6989586621679090679"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090678"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-671"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090680"><a href="#local-6989586621679090680"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679090681"><a href="#local-6989586621679090681"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090682"><a href="#local-6989586621679090682"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090683"><a href="#local-6989586621679090683"><span class="hs-identifier">os</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;q&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090681"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-672"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;u&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090682"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-673"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;upsert&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Upsert"><span class="hs-identifier hs-var">Upsert</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090683"><span class="hs-identifier hs-var">os</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;multi&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#MultiUpdate"><span class="hs-identifier hs-var">MultiUpdate</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090683"><span class="hs-identifier hs-var">os</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>                </span><a href="#local-6989586621679090677"><span class="hs-identifier hs-var">updateDocs</span></a><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span>  </span><a name="local-6989586621679090684"><a href="#local-6989586621679090684"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-678"></a><span>  </span><a name="local-6989586621679090685"><a href="#local-6989586621679090685"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-679"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-680"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090686"><a href="#local-6989586621679090686"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090684"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-681"></a><span>                          </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-682"></a><span>                          </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090687"><a href="#local-6989586621679090687"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090687"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-683"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090688"><a href="#local-6989586621679090688"><span class="hs-identifier">docSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#updateCommandDocument"><span class="hs-identifier hs-var">updateCommandDocument</span></a><span>
</span><a name="line-684"></a><span>                                                      </span><a href="#local-6989586621679090676"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-685"></a><span>                                                      </span><a href="#local-6989586621679090675"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-686"></a><span>                                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-687"></a><span>                                                      </span><a href="#local-6989586621679090686"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-688"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090689"><a href="#local-6989586621679090689"><span class="hs-identifier">preChunks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#splitAtLimit"><span class="hs-identifier hs-var">splitAtLimit</span></a><span>
</span><a name="line-689"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">maxBsonObjectSize</span><span> </span><a href="#local-6989586621679090679"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679090688"><span class="hs-identifier hs-var">docSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-690"></a><span>                                             </span><span class="hs-comment">-- size of auxiliary part of update</span><span>
</span><a name="line-691"></a><span>                                             </span><span class="hs-comment">-- document should be subtracted from</span><span>
</span><a name="line-692"></a><span>                                             </span><span class="hs-comment">-- the overall size</span><span>
</span><a name="line-693"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">maxWriteBatchSize</span><span> </span><a href="#local-6989586621679090679"><span class="hs-identifier hs-var">sd</span></a><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>                        </span><a href="#local-6989586621679090680"><span class="hs-identifier hs-var">updates</span></a><span>
</span><a name="line-695"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090690"><a href="#local-6989586621679090690"><span class="hs-identifier">chunks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-696"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090675"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-697"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="Database.MongoDB.Query.html#takeRightsUpToLeft"><span class="hs-identifier hs-var">takeRightsUpToLeft</span></a><span> </span><a href="#local-6989586621679090689"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-698"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621679090689"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-699"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090691"><a href="#local-6989586621679090691"><span class="hs-identifier">lens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679090690"><span class="hs-identifier hs-var">chunks</span></a><span>
</span><a name="line-700"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090692"><a href="#local-6989586621679090692"><span class="hs-identifier">lSums</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090692"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090691"><span class="hs-identifier hs-var">lens</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>    </span><a name="local-6989586621679090696"><a href="#local-6989586621679090696"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#interruptibleFor"><span class="hs-identifier hs-var">interruptibleFor</span></a><span> </span><a href="#local-6989586621679090675"><span class="hs-identifier hs-var">ordered</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679090692"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090690"><span class="hs-identifier hs-var">chunks</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679090693"><a href="#local-6989586621679090693"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-702"></a><span>      </span><a name="local-6989586621679090694"><a href="#local-6989586621679090694"><span class="hs-identifier">ur</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#updateBlock"><span class="hs-identifier hs-var">updateBlock</span></a><span> </span><a href="#local-6989586621679090675"><span class="hs-identifier hs-var">ordered</span></a><span> </span><a href="#local-6989586621679090676"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090693"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090685"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-703"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090694"><span class="hs-identifier hs-var">ur</span></a><span>
</span><a name="line-704"></a><span>      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679090695"><a href="#local-6989586621679090695"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-705"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090695"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-706"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090697"><a href="#local-6989586621679090697"><span class="hs-identifier">failedTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">failed</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-707"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090698"><a href="#local-6989586621679090698"><span class="hs-identifier">updatedTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">nMatched</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-708"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090699"><a href="#local-6989586621679090699"><span class="hs-identifier">modifiedTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-709"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">nModified</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-710"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-711"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">nModified</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-712"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090700"><a href="#local-6989586621679090700"><span class="hs-identifier">totalWriteErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">writeErrors</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-713"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090701"><a href="#local-6989586621679090701"><span class="hs-identifier">totalWriteConcernErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">writeConcernErrors</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-714"></a><span>
</span><a name="line-715"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090702"><a href="#local-6989586621679090702"><span class="hs-identifier">upsertedTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">upserted</span><span> </span><a href="#local-6989586621679090696"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-716"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-717"></a><span>                  </span><a href="#local-6989586621679090697"><span class="hs-identifier hs-var">failedTotal</span></a><span>
</span><a name="line-718"></a><span>                  </span><a href="#local-6989586621679090698"><span class="hs-identifier hs-var">updatedTotal</span></a><span>
</span><a name="line-719"></a><span>                  </span><a href="#local-6989586621679090699"><span class="hs-identifier hs-var">modifiedTotal</span></a><span>
</span><a name="line-720"></a><span>                  </span><span class="hs-number">0</span><span> </span><span class="hs-comment">-- nRemoved</span><span>
</span><a name="line-721"></a><span>                  </span><a href="#local-6989586621679090702"><span class="hs-identifier hs-var">upsertedTotal</span></a><span>
</span><a name="line-722"></a><span>                  </span><a href="#local-6989586621679090700"><span class="hs-identifier hs-var">totalWriteErrors</span></a><span>
</span><a name="line-723"></a><span>                  </span><a href="#local-6989586621679090701"><span class="hs-identifier hs-var">totalWriteConcernErrors</span></a><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679090703"><a href="#local-6989586621679090703"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090703"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-identifier">updateBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090273"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-728"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090273"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-729"></a><a name="updateBlock"><a href="Database.MongoDB.Query.html#updateBlock"><span class="hs-identifier">updateBlock</span></a></a><span> </span><a name="local-6989586621679090704"><a href="#local-6989586621679090704"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090705"><a href="#local-6989586621679090705"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090706"><a href="#local-6989586621679090706"><span class="hs-identifier">prevCount</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090707"><a href="#local-6989586621679090707"><span class="hs-identifier">docs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-730"></a><span>  </span><a name="local-6989586621679090708"><a href="#local-6989586621679090708"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090709"><a href="#local-6989586621679090709"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090708"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-732"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxWireVersion</span><span> </span><a href="#local-6989586621679090709"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-string">&quot;updateMany doesn't support mongodb older than 2.6&quot;</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-735"></a><span>      </span><a name="local-6989586621679090710"><a href="#local-6989586621679090710"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-736"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090711"><a href="#local-6989586621679090711"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090710"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-737"></a><span>                          </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-738"></a><span>                          </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090712"><a href="#local-6989586621679090712"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090712"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-739"></a><span>      </span><a name="local-6989586621679090713"><a href="#local-6989586621679090713"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#updateCommandDocument"><span class="hs-identifier hs-var">updateCommandDocument</span></a><span> </span><a href="#local-6989586621679090705"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090704"><span class="hs-identifier hs-var">ordered</span></a><span> </span><a href="#local-6989586621679090707"><span class="hs-identifier hs-var">docs</span></a><span> </span><a href="#local-6989586621679090711"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090714"><a href="#local-6989586621679090714"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;n&quot;</span><span>
</span><a name="line-742"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090715"><a href="#local-6989586621679090715"><span class="hs-identifier">writeErrorsResults</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-743"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeErrors&quot;</span><span> </span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-744"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-745"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Array</span><span> </span><a name="local-6989586621679090716"><a href="#local-6989586621679090716"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#anyToWriteError"><span class="hs-identifier hs-var">anyToWriteError</span></a><span> </span><a href="#local-6989586621679090706"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090716"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-746"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090717"><a href="#local-6989586621679090717"><span class="hs-identifier">unknownErr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-747"></a><span>                                      </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-748"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-749"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-751"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-752"></a><span>                                      </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span>
</span><a name="line-753"></a><span>                                            </span><a href="#local-6989586621679090706"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-754"></a><span>                                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected array of error docs, but received: &quot;</span><span>
</span><a name="line-755"></a><span>                                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090717"><span class="hs-identifier hs-var">unknownErr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-756"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090718"><a href="#local-6989586621679090718"><span class="hs-identifier">writeConcernResults</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-759"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeConcernError&quot;</span><span> </span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-760"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-761"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Doc</span><span> </span><a name="local-6989586621679090719"><a href="#local-6989586621679090719"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-762"></a><span>                                    </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-763"></a><span>                                    </span><span class="hs-number">0</span><span>
</span><a name="line-764"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>                                    </span><span class="hs-number">0</span><span>
</span><a name="line-766"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-767"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-768"></a><span>                                    </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#WriteConcernFailure"><span class="hs-identifier hs-var">WriteConcernFailure</span></a><span>
</span><a name="line-769"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090719"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;code&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-770"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090719"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;errmsg&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>                                    </span><span class="hs-special">]</span><span>
</span><a name="line-772"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090720"><a href="#local-6989586621679090720"><span class="hs-identifier">unknownErr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-773"></a><span>                                      </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-774"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-775"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-777"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-778"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-779"></a><span>                                      </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span>
</span><a name="line-780"></a><span>                                            </span><a href="#local-6989586621679090706"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-781"></a><span>                                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected doc in writeConcernError, but received: &quot;</span><span>
</span><a name="line-782"></a><span>                                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090720"><span class="hs-identifier hs-var">unknownErr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090721"><a href="#local-6989586621679090721"><span class="hs-identifier">upsertedList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Query.html#docToUpserted"><span class="hs-identifier hs-var">docToUpserted</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;upserted&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-786"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090722"><a href="#local-6989586621679090722"><span class="hs-identifier">successResults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679090714"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090713"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;nModified&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679090721"><span class="hs-identifier hs-var">upsertedList</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-787"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl1'</span><span> </span><a href="Database.MongoDB.Query.html#mergeWriteResults"><span class="hs-identifier hs-var">mergeWriteResults</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090715"><span class="hs-identifier hs-var">writeErrorsResults</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090718"><span class="hs-identifier hs-var">writeConcernResults</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090722"><span class="hs-identifier hs-var">successResults</span></a><span class="hs-special">]</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span class="hs-identifier">interruptibleFor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679090270"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><a href="#local-6989586621679090271"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090272"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090272"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090270"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090271"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090270"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090271"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-791"></a><a name="interruptibleFor"><a href="Database.MongoDB.Query.html#interruptibleFor"><span class="hs-identifier">interruptibleFor</span></a></a><span> </span><a name="local-6989586621679090723"><a href="#local-6989586621679090723"><span class="hs-identifier">ordered</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090724"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-792"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-793"></a><span>    </span><a name="local-6989586621679090724"><a href="#local-6989586621679090724"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679090725"><a href="#local-6989586621679090725"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679090725"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-794"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679090726"><a href="#local-6989586621679090726"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090727"><a href="#local-6989586621679090727"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679090728"><a href="#local-6989586621679090728"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679090729"><a href="#local-6989586621679090729"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-795"></a><span>      </span><a name="local-6989586621679090730"><a href="#local-6989586621679090730"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090729"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679090727"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-796"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="Database.MongoDB.Query.html#isFailed"><span class="hs-identifier hs-var">isFailed</span></a><span> </span><a href="#local-6989586621679090730"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679090723"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-797"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090730"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679090726"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679090724"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090730"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679090726"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090728"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679090729"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span class="hs-identifier">mergeWriteResults</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-801"></a><a name="mergeWriteResults"><a href="Database.MongoDB.Query.html#mergeWriteResults"><span class="hs-identifier">mergeWriteResults</span></a></a><span>
</span><a name="line-802"></a><span>  </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><a name="local-6989586621679090731"><a href="#local-6989586621679090731"><span class="hs-identifier">failed1</span></a></a><span> </span><a name="local-6989586621679090732"><a href="#local-6989586621679090732"><span class="hs-identifier">nMatched1</span></a></a><span> </span><a name="local-6989586621679090733"><a href="#local-6989586621679090733"><span class="hs-identifier">nModified1</span></a></a><span> </span><a name="local-6989586621679090734"><a href="#local-6989586621679090734"><span class="hs-identifier">nDeleted1</span></a></a><span> </span><a name="local-6989586621679090735"><a href="#local-6989586621679090735"><span class="hs-identifier">upserted1</span></a></a><span> </span><a name="local-6989586621679090736"><a href="#local-6989586621679090736"><span class="hs-identifier">writeErrors1</span></a></a><span> </span><a name="local-6989586621679090737"><a href="#local-6989586621679090737"><span class="hs-identifier">writeConcernErrors1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span>  </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><a name="local-6989586621679090738"><a href="#local-6989586621679090738"><span class="hs-identifier">failed2</span></a></a><span> </span><a name="local-6989586621679090739"><a href="#local-6989586621679090739"><span class="hs-identifier">nMatched2</span></a></a><span> </span><a name="local-6989586621679090740"><a href="#local-6989586621679090740"><span class="hs-identifier">nModified2</span></a></a><span> </span><a name="local-6989586621679090741"><a href="#local-6989586621679090741"><span class="hs-identifier">nDeleted2</span></a></a><span> </span><a name="local-6989586621679090742"><a href="#local-6989586621679090742"><span class="hs-identifier">upserted2</span></a></a><span> </span><a name="local-6989586621679090743"><a href="#local-6989586621679090743"><span class="hs-identifier">writeErrors2</span></a></a><span> </span><a name="local-6989586621679090744"><a href="#local-6989586621679090744"><span class="hs-identifier">writeConcernErrors2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-804"></a><span>    </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-805"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090731"><span class="hs-identifier hs-var">failed1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679090738"><span class="hs-identifier hs-var">failed2</span></a><span class="hs-special">)</span><span>
</span><a name="line-806"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090732"><span class="hs-identifier hs-var">nMatched1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679090739"><span class="hs-identifier hs-var">nMatched2</span></a><span class="hs-special">)</span><span>
</span><a name="line-807"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090733"><span class="hs-identifier hs-var">nModified1</span></a><span> </span><a href="#local-6989586621679090740"><span class="hs-identifier hs-var">nModified2</span></a><span class="hs-special">)</span><span>
</span><a name="line-808"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090734"><span class="hs-identifier hs-var">nDeleted1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679090741"><span class="hs-identifier hs-var">nDeleted2</span></a><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">-- This function is used in foldl1' function. The first argument is the accumulator.</span><span>
</span><a name="line-810"></a><span>        </span><span class="hs-comment">-- The list in the accumulator is usually longer than the subsequent value which goes in the second argument.</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-comment">-- So, changing the order of list concatenation allows us to keep linear complexity of the</span><span>
</span><a name="line-812"></a><span>        </span><span class="hs-comment">-- whole list accumulation process.</span><span>
</span><a name="line-813"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090742"><span class="hs-identifier hs-var">upserted2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679090735"><span class="hs-identifier hs-var">upserted1</span></a><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090743"><span class="hs-identifier hs-var">writeErrors2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679090736"><span class="hs-identifier hs-var">writeErrors1</span></a><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679090744"><span class="hs-identifier hs-var">writeConcernErrors2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679090737"><span class="hs-identifier hs-var">writeConcernErrors1</span></a><span class="hs-special">)</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">docToUpserted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier hs-type">Upserted</span></a><span>
</span><a name="line-820"></a><a name="docToUpserted"><a href="Database.MongoDB.Query.html#docToUpserted"><span class="hs-identifier">docToUpserted</span></a></a><span> </span><a name="local-6989586621679090745"><a href="#local-6989586621679090745"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Upserted"><span class="hs-identifier hs-var">Upserted</span></a><span> </span><a href="#local-6989586621679090746"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-6989586621679090747"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-821"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-822"></a><span>    </span><a name="local-6989586621679090746"><a href="#local-6989586621679090746"><span class="hs-identifier">ind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;index&quot;</span><span> </span><a href="#local-6989586621679090745"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-823"></a><span>    </span><a name="local-6989586621679090747"><a href="#local-6989586621679090747"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;_id&quot;</span><span>   </span><a href="#local-6989586621679090745"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span class="hs-identifier">docToWriteError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span>
</span><a name="line-826"></a><a name="docToWriteError"><a href="Database.MongoDB.Query.html#docToWriteError"><span class="hs-identifier">docToWriteError</span></a></a><span> </span><a name="local-6989586621679090748"><a href="#local-6989586621679090748"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><a href="#local-6989586621679090749"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-6989586621679090750"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="#local-6989586621679090751"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-827"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-828"></a><span>    </span><a name="local-6989586621679090749"><a href="#local-6989586621679090749"><span class="hs-identifier">ind</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;index&quot;</span><span>  </span><a href="#local-6989586621679090748"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-829"></a><span>    </span><a name="local-6989586621679090750"><a href="#local-6989586621679090750"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;code&quot;</span><span>   </span><a href="#local-6989586621679090748"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-830"></a><span>    </span><a name="local-6989586621679090751"><a href="#local-6989586621679090751"><span class="hs-identifier">msg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;errmsg&quot;</span><span> </span><a href="#local-6989586621679090748"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><span class="hs-comment">-- ** Delete</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-identifier">delete</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090269"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-835"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090269"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- ^ Delete all documents in selection</span><span>
</span><a name="line-837"></a><a name="delete"><a href="Database.MongoDB.Query.html#delete"><span class="hs-identifier">delete</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#deleteHelper"><span class="hs-identifier hs-var">deleteHelper</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-identifier">deleteOne</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090268"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090268"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span class="hs-comment">-- ^ Delete first document in selection</span><span>
</span><a name="line-842"></a><a name="deleteOne"><a href="Database.MongoDB.Query.html#deleteOne"><span class="hs-identifier">deleteOne</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#deleteHelper"><span class="hs-identifier hs-var">deleteHelper</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#SingleRemove"><span class="hs-identifier hs-var">SingleRemove</span></a><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-identifier">deleteHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090267"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090267"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-846"></a><a name="deleteHelper"><a href="Database.MongoDB.Query.html#deleteHelper"><span class="hs-identifier">deleteHelper</span></a></a><span> </span><a name="local-6989586621679090752"><a href="#local-6989586621679090752"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a name="local-6989586621679090753"><a href="#local-6989586621679090753"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090754"><a href="#local-6989586621679090754"><span class="hs-identifier">col</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-847"></a><span>    </span><a name="local-6989586621679090755"><a href="#local-6989586621679090755"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-848"></a><span>    </span><a name="local-6989586621679090756"><a href="#local-6989586621679090756"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-849"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#write"><span class="hs-identifier hs-var">write</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Delete"><span class="hs-identifier hs-var">Delete</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090755"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679090754"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090752"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621679090753"><span class="hs-identifier hs-var">sel</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090756"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-comment">{-| Bulk delete operation. If one delete fails it will not delete the remaining
 - documents. Current returned value is only a place holder. With mongodb server
 - before 2.6 it will send delete requests one by one. After 2.6 it will use
 - bulk delete feature in mongodb.
 -}</span><span>
</span><a name="line-856"></a><span class="hs-identifier">deleteMany</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090266"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-858"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-859"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090266"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-860"></a><a name="deleteMany"><a href="Database.MongoDB.Query.html#deleteMany"><span class="hs-identifier">deleteMany</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#delete%27"><span class="hs-identifier hs-var">delete'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-comment">{-| Bulk delete operation. If one delete fails it will proceed with the
 - remaining documents. Current returned value is only a place holder. With
 - mongodb server before 2.6 it will send delete requests one by one. After 2.6
 - it will use bulk delete feature in mongodb.
 -}</span><span>
</span><a name="line-867"></a><span class="hs-identifier">deleteAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090265"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-868"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-869"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-870"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090265"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-871"></a><a name="deleteAll"><a href="Database.MongoDB.Query.html#deleteAll"><span class="hs-identifier">deleteAll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#delete%27"><span class="hs-identifier hs-var">delete'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span class="hs-identifier">deleteCommandDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-874"></a><a name="deleteCommandDocument"><a href="Database.MongoDB.Query.html#deleteCommandDocument"><span class="hs-identifier">deleteCommandDocument</span></a></a><span> </span><a name="local-6989586621679090757"><a href="#local-6989586621679090757"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090758"><a href="#local-6989586621679090758"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090759"><a href="#local-6989586621679090759"><span class="hs-identifier">deletes</span></a></a><span> </span><a name="local-6989586621679090760"><a href="#local-6989586621679090760"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-875"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;delete&quot;</span><span>       </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090757"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-876"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ordered&quot;</span><span>      </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090758"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-877"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;deletes&quot;</span><span>      </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090759"><span class="hs-identifier hs-var">deletes</span></a><span>
</span><a name="line-878"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;writeConcern&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090760"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-879"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span class="hs-identifier">delete'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090264"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-882"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-883"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span>
</span><a name="line-884"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-885"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090264"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-886"></a><a name="delete%27"><a href="Database.MongoDB.Query.html#delete%27"><span class="hs-identifier">delete'</span></a></a><span> </span><a name="local-6989586621679090761"><a href="#local-6989586621679090761"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090762"><a href="#local-6989586621679090762"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090763"><a href="#local-6989586621679090763"><span class="hs-identifier">deleteDocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-887"></a><span>  </span><a name="local-6989586621679090764"><a href="#local-6989586621679090764"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-888"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090765"><a href="#local-6989586621679090765"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090764"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-889"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090766"><a href="#local-6989586621679090766"><span class="hs-identifier">deletes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679090767"><a href="#local-6989586621679090767"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090768"><a href="#local-6989586621679090768"><span class="hs-identifier">os</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;q&quot;</span><span>     </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090767"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-890"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;limit&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#SingleRemove"><span class="hs-identifier hs-var">SingleRemove</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090768"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-891"></a><span>                                               </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Remove only one matching</span><span>
</span><a name="line-892"></a><span>                                               </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Remove all matching</span><span>
</span><a name="line-893"></a><span>                                 </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>                    </span><a href="#local-6989586621679090763"><span class="hs-identifier hs-var">deleteDocs</span></a><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span>  </span><a name="local-6989586621679090769"><a href="#local-6989586621679090769"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-897"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090770"><a href="#local-6989586621679090770"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090769"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-898"></a><span>                        </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-899"></a><span>                        </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090771"><a href="#local-6989586621679090771"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090771"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-900"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090772"><a href="#local-6989586621679090772"><span class="hs-identifier">docSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#sizeOfDocument"><span class="hs-identifier hs-var">sizeOfDocument</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#deleteCommandDocument"><span class="hs-identifier hs-var">deleteCommandDocument</span></a><span> </span><a href="#local-6989586621679090762"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090761"><span class="hs-identifier hs-var">ordered</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090770"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-901"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090773"><a href="#local-6989586621679090773"><span class="hs-identifier">preChunks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#splitAtLimit"><span class="hs-identifier hs-var">splitAtLimit</span></a><span>
</span><a name="line-902"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">maxBsonObjectSize</span><span> </span><a href="#local-6989586621679090765"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679090772"><span class="hs-identifier hs-var">docSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>                                           </span><span class="hs-comment">-- size of auxiliary part of delete</span><span>
</span><a name="line-904"></a><span>                                           </span><span class="hs-comment">-- document should be subtracted from</span><span>
</span><a name="line-905"></a><span>                                           </span><span class="hs-comment">-- the overall size</span><span>
</span><a name="line-906"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">maxWriteBatchSize</span><span> </span><a href="#local-6989586621679090765"><span class="hs-identifier hs-var">sd</span></a><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>                      </span><a href="#local-6989586621679090766"><span class="hs-identifier hs-var">deletes</span></a><span>
</span><a name="line-908"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090774"><a href="#local-6989586621679090774"><span class="hs-identifier">chunks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-909"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090761"><span class="hs-identifier hs-var">ordered</span></a><span>
</span><a name="line-910"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="Database.MongoDB.Query.html#takeRightsUpToLeft"><span class="hs-identifier hs-var">takeRightsUpToLeft</span></a><span> </span><a href="#local-6989586621679090773"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-911"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621679090773"><span class="hs-identifier hs-var">preChunks</span></a><span>
</span><a name="line-912"></a><span>  </span><a name="local-6989586621679090775"><a href="#local-6989586621679090775"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-913"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090776"><a href="#local-6989586621679090776"><span class="hs-identifier">lens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679090774"><span class="hs-identifier hs-var">chunks</span></a><span>
</span><a name="line-914"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090777"><a href="#local-6989586621679090777"><span class="hs-identifier">lSums</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090777"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090776"><span class="hs-identifier hs-var">lens</span></a><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>  </span><a name="local-6989586621679090781"><a href="#local-6989586621679090781"><span class="hs-identifier">blockResult</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#interruptibleFor"><span class="hs-identifier hs-var">interruptibleFor</span></a><span> </span><a href="#local-6989586621679090761"><span class="hs-identifier hs-var">ordered</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679090777"><span class="hs-identifier hs-var">lSums</span></a><span> </span><a href="#local-6989586621679090774"><span class="hs-identifier hs-var">chunks</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679090778"><a href="#local-6989586621679090778"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-916"></a><span>    </span><a name="local-6989586621679090779"><a href="#local-6989586621679090779"><span class="hs-identifier">dr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#deleteBlock"><span class="hs-identifier hs-var">deleteBlock</span></a><span> </span><a href="#local-6989586621679090761"><span class="hs-identifier hs-var">ordered</span></a><span> </span><a href="#local-6989586621679090762"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090778"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090775"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-917"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090779"><span class="hs-identifier hs-var">dr</span></a><span>
</span><a name="line-918"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679090780"><a href="#local-6989586621679090780"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-919"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090780"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-920"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl1'</span><span> </span><a href="Database.MongoDB.Query.html#mergeWriteResults"><span class="hs-identifier hs-var">mergeWriteResults</span></a><span> </span><a href="#local-6989586621679090781"><span class="hs-identifier hs-var">blockResult</span></a><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-identifier">addFailureIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span>
</span><a name="line-924"></a><a name="addFailureIndex"><a href="Database.MongoDB.Query.html#addFailureIndex"><span class="hs-identifier">addFailureIndex</span></a></a><span> </span><a name="local-6989586621679090782"><a href="#local-6989586621679090782"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><a name="local-6989586621679090783"><a href="#local-6989586621679090783"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-6989586621679090784"><a href="#local-6989586621679090784"><span class="hs-identifier">code</span></a></a><span> </span><a name="local-6989586621679090785"><a href="#local-6989586621679090785"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#WriteFailure"><span class="hs-identifier hs-var">WriteFailure</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090783"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679090782"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090784"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="#local-6989586621679090785"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-925"></a><span class="hs-identifier">addFailureIndex</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090786"><a href="#local-6989586621679090786"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090786"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span class="hs-identifier">deleteBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090263"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090263"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-type">WriteResult</span></a><span>
</span><a name="line-929"></a><a name="deleteBlock"><a href="Database.MongoDB.Query.html#deleteBlock"><span class="hs-identifier">deleteBlock</span></a></a><span> </span><a name="local-6989586621679090787"><a href="#local-6989586621679090787"><span class="hs-identifier">ordered</span></a></a><span> </span><a name="local-6989586621679090788"><a href="#local-6989586621679090788"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090789"><a href="#local-6989586621679090789"><span class="hs-identifier">prevCount</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090790"><a href="#local-6989586621679090790"><span class="hs-identifier">docs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-930"></a><span>  </span><a name="local-6989586621679090791"><a href="#local-6989586621679090791"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-931"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090792"><a href="#local-6989586621679090792"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">P</span><span class="hs-operator">.</span><span class="hs-identifier">serverData</span><span> </span><a href="#local-6989586621679090791"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-932"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">maxWireVersion</span><span> </span><a href="#local-6989586621679090792"><span class="hs-identifier hs-var">sd</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-string">&quot;deleteMany doesn't support mongodb older than 2.6&quot;</span><span>
</span><a name="line-934"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-935"></a><span>      </span><a name="local-6989586621679090793"><a href="#local-6989586621679090793"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><a href="Database.MongoDB.Query.html#mongoWriteMode"><span class="hs-identifier hs-var">mongoWriteMode</span></a><span>
</span><a name="line-936"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090794"><a href="#local-6989586621679090794"><span class="hs-identifier">writeConcern</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090793"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-937"></a><span>                          </span><a href="Database.MongoDB.Query.html#NoConfirm"><span class="hs-identifier hs-var">NoConfirm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;w&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-938"></a><span>                          </span><a href="Database.MongoDB.Query.html#Confirm"><span class="hs-identifier hs-var">Confirm</span></a><span> </span><a name="local-6989586621679090795"><a href="#local-6989586621679090795"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090795"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-939"></a><span>      </span><a name="local-6989586621679090796"><a href="#local-6989586621679090796"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#deleteCommandDocument"><span class="hs-identifier hs-var">deleteCommandDocument</span></a><span> </span><a href="#local-6989586621679090788"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090787"><span class="hs-identifier hs-var">ordered</span></a><span> </span><a href="#local-6989586621679090790"><span class="hs-identifier hs-var">docs</span></a><span> </span><a href="#local-6989586621679090794"><span class="hs-identifier hs-var">writeConcern</span></a><span>
</span><a name="line-940"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090797"><a href="#local-6989586621679090797"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090796"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;n&quot;</span><span>
</span><a name="line-941"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;result of delete block: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090797"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090798"><a href="#local-6989586621679090798"><span class="hs-identifier">successResults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679090797"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-944"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090799"><a href="#local-6989586621679090799"><span class="hs-identifier">writeErrorsResults</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-945"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeErrors&quot;</span><span> </span><a href="#local-6989586621679090796"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-946"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-947"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Array</span><span> </span><a name="local-6989586621679090800"><a href="#local-6989586621679090800"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#anyToWriteError"><span class="hs-identifier hs-var">anyToWriteError</span></a><span> </span><a href="#local-6989586621679090789"><span class="hs-identifier hs-var">prevCount</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090800"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-948"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090801"><a href="#local-6989586621679090801"><span class="hs-identifier">unknownErr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-949"></a><span>                                      </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-950"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-951"></a><span>                                      </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-952"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-953"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-954"></a><span>                                      </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span>
</span><a name="line-955"></a><span>                                            </span><a href="#local-6989586621679090789"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-956"></a><span>                                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected array of error docs, but received: &quot;</span><span>
</span><a name="line-957"></a><span>                                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090801"><span class="hs-identifier hs-var">unknownErr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-958"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-959"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090802"><a href="#local-6989586621679090802"><span class="hs-identifier">writeConcernResults</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-960"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;writeConcernError&quot;</span><span> </span><a href="#local-6989586621679090796"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-961"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-962"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Doc</span><span> </span><a name="local-6989586621679090803"><a href="#local-6989586621679090803"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-963"></a><span>                                    </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-964"></a><span>                                    </span><span class="hs-number">0</span><span>
</span><a name="line-965"></a><span>                                    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-966"></a><span>                                    </span><span class="hs-number">0</span><span>
</span><a name="line-967"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-968"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-969"></a><span>                                    </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#WriteConcernFailure"><span class="hs-identifier hs-var">WriteConcernFailure</span></a><span>
</span><a name="line-970"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090803"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;code&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090803"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">!?</span><span> </span><span class="hs-string">&quot;errmsg&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>                                    </span><span class="hs-special">]</span><span>
</span><a name="line-973"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090804"><a href="#local-6989586621679090804"><span class="hs-identifier">unknownErr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#WriteResult"><span class="hs-identifier hs-var">WriteResult</span></a><span>
</span><a name="line-974"></a><span>                                      </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-975"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-976"></a><span>                                      </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-977"></a><span>                                      </span><span class="hs-number">0</span><span>
</span><a name="line-978"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-979"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-980"></a><span>                                      </span><span class="hs-special">[</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span>
</span><a name="line-981"></a><span>                                            </span><a href="#local-6989586621679090789"><span class="hs-identifier hs-var">prevCount</span></a><span>
</span><a name="line-982"></a><span>                                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Expected doc in writeConcernError, but received: &quot;</span><span>
</span><a name="line-983"></a><span>                                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090804"><span class="hs-identifier hs-var">unknownErr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-984"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl1'</span><span> </span><a href="Database.MongoDB.Query.html#mergeWriteResults"><span class="hs-identifier hs-var">mergeWriteResults</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090798"><span class="hs-identifier hs-var">successResults</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090799"><span class="hs-identifier hs-var">writeErrorsResults</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090802"><span class="hs-identifier hs-var">writeConcernResults</span></a><span class="hs-special">]</span><span>
</span><a name="line-985"></a><span>
</span><a name="line-986"></a><span class="hs-identifier">anyToWriteError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Value</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span>
</span><a name="line-987"></a><a name="anyToWriteError"><a href="Database.MongoDB.Query.html#anyToWriteError"><span class="hs-identifier">anyToWriteError</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Doc</span><span> </span><a name="local-6989586621679090805"><a href="#local-6989586621679090805"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#docToWriteError"><span class="hs-identifier hs-var">docToWriteError</span></a><span> </span><a href="#local-6989586621679090805"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-988"></a><span class="hs-identifier">anyToWriteError</span><span> </span><a name="local-6989586621679090806"><a href="#local-6989586621679090806"><span class="hs-identifier">ind</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#ProtocolFailure"><span class="hs-identifier hs-var">ProtocolFailure</span></a><span> </span><a href="#local-6989586621679090806"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-string">&quot;Unknown bson value&quot;</span><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span class="hs-comment">-- * Read</span><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span class="hs-keyword">data</span><span> </span><a name="ReadMode"><a href="Database.MongoDB.Query.html#ReadMode"><span class="hs-identifier">ReadMode</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-993"></a><span>      </span><a name="Fresh"><a href="Database.MongoDB.Query.html#Fresh"><span class="hs-identifier">Fresh</span></a></a><span>  </span><span class="hs-comment">-- ^ read from master only</span><span>
</span><a name="line-994"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="StaleOk"><a href="Database.MongoDB.Query.html#StaleOk"><span class="hs-identifier">StaleOk</span></a></a><span>  </span><span class="hs-comment">-- ^ read from slave ok</span><span>
</span><a name="line-995"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-996"></a><span>
</span><a name="line-997"></a><span class="hs-identifier">readModeOption</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#ReadMode"><span class="hs-identifier hs-type">ReadMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">]</span><span>
</span><a name="line-998"></a><a name="readModeOption"><a href="Database.MongoDB.Query.html#readModeOption"><span class="hs-identifier">readModeOption</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-999"></a><span class="hs-identifier">readModeOption</span><span> </span><a href="Database.MongoDB.Query.html#StaleOk"><span class="hs-identifier hs-var">StaleOk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#SlaveOK"><span class="hs-identifier hs-var">SlaveOK</span></a><span class="hs-special">]</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span class="hs-comment">-- ** Query</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span class="hs-comment">-- | Use 'select' to create a basic query with defaults, then modify if desired. For example, @(select sel col) {limit = 10}@</span><span>
</span><a name="line-1004"></a><span class="hs-keyword">data</span><span> </span><a name="Query"><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier">Query</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Query"><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier">Query</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1005"></a><span>    </span><a name="options"><a href="Database.MongoDB.Query.html#options"><span class="hs-identifier">options</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Default = []</span><span>
</span><a name="line-1006"></a><span>    </span><a name="selection"><a href="Database.MongoDB.Query.html#selection"><span class="hs-identifier">selection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span class="hs-special">,</span><span>
</span><a name="line-1007"></a><span>    </span><a name="project"><a href="Database.MongoDB.Query.html#project"><span class="hs-identifier">project</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Projector"><span class="hs-identifier hs-type">Projector</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ \[\] = all fields. Default = []</span><span>
</span><a name="line-1008"></a><span>    </span><a name="skip"><a href="Database.MongoDB.Query.html#skip"><span class="hs-identifier">skip</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Number of initial matching documents to skip. Default = 0</span><span>
</span><a name="line-1009"></a><span>    </span><a name="limit"><a href="Database.MongoDB.Query.html#limit"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ Maximum number of documents to return, 0 = no limit. Default = 0</span><span>
</span><a name="line-1010"></a><span>    </span><a name="sort"><a href="Database.MongoDB.Query.html#sort"><span class="hs-identifier">sort</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Sort results by this order, [] = no sort. Default = []</span><span>
</span><a name="line-1011"></a><span>    </span><a name="snapshot"><a href="Database.MongoDB.Query.html#snapshot"><span class="hs-identifier">snapshot</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ If true assures no duplicates are returned, or objects missed, which were present at both the start and end of the query's execution (even if the object were updated). If an object is new during the query, or deleted during the query, it may or may not be returned, even with snapshot mode. Note that short query responses (less than 1MB) are always effectively snapshotted. Default = False</span><span>
</span><a name="line-1012"></a><span>    </span><a name="batchSize"><a href="Database.MongoDB.Query.html#batchSize"><span class="hs-identifier">batchSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ The number of document to return in each batch response from the server. 0 means use Mongo default. Default = 0</span><span>
</span><a name="line-1013"></a><span>    </span><a name="hint"><a href="Database.MongoDB.Query.html#hint"><span class="hs-identifier">hint</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span>  </span><span class="hs-comment">-- ^ Force MongoDB to use this index, [] = no hint. Default = []</span><span>
</span><a name="line-1014"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span class="hs-keyword">type</span><span> </span><a name="Projector"><a href="Database.MongoDB.Query.html#Projector"><span class="hs-identifier">Projector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1017"></a><span class="hs-comment">-- ^ Fields to return, analogous to the select clause in SQL. @[]@ means return whole document (analogous to * in SQL). @[\&quot;x\&quot; =: 1, \&quot;y\&quot; =: 1]@ means return only @x@ and @y@ fields of each document. @[\&quot;x\&quot; =: 0]@ means return all fields except @x@.</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-keyword">type</span><span> </span><a name="Limit"><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier">Limit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-1020"></a><span class="hs-comment">-- ^ Maximum number of documents to return, i.e. cursor will close after iterating over this number of documents. 0 means no limit.</span><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span class="hs-keyword">type</span><span> </span><a name="Order"><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier">Order</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1023"></a><span class="hs-comment">-- ^ Fields to sort by. Each one is associated with 1 or -1. Eg. @[\&quot;x\&quot; =: 1, \&quot;y\&quot; =: -1]@ means sort by @x@ ascending then @y@ descending</span><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span class="hs-keyword">type</span><span> </span><a name="BatchSize"><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier">BatchSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-1026"></a><span class="hs-comment">-- ^ The number of document to return in each batch response from the server. 0 means use Mongo default.</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span class="hs-identifier">query</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span>
</span><a name="line-1029"></a><span class="hs-comment">-- ^ Selects documents in collection that match selector. It uses no query options, projects all fields, does not skip any documents, does not limit result size, uses default batch size, does not sort, does not hint, and does not snapshot.</span><span>
</span><a name="line-1030"></a><a name="query"><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier">query</span></a></a><span> </span><a name="local-6989586621679090807"><a href="#local-6989586621679090807"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090808"><a href="#local-6989586621679090808"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-var">Query</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a href="#local-6989586621679090807"><span class="hs-identifier hs-var">sel</span></a><span> </span><a href="#local-6989586621679090808"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span class="hs-identifier">find</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090262"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090262"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span>
</span><a name="line-1033"></a><span class="hs-comment">-- ^ Fetch documents satisfying query</span><span>
</span><a name="line-1034"></a><a name="find"><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier">find</span></a></a><span> </span><a name="local-6989586621679090809"><a href="#local-6989586621679090809"><span class="hs-identifier">q</span></a></a><span class="hs-glyph">@</span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><a name="local-6989586621679090810"><a href="#local-6989586621679090810"><span class="hs-identifier">selection</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090811"><a href="#local-6989586621679090811"><span class="hs-identifier">batchSize</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1035"></a><span>    </span><a name="local-6989586621679090812"><a href="#local-6989586621679090812"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-1036"></a><span>    </span><a name="local-6989586621679090813"><a href="#local-6989586621679090813"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1037"></a><span>    </span><a name="local-6989586621679090814"><a href="#local-6989586621679090814"><span class="hs-identifier">qr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#queryRequest"><span class="hs-identifier hs-var">queryRequest</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679090809"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-1038"></a><span>    </span><a name="local-6989586621679090815"><a href="#local-6989586621679090815"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679090813"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090814"><span class="hs-identifier hs-var">qr</span></a><span>
</span><a name="line-1039"></a><span>    </span><a href="Database.MongoDB.Query.html#newCursor"><span class="hs-identifier hs-var">newCursor</span></a><span> </span><a href="#local-6989586621679090812"><span class="hs-identifier hs-var">db</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">coll</span><span> </span><a href="#local-6989586621679090810"><span class="hs-identifier hs-var">selection</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090811"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090815"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-identifier">findOne</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090261"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090261"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-1042"></a><span class="hs-comment">-- ^ Fetch first document satisfying query or Nothing if none satisfy it</span><span>
</span><a name="line-1043"></a><a name="findOne"><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier">findOne</span></a></a><span> </span><a name="local-6989586621679090816"><a href="#local-6989586621679090816"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1044"></a><span>    </span><a name="local-6989586621679090817"><a href="#local-6989586621679090817"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1045"></a><span>    </span><a name="local-6989586621679090818"><a href="#local-6989586621679090818"><span class="hs-identifier">qr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#queryRequest"><span class="hs-identifier hs-var">queryRequest</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621679090816"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">limit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span class="hs-special">}</span><span>
</span><a name="line-1046"></a><span>    </span><a name="local-6989586621679090819"><a href="#local-6989586621679090819"><span class="hs-identifier">rq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679090817"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090818"><span class="hs-identifier hs-var">qr</span></a><span>
</span><a name="line-1047"></a><span>    </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090820"><a href="#local-6989586621679090820"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><a href="#local-6989586621679090819"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><a href="#local-6989586621679090820"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1049"></a><span>
</span><a name="line-1050"></a><span class="hs-identifier">fetch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090260"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090260"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1051"></a><span class="hs-comment">-- ^ Same as 'findOne' except throw 'DocNotFound' if none match</span><span>
</span><a name="line-1052"></a><a name="fetch"><a href="Database.MongoDB.Query.html#fetch"><span class="hs-identifier">fetch</span></a></a><span> </span><a name="local-6989586621679090821"><a href="#local-6989586621679090821"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span> </span><a href="#local-6989586621679090821"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#DocNotFound"><span class="hs-identifier hs-var">DocNotFound</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">selection</span><span> </span><a href="#local-6989586621679090821"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-1053"></a><span>
</span><a name="line-1054"></a><span class="hs-keyword">data</span><span> </span><a name="FindAndModifyOpts"><a href="Database.MongoDB.Query.html#FindAndModifyOpts"><span class="hs-identifier">FindAndModifyOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FamRemove"><a href="Database.MongoDB.Query.html#FamRemove"><span class="hs-identifier">FamRemove</span></a></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1055"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="FamUpdate"><a href="Database.MongoDB.Query.html#FamUpdate"><span class="hs-identifier">FamUpdate</span></a></a><span>
</span><a name="line-1056"></a><span>                         </span><span class="hs-special">{</span><span> </span><a name="famUpdate"><a href="Database.MongoDB.Query.html#famUpdate"><span class="hs-identifier">famUpdate</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1057"></a><span>                         </span><span class="hs-special">,</span><span> </span><a name="famNew"><a href="Database.MongoDB.Query.html#famNew"><span class="hs-identifier">famNew</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1058"></a><span>                         </span><span class="hs-special">,</span><span> </span><a name="famUpsert"><a href="Database.MongoDB.Query.html#famUpsert"><span class="hs-identifier">famUpsert</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1059"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-1060"></a><span>                       </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-1061"></a><span>
</span><a name="line-1062"></a><span class="hs-identifier">defFamUpdateOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#FindAndModifyOpts"><span class="hs-identifier hs-type">FindAndModifyOpts</span></a><span>
</span><a name="line-1063"></a><a name="defFamUpdateOpts"><a href="Database.MongoDB.Query.html#defFamUpdateOpts"><span class="hs-identifier">defFamUpdateOpts</span></a></a><span> </span><a name="local-6989586621679090822"><a href="#local-6989586621679090822"><span class="hs-identifier">ups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#FamUpdate"><span class="hs-identifier hs-var">FamUpdate</span></a><span>
</span><a name="line-1064"></a><span>                       </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">famNew</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1065"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">famUpsert</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1066"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">famUpdate</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090822"><span class="hs-identifier hs-var">ups</span></a><span>
</span><a name="line-1067"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1068"></a><span>
</span><a name="line-1069"></a><span class="hs-comment">-- | runs the findAndModify command as an update without an upsert and new set to true.</span><span>
</span><a name="line-1070"></a><span class="hs-comment">-- Returns a single updated document (new option is set to true).</span><span>
</span><a name="line-1071"></a><span class="hs-comment">--</span><span>
</span><a name="line-1072"></a><span class="hs-comment">-- see 'findAndModifyOpts' if you want to use findAndModify in a differnt way</span><span>
</span><a name="line-1073"></a><span class="hs-identifier">findAndModify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090259"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1074"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span>
</span><a name="line-1075"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span> </span><span class="hs-comment">-- ^ updates</span><span>
</span><a name="line-1076"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090259"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-1077"></a><a name="findAndModify"><a href="Database.MongoDB.Query.html#findAndModify"><span class="hs-identifier">findAndModify</span></a></a><span> </span><a name="local-6989586621679090823"><a href="#local-6989586621679090823"><span class="hs-identifier">q</span></a></a><span> </span><a name="local-6989586621679090824"><a href="#local-6989586621679090824"><span class="hs-identifier">ups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1078"></a><span>  </span><a name="local-6989586621679090825"><a href="#local-6989586621679090825"><span class="hs-identifier">eres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#findAndModifyOpts"><span class="hs-identifier hs-var">findAndModifyOpts</span></a><span> </span><a href="#local-6989586621679090823"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#defFamUpdateOpts"><span class="hs-identifier hs-var">defFamUpdateOpts</span></a><span> </span><a href="#local-6989586621679090824"><span class="hs-identifier hs-var">ups</span></a><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090825"><span class="hs-identifier hs-var">eres</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1080"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679090826"><a href="#local-6989586621679090826"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679090826"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1081"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679090827"><a href="#local-6989586621679090827"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090827"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1082"></a><span>      </span><span class="hs-comment">-- only possible when upsert is True and new is False</span><span>
</span><a name="line-1083"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;findAndModify: impossible null result&quot;</span><span>
</span><a name="line-1084"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090828"><a href="#local-6989586621679090828"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679090828"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span class="hs-comment">-- | runs the findAndModify command,</span><span>
</span><a name="line-1087"></a><span class="hs-comment">-- allows more options than 'findAndModify'</span><span>
</span><a name="line-1088"></a><span class="hs-identifier">findAndModifyOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090258"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1089"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span>
</span><a name="line-1090"></a><span>                  </span><span class="hs-glyph">-&gt;</span><a href="Database.MongoDB.Query.html#FindAndModifyOpts"><span class="hs-identifier hs-type">FindAndModifyOpts</span></a><span>
</span><a name="line-1091"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090258"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><a name="findAndModifyOpts"><a href="Database.MongoDB.Query.html#findAndModifyOpts"><span class="hs-identifier">findAndModifyOpts</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-var">Query</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1093"></a><span>    </span><span class="hs-identifier">selection</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a name="local-6989586621679090829"><a href="#local-6989586621679090829"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090830"><a href="#local-6989586621679090830"><span class="hs-identifier">collection</span></a></a><span>
</span><a name="line-1094"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">project</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679090831"><a href="#local-6989586621679090831"><span class="hs-identifier">project</span></a></a><span>
</span><a name="line-1095"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sort</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679090832"><a href="#local-6989586621679090832"><span class="hs-identifier">sort</span></a></a><span>
</span><a name="line-1096"></a><span>  </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679090833"><a href="#local-6989586621679090833"><span class="hs-identifier">famOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1097"></a><span>    </span><a name="local-6989586621679090844"><a href="#local-6989586621679090844"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span>
</span><a name="line-1098"></a><span>       </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;findAndModify&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">String</span><span> </span><a href="#local-6989586621679090830"><span class="hs-identifier hs-var">collection</span></a><span>
</span><a name="line-1099"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;query&quot;</span><span>  </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Doc</span><span> </span><a href="#local-6989586621679090829"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-1100"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;fields&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Doc</span><span> </span><a href="#local-6989586621679090831"><span class="hs-identifier hs-var">project</span></a><span>
</span><a name="line-1101"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;sort&quot;</span><span>   </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Doc</span><span> </span><a href="#local-6989586621679090832"><span class="hs-identifier hs-var">sort</span></a><span>
</span><a name="line-1102"></a><span>        </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1103"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090833"><span class="hs-identifier hs-var">famOpts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1104"></a><span>              </span><a href="Database.MongoDB.Query.html#FamRemove"><span class="hs-identifier hs-var">FamRemove</span></a><span> </span><a name="local-6989586621679090840"><a href="#local-6989586621679090840"><span class="hs-identifier">shouldRemove</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;remove&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Bool</span><span> </span><a href="#local-6989586621679090840"><span class="hs-identifier hs-var">shouldRemove</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1105"></a><span>              </span><a href="Database.MongoDB.Query.html#FamUpdate"><span class="hs-identifier hs-var">FamUpdate</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1106"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;update&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Doc</span><span> </span><a href="#local-6989586621679090841"><span class="hs-identifier hs-var">famUpdate</span></a><span>
</span><a name="line-1107"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;new&quot;</span><span>    </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Bool</span><span> </span><a href="#local-6989586621679090842"><span class="hs-identifier hs-var">famNew</span></a><span>    </span><span class="hs-comment">-- return updated document, not original document</span><span>
</span><a name="line-1108"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;upsert&quot;</span><span> </span><span class="hs-operator hs-var">:=</span><span> </span><span class="hs-identifier hs-var">Bool</span><span> </span><a href="#local-6989586621679090843"><span class="hs-identifier hs-var">famUpsert</span></a><span> </span><span class="hs-comment">-- insert if nothing is found</span><span>
</span><a name="line-1109"></a><span>                </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1110"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090835"><span class="hs-identifier hs-var">lookupErr</span></a><span> </span><a href="#local-6989586621679090844"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1111"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090845"><a href="#local-6989586621679090845"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090834"><span class="hs-identifier hs-var">leftErr</span></a><span> </span><a href="#local-6989586621679090845"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1112"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;value&quot;</span><span> </span><a href="#local-6989586621679090844"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1113"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679090846"><a href="#local-6989586621679090846"><span class="hs-identifier">err</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090834"><span class="hs-identifier hs-var">leftErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;no document found: &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090846"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1114"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679090847"><a href="#local-6989586621679090847"><span class="hs-identifier">mdoc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090847"><span class="hs-identifier hs-var">mdoc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1115"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090848"><a href="#local-6989586621679090848"><span class="hs-identifier">doc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679090848"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1116"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090833"><span class="hs-identifier hs-var">famOpts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1117"></a><span>                    </span><a href="Database.MongoDB.Query.html#FamUpdate"><span class="hs-identifier hs-var">FamUpdate</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">famUpsert</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">famNew</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1118"></a><span>                    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090834"><span class="hs-identifier hs-var">leftErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090844"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-1119"></a><span>                </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090834"><span class="hs-identifier hs-var">leftErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090844"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-1120"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1121"></a><span>    </span><a name="local-6989586621679090834"><a href="#local-6989586621679090834"><span class="hs-identifier">leftErr</span></a></a><span> </span><a name="local-6989586621679090836"><a href="#local-6989586621679090836"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;findAndModify &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090830"><span class="hs-identifier hs-var">collection</span></a><span>
</span><a name="line-1122"></a><span>        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;\nfrom query: &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090829"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-1123"></a><span>        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;\nerror: &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679090836"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1124"></a><span>
</span><a name="line-1125"></a><span>    </span><span class="hs-comment">-- return Nothing means ok, Just is the error message</span><span>
</span><a name="line-1126"></a><span>    </span><a name="local-6989586621679090835"><a href="#local-6989586621679090835"><span class="hs-identifier">lookupErr</span></a></a><span> </span><a name="local-6989586621679090837"><a href="#local-6989586621679090837"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;lastErrorObject&quot;</span><span> </span><a href="#local-6989586621679090837"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1127"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679090838"><a href="#local-6989586621679090838"><span class="hs-identifier">errObject</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;err&quot;</span><span> </span><a href="#local-6989586621679090838"><span class="hs-identifier hs-var">errObject</span></a><span>
</span><a name="line-1128"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679090839"><a href="#local-6989586621679090839"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679090839"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">explain</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090257"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090257"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1131"></a><span class="hs-comment">-- ^ Return performance stats of query execution</span><span>
</span><a name="line-1132"></a><a name="explain"><a href="Database.MongoDB.Query.html#explain"><span class="hs-identifier">explain</span></a></a><span> </span><a name="local-6989586621679090849"><a href="#local-6989586621679090849"><span class="hs-identifier">q</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- same as findOne but with explain set to true</span><span>
</span><a name="line-1133"></a><span>    </span><a name="local-6989586621679090850"><a href="#local-6989586621679090850"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1134"></a><span>    </span><a name="local-6989586621679090851"><a href="#local-6989586621679090851"><span class="hs-identifier">qr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#queryRequest"><span class="hs-identifier hs-var">queryRequest</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621679090849"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">limit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span class="hs-special">}</span><span>
</span><a name="line-1135"></a><span>    </span><a name="local-6989586621679090852"><a href="#local-6989586621679090852"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679090850"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090851"><span class="hs-identifier hs-var">qr</span></a><span>
</span><a name="line-1136"></a><span>    </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090853"><a href="#local-6989586621679090853"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><a href="#local-6989586621679090852"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090853"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;no explain: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090849"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090853"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-1138"></a><span>
</span><a name="line-1139"></a><span class="hs-identifier">count</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090256"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090256"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1140"></a><span class="hs-comment">-- ^ Fetch number of documents satisfying query (including effect of skip and/or limit if present)</span><span>
</span><a name="line-1141"></a><a name="count"><a href="Database.MongoDB.Query.html#count"><span class="hs-identifier">count</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><span class="hs-identifier">selection</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a name="local-6989586621679090854"><a href="#local-6989586621679090854"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090855"><a href="#local-6989586621679090855"><span class="hs-identifier">col</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090856"><a href="#local-6989586621679090856"><span class="hs-identifier">skip</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090857"><a href="#local-6989586621679090857"><span class="hs-identifier">limit</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;n&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-string">&quot;count&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090855"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;query&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090854"><span class="hs-identifier hs-var">sel</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;skip&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679090856"><span class="hs-identifier hs-var">skip</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1143"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;limit&quot;</span><span> </span><span class="hs-operator hs-var">=?</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090857"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679090857"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span class="hs-identifier">distinct</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090255"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Selection"><span class="hs-identifier hs-type">Selection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090255"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Value</span><span class="hs-special">]</span><span>
</span><a name="line-1146"></a><span class="hs-comment">-- ^ Fetch distinct values of field in selected documents</span><span>
</span><a name="line-1147"></a><a name="distinct"><a href="Database.MongoDB.Query.html#distinct"><span class="hs-identifier">distinct</span></a></a><span> </span><a name="local-6989586621679090858"><a href="#local-6989586621679090858"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><a name="local-6989586621679090859"><a href="#local-6989586621679090859"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621679090860"><a href="#local-6989586621679090860"><span class="hs-identifier">col</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;values&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;distinct&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090860"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;key&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090858"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;query&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090859"><span class="hs-identifier hs-var">sel</span></a><span class="hs-special">]</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-identifier">queryRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679090254"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090254"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span class="hs-comment">-- ^ Translate Query to Protocol.Query. If first arg is true then add special $explain attribute.</span><span>
</span><a name="line-1151"></a><a name="queryRequest"><a href="Database.MongoDB.Query.html#queryRequest"><span class="hs-identifier">queryRequest</span></a></a><span> </span><a name="local-6989586621679090861"><a href="#local-6989586621679090861"><span class="hs-identifier">isExplain</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1152"></a><span>    </span><a name="local-6989586621679090887"><a href="#local-6989586621679090887"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-1153"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090871"><span class="hs-identifier hs-var">queryRequest'</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#mongoReadMode"><span class="hs-identifier hs-var">mongoReadMode</span></a><span> </span><a href="#local-6989586621679090887"><span class="hs-identifier hs-var">ctx</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mongoDatabase</span><span> </span><a href="#local-6989586621679090887"><span class="hs-identifier hs-var">ctx</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1155"></a><span>    </span><a name="local-6989586621679090871"><a href="#local-6989586621679090871"><span class="hs-identifier">queryRequest'</span></a></a><span> </span><a name="local-6989586621679090872"><a href="#local-6989586621679090872"><span class="hs-identifier">rm</span></a></a><span> </span><a name="local-6989586621679090873"><a href="#local-6989586621679090873"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Query"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090878"><span class="hs-identifier hs-var">remainingLimit</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1156"></a><span>        </span><a name="local-6989586621679090874"><a href="#local-6989586621679090874"><span class="hs-identifier">qOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#readModeOption"><span class="hs-identifier hs-var">readModeOption</span></a><span> </span><a href="#local-6989586621679090872"><span class="hs-identifier hs-var">rm</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679090862"><span class="hs-identifier hs-var">options</span></a><span>
</span><a name="line-1157"></a><span>        </span><a name="local-6989586621679090875"><a href="#local-6989586621679090875"><span class="hs-identifier">qFullCollection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090873"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><span class="hs-identifier">coll</span><span> </span><a href="#local-6989586621679090863"><span class="hs-identifier hs-var">selection</span></a><span>
</span><a name="line-1158"></a><span>        </span><a name="local-6989586621679090876"><a href="#local-6989586621679090876"><span class="hs-identifier">qSkip</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679090865"><span class="hs-identifier hs-var">skip</span></a><span>
</span><a name="line-1159"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679090877"><a href="#local-6989586621679090877"><span class="hs-identifier">qBatchSize</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090878"><a href="#local-6989586621679090878"><span class="hs-identifier">remainingLimit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#batchSizeRemainingLimit"><span class="hs-identifier hs-var">batchSizeRemainingLimit</span></a><span> </span><a href="#local-6989586621679090869"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090866"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679090866"><span class="hs-identifier hs-var">limit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1160"></a><span>        </span><a name="local-6989586621679090879"><a href="#local-6989586621679090879"><span class="hs-identifier">qProjector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679090864"><span class="hs-identifier hs-var">project</span></a><span>
</span><a name="line-1161"></a><span>        </span><a name="local-6989586621679090880"><a href="#local-6989586621679090880"><span class="hs-identifier">mOrder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090867"><span class="hs-identifier hs-var">sort</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$orderby&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090867"><span class="hs-identifier hs-var">sort</span></a><span class="hs-special">)</span><span>
</span><a name="line-1162"></a><span>        </span><a name="local-6989586621679090881"><a href="#local-6989586621679090881"><span class="hs-identifier">mSnapshot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090868"><span class="hs-identifier hs-var">snapshot</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$snapshot&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1163"></a><span>        </span><a name="local-6989586621679090882"><a href="#local-6989586621679090882"><span class="hs-identifier">mHint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090870"><span class="hs-identifier hs-var">hint</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$hint&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090870"><span class="hs-identifier hs-var">hint</span></a><span class="hs-special">)</span><span>
</span><a name="line-1164"></a><span>        </span><a name="local-6989586621679090883"><a href="#local-6989586621679090883"><span class="hs-identifier">mExplain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090861"><span class="hs-identifier hs-var">isExplain</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$explain&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1165"></a><span>        </span><a name="local-6989586621679090884"><a href="#local-6989586621679090884"><span class="hs-identifier">special</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090880"><span class="hs-identifier hs-var">mOrder</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090881"><span class="hs-identifier hs-var">mSnapshot</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090882"><span class="hs-identifier hs-var">mHint</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090883"><span class="hs-identifier hs-var">mExplain</span></a><span class="hs-special">]</span><span>
</span><a name="line-1166"></a><span>        </span><a name="local-6989586621679090885"><a href="#local-6989586621679090885"><span class="hs-identifier">qSelector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090884"><span class="hs-identifier hs-var">special</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679090886"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;$query&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090886"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090884"><span class="hs-identifier hs-var">special</span></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679090886"><a href="#local-6989586621679090886"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">selector</span><span> </span><a href="#local-6989586621679090863"><span class="hs-identifier hs-var">selection</span></a><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span class="hs-identifier">batchSizeRemainingLimit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1169"></a><span class="hs-comment">-- ^ Given batchSize and limit return P.qBatchSize and remaining limit</span><span>
</span><a name="line-1170"></a><a name="batchSizeRemainingLimit"><a href="Database.MongoDB.Query.html#batchSizeRemainingLimit"><span class="hs-identifier">batchSizeRemainingLimit</span></a></a><span> </span><a name="local-6989586621679090888"><a href="#local-6989586621679090888"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090889"><a href="#local-6989586621679090889"><span class="hs-identifier">mLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1171"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090890"><a href="#local-6989586621679090890"><span class="hs-identifier">remaining</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1172"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090889"><span class="hs-identifier hs-var">mLimit</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1173"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679090888"><span class="hs-identifier hs-var">batchSize</span></a><span>
</span><a name="line-1174"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090891"><a href="#local-6989586621679090891"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1175"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679090888"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679090888"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679090891"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-1176"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679090888"><span class="hs-identifier hs-var">batchSize</span></a><span>
</span><a name="line-1177"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679090891"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679090890"><span class="hs-identifier hs-var">remaining</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090889"><span class="hs-identifier hs-var">mLimit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1179"></a><span>
</span><a name="line-1180"></a><span class="hs-keyword">type</span><span> </span><a name="DelayedBatch"><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier">DelayedBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-type">Batch</span></a><span>
</span><a name="line-1181"></a><span class="hs-comment">-- ^ A promised batch which may fail</span><span>
</span><a name="line-1182"></a><span>
</span><a name="line-1183"></a><span class="hs-keyword">data</span><span> </span><a name="Batch"><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier">Batch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Batch"><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier">Batch</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1184"></a><span class="hs-comment">-- ^ CursorId = 0 means cursor is finished. Documents is remaining documents to serve in current batch. Limit is number of documents to return. Nothing means no limit.</span><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span class="hs-identifier">request</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span>
</span><a name="line-1187"></a><span class="hs-comment">-- ^ Send notices and request and return promised batch</span><span>
</span><a name="line-1188"></a><a name="request"><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier">request</span></a></a><span> </span><a name="local-6989586621679090892"><a href="#local-6989586621679090892"><span class="hs-identifier">pipe</span></a></a><span> </span><a name="local-6989586621679090893"><a href="#local-6989586621679090893"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679090894"><a href="#local-6989586621679090894"><span class="hs-identifier">req</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090895"><a href="#local-6989586621679090895"><span class="hs-identifier">remainingLimit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1189"></a><span>    </span><a name="local-6989586621679090896"><a href="#local-6989586621679090896"><span class="hs-identifier">promise</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#call"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">call</span></a><span> </span><a href="#local-6989586621679090892"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="#local-6989586621679090893"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-6989586621679090894"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-1190"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090897"><a href="#local-6989586621679090897"><span class="hs-identifier">protectedPromise</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><a href="#local-6989586621679090896"><span class="hs-identifier hs-var">promise</span></a><span>
</span><a name="line-1191"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fromReply"><span class="hs-identifier hs-var">fromReply</span></a><span> </span><a href="#local-6989586621679090895"><span class="hs-identifier hs-var">remainingLimit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="#local-6989586621679090897"><span class="hs-identifier hs-var">protectedPromise</span></a><span>
</span><a name="line-1192"></a><span>
</span><a name="line-1193"></a><span class="hs-identifier">fromReply</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span>
</span><a name="line-1194"></a><span class="hs-comment">-- ^ Convert Reply to Batch or Failure</span><span>
</span><a name="line-1195"></a><a name="fromReply"><a href="Database.MongoDB.Query.html#fromReply"><span class="hs-identifier">fromReply</span></a></a><span> </span><a name="local-6989586621679090898"><a href="#local-6989586621679090898"><span class="hs-identifier">limit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-var">Reply</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621679090903"><span class="hs-identifier hs-var">checkResponseFlag</span></a><span> </span><a href="#local-6989586621679090899"><span class="hs-identifier hs-var">rResponseFlags</span></a><span>
</span><a name="line-1197"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><a href="#local-6989586621679090898"><span class="hs-identifier hs-var">limit</span></a><span> </span><a href="#local-6989586621679090900"><span class="hs-identifier hs-var">rCursorId</span></a><span> </span><a href="#local-6989586621679090902"><span class="hs-identifier hs-var">rDocuments</span></a><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-comment">-- If response flag indicates failure then throw it, otherwise do nothing</span><span>
</span><a name="line-1200"></a><span>    </span><a name="local-6989586621679090903"><a href="#local-6989586621679090903"><span class="hs-identifier">checkResponseFlag</span></a></a><span> </span><a name="local-6989586621679090904"><a href="#local-6989586621679090904"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090904"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1201"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#AwaitCapable"><span class="hs-identifier hs-var">AwaitCapable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1202"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#CursorNotFound"><span class="hs-identifier hs-var">CursorNotFound</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#CursorNotFoundFailure"><span class="hs-identifier hs-var">CursorNotFoundFailure</span></a><span> </span><a href="#local-6989586621679090900"><span class="hs-identifier hs-var">rCursorId</span></a><span>
</span><a name="line-1203"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#QueryError"><span class="hs-identifier hs-var">QueryError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#QueryFailure"><span class="hs-identifier hs-var">QueryFailure</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;code&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090902"><span class="hs-identifier hs-var">rDocuments</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;$err&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621679090902"><span class="hs-identifier hs-var">rDocuments</span></a><span class="hs-special">)</span><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-identifier">fulfill</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-type">Batch</span></a><span>
</span><a name="line-1206"></a><span class="hs-comment">-- ^ Demand and wait for result, raise failure if exception</span><span>
</span><a name="line-1207"></a><a name="fulfill"><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier">fulfill</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-comment">-- *** Cursor</span><span>
</span><a name="line-1210"></a><span>
</span><a name="line-1211"></a><span class="hs-keyword">data</span><span> </span><a name="Cursor"><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier">Cursor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Cursor"><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier">Cursor</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- ^ Iterator over results of a query. Use 'next' to iterate or 'rest' to get all results. A cursor is closed when it is explicitly closed, all results have been read from it, garbage collected, or not used for over 10 minutes (unless 'NoCursorTimeout' option was specified in 'Query'). Reading from a closed cursor raises a 'CursorNotFoundFailure'. Note, a cursor is not closed when the pipe is closed, so you can open another pipe to the same server and continue using the cursor.</span><span>
</span><a name="line-1213"></a><span>
</span><a name="line-1214"></a><span class="hs-identifier">newCursor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090253"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090253"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span>
</span><a name="line-1215"></a><span class="hs-comment">-- ^ Create new cursor. If you don't read all results then close it. Cursor will be closed automatically when all results are read from it or when eventually garbage collected.</span><span>
</span><a name="line-1216"></a><a name="newCursor"><a href="Database.MongoDB.Query.html#newCursor"><span class="hs-identifier">newCursor</span></a></a><span> </span><a name="local-6989586621679090905"><a href="#local-6989586621679090905"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679090906"><a href="#local-6989586621679090906"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090907"><a href="#local-6989586621679090907"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090908"><a href="#local-6989586621679090908"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1217"></a><span>    </span><a name="local-6989586621679090909"><a href="#local-6989586621679090909"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="#local-6989586621679090908"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1218"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090910"><a href="#local-6989586621679090910"><span class="hs-identifier">cursor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-var">Cursor</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090905"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679090906"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090907"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090909"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1219"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#mkWeakMVar"><span class="hs-identifier hs-var">mkWeakMVar</span></a><span> </span><a href="#local-6989586621679090909"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#closeCursor"><span class="hs-identifier hs-var">closeCursor</span></a><span> </span><a href="#local-6989586621679090910"><span class="hs-identifier hs-var">cursor</span></a><span class="hs-special">)</span><span>
</span><a name="line-1220"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090910"><span class="hs-identifier hs-var">cursor</span></a><span>
</span><a name="line-1221"></a><span>
</span><a name="line-1222"></a><span class="hs-identifier">nextBatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090252"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090252"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1223"></a><span class="hs-comment">-- ^ Return next batch of documents in query result, which will be empty if finished.</span><span>
</span><a name="line-1224"></a><a name="nextBatch"><a href="Database.MongoDB.Query.html#nextBatch"><span class="hs-identifier">nextBatch</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-var">Cursor</span></a><span> </span><a name="local-6989586621679090911"><a href="#local-6989586621679090911"><span class="hs-identifier">fcol</span></a></a><span> </span><a name="local-6989586621679090912"><a href="#local-6989586621679090912"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090913"><a href="#local-6989586621679090913"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#modifyMVar"><span class="hs-identifier hs-var">modifyMVar</span></a><span> </span><a href="#local-6989586621679090913"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679090914"><a href="#local-6989586621679090914"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1225"></a><span>    </span><span class="hs-comment">-- Pre-fetch next batch promise from server and return current batch.</span><span>
</span><a name="line-1226"></a><span>    </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><a name="local-6989586621679090915"><a href="#local-6989586621679090915"><span class="hs-identifier">mLimit</span></a></a><span> </span><a name="local-6989586621679090916"><a href="#local-6989586621679090916"><span class="hs-identifier">cid</span></a></a><span> </span><a name="local-6989586621679090917"><a href="#local-6989586621679090917"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fulfill%27"><span class="hs-identifier hs-var">fulfill'</span></a><span> </span><a href="#local-6989586621679090911"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090912"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090914"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1227"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090918"><a href="#local-6989586621679090918"><span class="hs-identifier">newLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1228"></a><span>              </span><a name="local-6989586621679090919"><a href="#local-6989586621679090919"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090915"><span class="hs-identifier hs-var">mLimit</span></a><span>
</span><a name="line-1229"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090919"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">min</span><span> </span><a href="#local-6989586621679090919"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679090917"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090920"><a href="#local-6989586621679090920"><span class="hs-identifier">emptyBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1231"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090921"><a href="#local-6989586621679090921"><span class="hs-identifier">getNextBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#nextBatch%27"><span class="hs-identifier hs-var">nextBatch'</span></a><span> </span><a href="#local-6989586621679090911"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090912"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090918"><span class="hs-identifier hs-var">newLimit</span></a><span> </span><a href="#local-6989586621679090916"><span class="hs-identifier hs-var">cid</span></a><span>
</span><a name="line-1232"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090922"><a href="#local-6989586621679090922"><span class="hs-identifier">resultDocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090915"><span class="hs-identifier hs-var">mLimit</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090917"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-1233"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090916"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090918"><span class="hs-identifier hs-var">newLimit</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1234"></a><span>      </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090920"><span class="hs-identifier hs-var">emptyBatch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090922"><span class="hs-identifier hs-var">resultDocs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1235"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1236"></a><span>        </span><a name="local-6989586621679090923"><a href="#local-6989586621679090923"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1237"></a><span>        </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-6989586621679090923"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier hs-var">KillCursors</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090916"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1238"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090920"><span class="hs-identifier hs-var">emptyBatch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090922"><span class="hs-identifier hs-var">resultDocs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1239"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090922"><span class="hs-identifier hs-var">resultDocs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679090921"><span class="hs-identifier hs-var">getNextBatch</span></a><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-identifier">fulfill'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-type">Batch</span></a><span>
</span><a name="line-1242"></a><span class="hs-comment">-- Discard pre-fetched batch if empty with nonzero cid.</span><span>
</span><a name="line-1243"></a><a name="fulfill%27"><a href="Database.MongoDB.Query.html#fulfill%27"><span class="hs-identifier">fulfill'</span></a></a><span> </span><a name="local-6989586621679090924"><a href="#local-6989586621679090924"><span class="hs-identifier">fcol</span></a></a><span> </span><a name="local-6989586621679090925"><a href="#local-6989586621679090925"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090926"><a href="#local-6989586621679090926"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1244"></a><span>    </span><a name="local-6989586621679090927"><a href="#local-6989586621679090927"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><a name="local-6989586621679090928"><a href="#local-6989586621679090928"><span class="hs-identifier">limit</span></a></a><span> </span><a name="local-6989586621679090929"><a href="#local-6989586621679090929"><span class="hs-identifier">cid</span></a></a><span> </span><a name="local-6989586621679090930"><a href="#local-6989586621679090930"><span class="hs-identifier">docs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><a href="#local-6989586621679090926"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1245"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090929"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090930"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090928"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="Database.MongoDB.Query.html#nextBatch%27"><span class="hs-identifier hs-var">nextBatch'</span></a><span> </span><a href="#local-6989586621679090924"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090925"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090928"><span class="hs-identifier hs-var">limit</span></a><span> </span><a href="#local-6989586621679090929"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span>
</span><a name="line-1247"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679090927"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1248"></a><span>
</span><a name="line-1249"></a><span class="hs-identifier">nextBatch'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090251"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#BatchSize"><span class="hs-identifier hs-type">BatchSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#DelayedBatch"><span class="hs-identifier hs-type">DelayedBatch</span></a><span>
</span><a name="line-1250"></a><a name="nextBatch%27"><a href="Database.MongoDB.Query.html#nextBatch%27"><span class="hs-identifier">nextBatch'</span></a></a><span> </span><a name="local-6989586621679090931"><a href="#local-6989586621679090931"><span class="hs-identifier">fcol</span></a></a><span> </span><a name="local-6989586621679090932"><a href="#local-6989586621679090932"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090933"><a href="#local-6989586621679090933"><span class="hs-identifier">limit</span></a></a><span> </span><a name="local-6989586621679090934"><a href="#local-6989586621679090934"><span class="hs-identifier">cid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1251"></a><span>    </span><a name="local-6989586621679090937"><a href="#local-6989586621679090937"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1252"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#request"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679090937"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#GetMore"><span class="hs-identifier hs-var">GetMore</span></a><span> </span><a href="#local-6989586621679090931"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090935"><span class="hs-identifier hs-var">batchSize'</span></a><span> </span><a href="#local-6989586621679090934"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090936"><span class="hs-identifier hs-var">remLimit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1253"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679090935"><a href="#local-6989586621679090935"><span class="hs-identifier">batchSize'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679090936"><a href="#local-6989586621679090936"><span class="hs-identifier">remLimit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#batchSizeRemainingLimit"><span class="hs-identifier hs-var">batchSizeRemainingLimit</span></a><span> </span><a href="#local-6989586621679090932"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090933"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span class="hs-identifier">next</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090250"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090250"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span class="hs-comment">-- ^ Return next document in query result, or Nothing if finished.</span><span>
</span><a name="line-1257"></a><a name="next"><a href="Database.MongoDB.Query.html#next"><span class="hs-identifier">next</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-var">Cursor</span></a><span> </span><a name="local-6989586621679090938"><a href="#local-6989586621679090938"><span class="hs-identifier">fcol</span></a></a><span> </span><a name="local-6989586621679090939"><a href="#local-6989586621679090939"><span class="hs-identifier">batchSize</span></a></a><span> </span><a name="local-6989586621679090940"><a href="#local-6989586621679090940"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#modifyMVar"><span class="hs-identifier hs-var">modifyMVar</span></a><span> </span><a href="#local-6989586621679090940"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679090941"><span class="hs-identifier hs-var">nextState</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1258"></a><span>    </span><span class="hs-comment">-- Pre-fetch next batch promise from server when last one in current batch is returned.</span><span>
</span><a name="line-1259"></a><span>    </span><span class="hs-comment">-- nextState:: DelayedBatch -&gt; Action m (DelayedBatch, Maybe Document)</span><span>
</span><a name="line-1260"></a><span>    </span><a name="local-6989586621679090941"><a href="#local-6989586621679090941"><span class="hs-identifier">nextState</span></a></a><span> </span><a name="local-6989586621679090942"><a href="#local-6989586621679090942"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1261"></a><span>        </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><a name="local-6989586621679090943"><a href="#local-6989586621679090943"><span class="hs-identifier">mLimit</span></a></a><span> </span><a name="local-6989586621679090944"><a href="#local-6989586621679090944"><span class="hs-identifier">cid</span></a></a><span> </span><a name="local-6989586621679090945"><a href="#local-6989586621679090945"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fulfill%27"><span class="hs-identifier hs-var">fulfill'</span></a><span> </span><a href="#local-6989586621679090938"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090939"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090942"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1262"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090943"><span class="hs-identifier hs-var">mLimit</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-1263"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><span>          </span><span class="hs-keyword">else</span><span>
</span><a name="line-1265"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090945"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1266"></a><span>                </span><a name="local-6989586621679090946"><a href="#local-6989586621679090946"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679090947"><a href="#local-6989586621679090947"><span class="hs-identifier">docs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1267"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679090948"><a href="#local-6989586621679090948"><span class="hs-identifier">newLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1268"></a><span>                              </span><a name="local-6989586621679090949"><a href="#local-6989586621679090949"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679090943"><span class="hs-identifier hs-var">mLimit</span></a><span>
</span><a name="line-1269"></a><span>                              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679090949"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1270"></a><span>                    </span><a name="local-6989586621679090950"><a href="#local-6989586621679090950"><span class="hs-identifier">dBatch'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090947"><span class="hs-identifier hs-var">docs'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679090948"><span class="hs-identifier hs-var">newLimit</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621679090948"><span class="hs-identifier hs-var">newLimit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1271"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="Database.MongoDB.Query.html#nextBatch%27"><span class="hs-identifier hs-var">nextBatch'</span></a><span> </span><a href="#local-6989586621679090938"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090939"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090948"><span class="hs-identifier hs-var">newLimit</span></a><span> </span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span>
</span><a name="line-1272"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><a href="#local-6989586621679090948"><span class="hs-identifier hs-var">newLimit</span></a><span> </span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span> </span><a href="#local-6989586621679090947"><span class="hs-identifier hs-var">docs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>                    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090948"><span class="hs-identifier hs-var">newLimit</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1274"></a><span>                      </span><a name="local-6989586621679090951"><a href="#local-6989586621679090951"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1275"></a><span>                      </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-6989586621679090951"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier hs-var">KillCursors</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1276"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090950"><span class="hs-identifier hs-var">dBatch'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679090946"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1278"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- finished</span><span>
</span><a name="line-1279"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1280"></a><span>                      </span><a name="local-6989586621679090952"><a href="#local-6989586621679090952"><span class="hs-identifier">nb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#nextBatch%27"><span class="hs-identifier hs-var">nextBatch'</span></a><span> </span><a href="#local-6989586621679090938"><span class="hs-identifier hs-var">fcol</span></a><span> </span><a href="#local-6989586621679090939"><span class="hs-identifier hs-var">batchSize</span></a><span> </span><a href="#local-6989586621679090943"><span class="hs-identifier hs-var">mLimit</span></a><span> </span><a href="#local-6989586621679090944"><span class="hs-identifier hs-var">cid</span></a><span>
</span><a name="line-1281"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090952"><span class="hs-identifier hs-var">nb</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1282"></a><span>
</span><a name="line-1283"></a><span class="hs-identifier">nextN</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090249"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090249"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1284"></a><span class="hs-comment">-- ^ Return next N documents or less if end is reached</span><span>
</span><a name="line-1285"></a><a name="nextN"><a href="Database.MongoDB.Query.html#nextN"><span class="hs-identifier">nextN</span></a></a><span> </span><a name="local-6989586621679090953"><a href="#local-6989586621679090953"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679090954"><a href="#local-6989586621679090954"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621679090953"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#next"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621679090954"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1286"></a><span>
</span><a name="line-1287"></a><span class="hs-identifier">rest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090248"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090248"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1288"></a><span class="hs-comment">-- ^ Return remaining documents in query result</span><span>
</span><a name="line-1289"></a><a name="rest"><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier">rest</span></a></a><span> </span><a name="local-6989586621679090955"><a href="#local-6989586621679090955"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#loop"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#next"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621679090955"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>
</span><a name="line-1291"></a><span class="hs-identifier">closeCursor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090247"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090247"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><a name="closeCursor"><a href="Database.MongoDB.Query.html#closeCursor"><span class="hs-identifier">closeCursor</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-var">Cursor</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090956"><a href="#local-6989586621679090956"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#modifyMVar"><span class="hs-identifier hs-var">modifyMVar</span></a><span> </span><a href="#local-6989586621679090956"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679090957"><a href="#local-6989586621679090957"><span class="hs-identifier">dBatch</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1293"></a><span>    </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090958"><a href="#local-6989586621679090958"><span class="hs-identifier">cid</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><a href="#local-6989586621679090957"><span class="hs-identifier hs-var">dBatch</span></a><span>
</span><a name="line-1294"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090958"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1295"></a><span>      </span><a name="local-6989586621679090959"><a href="#local-6989586621679090959"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-identifier">mongoPipe</span><span>
</span><a name="line-1296"></a><span>      </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier hs-var">P</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-6989586621679090959"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier hs-var">KillCursors</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679090958"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1297"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span class="hs-identifier">isCursorClosed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090246"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090246"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1300"></a><a name="isCursorClosed"><a href="Database.MongoDB.Query.html#isCursorClosed"><span class="hs-identifier">isCursorClosed</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-var">Cursor</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090960"><a href="#local-6989586621679090960"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1301"></a><span>        </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679090961"><a href="#local-6989586621679090961"><span class="hs-identifier">cid</span></a></a><span> </span><a name="local-6989586621679090962"><a href="#local-6989586621679090962"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#liftDB"><span class="hs-identifier hs-var">liftDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#fulfill"><span class="hs-identifier hs-var">fulfill</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679090960"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1302"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090961"><span class="hs-identifier hs-var">cid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679090962"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span class="hs-comment">-- ** Aggregate</span><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-keyword">type</span><span> </span><a name="Pipeline"><a href="Database.MongoDB.Query.html#Pipeline"><span class="hs-identifier">Pipeline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1307"></a><span class="hs-comment">-- ^ The Aggregate Pipeline</span><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span class="hs-identifier">aggregate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090245"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090245"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1310"></a><span class="hs-comment">-- ^ Runs an aggregate and unpacks the result. See &lt;http://docs.mongodb.org/manual/core/aggregation/&gt; for details.</span><span>
</span><a name="line-1311"></a><a name="aggregate"><a href="Database.MongoDB.Query.html#aggregate"><span class="hs-identifier">aggregate</span></a></a><span> </span><a name="local-6989586621679090963"><a href="#local-6989586621679090963"><span class="hs-identifier">aColl</span></a></a><span> </span><a name="local-6989586621679090964"><a href="#local-6989586621679090964"><span class="hs-identifier">agg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1312"></a><span>    </span><a name="local-6989586621679090965"><a href="#local-6989586621679090965"><span class="hs-identifier">response</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;aggregate&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090963"><span class="hs-identifier hs-var">aColl</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;pipeline&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090964"><span class="hs-identifier hs-var">agg</span></a><span class="hs-special">]</span><span>
</span><a name="line-1313"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679090965"><span class="hs-identifier hs-var">response</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1314"></a><span>        </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;result&quot;</span><span> </span><a href="#local-6989586621679090965"><span class="hs-identifier hs-var">response</span></a><span>
</span><a name="line-1315"></a><span>        </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#AggregateFailure"><span class="hs-identifier hs-var">AggregateFailure</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;errmsg&quot;</span><span> </span><a href="#local-6989586621679090965"><span class="hs-identifier hs-var">response</span></a><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-comment">-- ** Group</span><span>
</span><a name="line-1318"></a><span>
</span><a name="line-1319"></a><span class="hs-comment">-- | Groups documents in collection by key then reduces (aggregates) each group</span><span>
</span><a name="line-1320"></a><span class="hs-keyword">data</span><span> </span><a name="Group"><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier">Group</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Group"><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier">Group</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1321"></a><span>    </span><a name="gColl"><a href="Database.MongoDB.Query.html#gColl"><span class="hs-identifier">gColl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span>
</span><a name="line-1322"></a><span>    </span><a name="gKey"><a href="Database.MongoDB.Query.html#gKey"><span class="hs-identifier">gKey</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#GroupKey"><span class="hs-identifier hs-type">GroupKey</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Fields to group by</span><span>
</span><a name="line-1323"></a><span>    </span><a name="gReduce"><a href="Database.MongoDB.Query.html#gReduce"><span class="hs-identifier">gReduce</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ @(doc, agg) -&gt; ()@. The reduce function reduces (aggregates) the objects iterated. Typical operations of a reduce function include summing and counting. It takes two arguments, the current document being iterated over and the aggregation value, and updates the aggregate value.</span><span>
</span><a name="line-1324"></a><span>    </span><a name="gInitial"><a href="Database.MongoDB.Query.html#gInitial"><span class="hs-identifier">gInitial</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ @agg@. Initial aggregation value supplied to reduce</span><span>
</span><a name="line-1325"></a><span>    </span><a name="gCond"><a href="Database.MongoDB.Query.html#gCond"><span class="hs-identifier">gCond</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Condition that must be true for a row to be considered. [] means always true.</span><span>
</span><a name="line-1326"></a><span>    </span><a name="gFinalize"><a href="Database.MongoDB.Query.html#gFinalize"><span class="hs-identifier">gFinalize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span>  </span><span class="hs-comment">-- ^ @agg -&gt; () | result@. An optional function to be run on each item in the result set just before the item is returned. Can either modify the item (e.g., add an average field given a count and a total) or return a replacement object (returning a new object with just _id and average fields).</span><span>
</span><a name="line-1327"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1328"></a><span>
</span><a name="line-1329"></a><span class="hs-keyword">data</span><span> </span><a name="GroupKey"><a href="Database.MongoDB.Query.html#GroupKey"><span class="hs-identifier">GroupKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Key"><a href="Database.MongoDB.Query.html#Key"><span class="hs-identifier">Key</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Label</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="KeyF"><a href="Database.MongoDB.Query.html#KeyF"><span class="hs-identifier">KeyF</span></a></a><span> </span><span class="hs-identifier hs-type">Javascript</span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1330"></a><span class="hs-comment">-- ^ Fields to group by, or function (@doc -&gt; key@) returning a &quot;key object&quot; to be used as the grouping key. Use KeyF instead of Key to specify a key that is not an existing member of the object (or, to access embedded members).</span><span>
</span><a name="line-1331"></a><span>
</span><a name="line-1332"></a><span class="hs-identifier">groupDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1333"></a><span class="hs-comment">-- ^ Translate Group data into expected document form</span><span>
</span><a name="line-1334"></a><a name="groupDocument"><a href="Database.MongoDB.Query.html#groupDocument"><span class="hs-identifier">groupDocument</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier hs-var">Group</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1335"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;finalize&quot;</span><span> </span><span class="hs-operator hs-var">=?</span><span> </span><a href="#local-6989586621679090971"><span class="hs-identifier hs-var">gFinalize</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1336"></a><span>    </span><span class="hs-string">&quot;ns&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090966"><span class="hs-identifier hs-var">gColl</span></a><span class="hs-special">,</span><span>
</span><a name="line-1337"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679090967"><span class="hs-identifier hs-var">gKey</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="Database.MongoDB.Query.html#Key"><span class="hs-identifier hs-var">Key</span></a><span> </span><a name="local-6989586621679090972"><a href="#local-6989586621679090972"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;key&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679090972"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">;</span><span> </span><a href="Database.MongoDB.Query.html#KeyF"><span class="hs-identifier hs-var">KeyF</span></a><span> </span><a name="local-6989586621679090973"><a href="#local-6989586621679090973"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;$keyf&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090973"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span>
</span><a name="line-1338"></a><span>    </span><span class="hs-string">&quot;$reduce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090968"><span class="hs-identifier hs-var">gReduce</span></a><span class="hs-special">,</span><span>
</span><a name="line-1339"></a><span>    </span><span class="hs-string">&quot;initial&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090969"><span class="hs-identifier hs-var">gInitial</span></a><span class="hs-special">,</span><span>
</span><a name="line-1340"></a><span>    </span><span class="hs-string">&quot;cond&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090970"><span class="hs-identifier hs-var">gCond</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1341"></a><span>
</span><a name="line-1342"></a><span class="hs-identifier">group</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090244"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Group"><span class="hs-identifier hs-type">Group</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090244"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-1343"></a><span class="hs-comment">-- ^ Execute group query and return resulting aggregate value for each distinct key</span><span>
</span><a name="line-1344"></a><a name="group"><a href="Database.MongoDB.Query.html#group"><span class="hs-identifier">group</span></a></a><span> </span><a name="local-6989586621679090974"><a href="#local-6989586621679090974"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;retval&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;group&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Query.html#groupDocument"><span class="hs-identifier hs-var">groupDocument</span></a><span> </span><a href="#local-6989586621679090974"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">]</span><span>
</span><a name="line-1345"></a><span>
</span><a name="line-1346"></a><span class="hs-comment">-- ** MapReduce</span><span>
</span><a name="line-1347"></a><span>
</span><a name="line-1348"></a><span class="hs-comment">-- | Maps every document in collection to a list of (key, value) pairs, then for each unique key reduces all its associated values to a single result. There are additional parameters that may be set to tweak this basic operation.</span><span>
</span><a name="line-1349"></a><span class="hs-comment">-- This implements the latest version of map-reduce that requires MongoDB 1.7.4 or greater. To map-reduce against an older server use runCommand directly as described in http://www.mongodb.org/display/DOCS/MapReduce.</span><span>
</span><a name="line-1350"></a><span class="hs-keyword">data</span><span> </span><a name="MapReduce"><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier">MapReduce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MapReduce"><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier">MapReduce</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1351"></a><span>    </span><a name="rColl"><a href="Database.MongoDB.Query.html#rColl"><span class="hs-identifier">rColl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span>
</span><a name="line-1352"></a><span>    </span><a name="rMap"><a href="Database.MongoDB.Query.html#rMap"><span class="hs-identifier">rMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MapFun"><span class="hs-identifier hs-type">MapFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-1353"></a><span>    </span><a name="rReduce"><a href="Database.MongoDB.Query.html#rReduce"><span class="hs-identifier">rReduce</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#ReduceFun"><span class="hs-identifier hs-type">ReduceFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-1354"></a><span>    </span><a name="rSelect"><a href="Database.MongoDB.Query.html#rSelect"><span class="hs-identifier">rSelect</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Selector"><span class="hs-identifier hs-type">Selector</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Operate on only those documents selected. Default is [] meaning all documents.</span><span>
</span><a name="line-1355"></a><span>    </span><a name="rSort"><a href="Database.MongoDB.Query.html#rSort"><span class="hs-identifier">rSort</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Default is [] meaning no sort</span><span>
</span><a name="line-1356"></a><span>    </span><a name="rLimit"><a href="Database.MongoDB.Query.html#rLimit"><span class="hs-identifier">rLimit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Limit"><span class="hs-identifier hs-type">Limit</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Default is 0 meaning no limit</span><span>
</span><a name="line-1357"></a><span>    </span><a name="rOut"><a href="Database.MongoDB.Query.html#rOut"><span class="hs-identifier">rOut</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MROut"><span class="hs-identifier hs-type">MROut</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Output to a collection with a certain merge policy. Default is no collection ('Inline'). Note, you don't want this default if your result set is large.</span><span>
</span><a name="line-1358"></a><span>    </span><a name="rFinalize"><a href="Database.MongoDB.Query.html#rFinalize"><span class="hs-identifier">rFinalize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#FinalizeFun"><span class="hs-identifier hs-type">FinalizeFun</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Function to apply to all the results when finished. Default is Nothing.</span><span>
</span><a name="line-1359"></a><span>    </span><a name="rScope"><a href="Database.MongoDB.Query.html#rScope"><span class="hs-identifier">rScope</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Variables (environment) that can be accessed from map/reduce/finalize. Default is [].</span><span>
</span><a name="line-1360"></a><span>    </span><a name="rVerbose"><a href="Database.MongoDB.Query.html#rVerbose"><span class="hs-identifier">rVerbose</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- ^ Provide statistics on job execution time. Default is False.</span><span>
</span><a name="line-1361"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1362"></a><span>
</span><a name="line-1363"></a><span class="hs-keyword">type</span><span> </span><a name="MapFun"><a href="Database.MongoDB.Query.html#MapFun"><span class="hs-identifier">MapFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span>
</span><a name="line-1364"></a><span class="hs-comment">-- ^ @() -&gt; void@. The map function references the variable @this@ to inspect the current object under consideration. The function must call @emit(key,value)@ at least once, but may be invoked any number of times, as may be appropriate.</span><span>
</span><a name="line-1365"></a><span>
</span><a name="line-1366"></a><span class="hs-keyword">type</span><span> </span><a name="ReduceFun"><a href="Database.MongoDB.Query.html#ReduceFun"><span class="hs-identifier">ReduceFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span>
</span><a name="line-1367"></a><span class="hs-comment">-- ^ @(key, [value]) -&gt; value@. The reduce function receives a key and an array of values and returns an aggregate result value. The MapReduce engine may invoke reduce functions iteratively; thus, these functions must be idempotent.  That is, the following must hold for your reduce function: @reduce(k, [reduce(k,vs)]) == reduce(k,vs)@. If you need to perform an operation only once, use a finalize function. The output of emit (the 2nd param) and reduce should be the same format to make iterative reduce possible.</span><span>
</span><a name="line-1368"></a><span>
</span><a name="line-1369"></a><span class="hs-keyword">type</span><span> </span><a name="FinalizeFun"><a href="Database.MongoDB.Query.html#FinalizeFun"><span class="hs-identifier">FinalizeFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span>
</span><a name="line-1370"></a><span class="hs-comment">-- ^ @(key, value) -&gt; final_value@. A finalize function may be run after reduction.  Such a function is optional and is not necessary for many map/reduce cases.  The finalize function takes a key and a value, and returns a finalized value.</span><span>
</span><a name="line-1371"></a><span>
</span><a name="line-1372"></a><span class="hs-keyword">data</span><span> </span><a name="MROut"><a href="Database.MongoDB.Query.html#MROut"><span class="hs-identifier">MROut</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1373"></a><span>      </span><a name="Inline"><a href="Database.MongoDB.Query.html#Inline"><span class="hs-identifier">Inline</span></a></a><span> </span><span class="hs-comment">-- ^ Return results directly instead of writing them to an output collection. Results must fit within 16MB limit of a single document</span><span>
</span><a name="line-1374"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Output"><a href="Database.MongoDB.Query.html#Output"><span class="hs-identifier">Output</span></a></a><span> </span><a href="Database.MongoDB.Query.html#MRMerge"><span class="hs-identifier hs-type">MRMerge</span></a><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Write results to given collection, in other database if specified. Follow merge policy when entry already exists</span><span>
</span><a name="line-1375"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>
</span><a name="line-1377"></a><span class="hs-keyword">data</span><span> </span><a name="MRMerge"><a href="Database.MongoDB.Query.html#MRMerge"><span class="hs-identifier">MRMerge</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1378"></a><span>      </span><a name="Replace"><a href="Database.MongoDB.Query.html#Replace"><span class="hs-identifier">Replace</span></a></a><span>  </span><span class="hs-comment">-- ^ Clear all old data and replace it with new data</span><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Merge"><a href="Database.MongoDB.Query.html#Merge"><span class="hs-identifier">Merge</span></a></a><span>  </span><span class="hs-comment">-- ^ Leave old data but overwrite entries with the same key with new data</span><span>
</span><a name="line-1380"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Reduce"><a href="Database.MongoDB.Query.html#Reduce"><span class="hs-identifier">Reduce</span></a></a><span>  </span><span class="hs-comment">-- ^ Leave old data but combine entries with the same key via MR's reduce function</span><span>
</span><a name="line-1381"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1382"></a><span>
</span><a name="line-1383"></a><span class="hs-keyword">type</span><span> </span><a name="MRResult"><a href="Database.MongoDB.Query.html#MRResult"><span class="hs-identifier">MRResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1384"></a><span class="hs-comment">-- ^ Result of running a MapReduce has some stats besides the output. See http://www.mongodb.org/display/DOCS/MapReduce#MapReduce-Resultobject</span><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span class="hs-identifier">mrDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-type">MapReduce</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1387"></a><span class="hs-comment">-- ^ Translate MapReduce data into expected document form</span><span>
</span><a name="line-1388"></a><a name="mrDocument"><a href="Database.MongoDB.Query.html#mrDocument"><span class="hs-identifier">mrDocument</span></a></a><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-var">MapReduce</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1389"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;mapreduce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090975"><span class="hs-identifier hs-var">rColl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-1390"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;out&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Query.html#mrOutDoc"><span class="hs-identifier hs-var">mrOutDoc</span></a><span> </span><a href="#local-6989586621679090981"><span class="hs-identifier hs-var">rOut</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-1391"></a><span>    </span><span class="hs-special">(</span><span class="hs-string">&quot;finalize&quot;</span><span> </span><span class="hs-operator hs-var">=?</span><span> </span><a href="#local-6989586621679090982"><span class="hs-identifier hs-var">rFinalize</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1392"></a><span>    </span><span class="hs-string">&quot;map&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090976"><span class="hs-identifier hs-var">rMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-1393"></a><span>    </span><span class="hs-string">&quot;reduce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090977"><span class="hs-identifier hs-var">rReduce</span></a><span class="hs-special">,</span><span>
</span><a name="line-1394"></a><span>    </span><span class="hs-string">&quot;query&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090978"><span class="hs-identifier hs-var">rSelect</span></a><span class="hs-special">,</span><span>
</span><a name="line-1395"></a><span>    </span><span class="hs-string">&quot;sort&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090979"><span class="hs-identifier hs-var">rSort</span></a><span class="hs-special">,</span><span>
</span><a name="line-1396"></a><span>    </span><span class="hs-string">&quot;limit&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679090980"><span class="hs-identifier hs-var">rLimit</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1397"></a><span>    </span><span class="hs-string">&quot;scope&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090983"><span class="hs-identifier hs-var">rScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-1398"></a><span>    </span><span class="hs-string">&quot;verbose&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090984"><span class="hs-identifier hs-var">rVerbose</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span class="hs-identifier">mrOutDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#MROut"><span class="hs-identifier hs-type">MROut</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1401"></a><span class="hs-comment">-- ^ Translate MROut into expected document form</span><span>
</span><a name="line-1402"></a><a name="mrOutDoc"><a href="Database.MongoDB.Query.html#mrOutDoc"><span class="hs-identifier">mrOutDoc</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Inline"><span class="hs-identifier hs-var">Inline</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;inline&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1403"></a><span class="hs-identifier">mrOutDoc</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Output"><span class="hs-identifier hs-var">Output</span></a><span> </span><a name="local-6989586621679090985"><a href="#local-6989586621679090985"><span class="hs-identifier">mrMerge</span></a></a><span> </span><a name="local-6989586621679090986"><a href="#local-6989586621679090986"><span class="hs-identifier">coll</span></a></a><span> </span><a name="local-6989586621679090987"><a href="#local-6989586621679090987"><span class="hs-identifier">mDB</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090988"><span class="hs-identifier hs-var">mergeName</span></a><span> </span><a href="#local-6989586621679090985"><span class="hs-identifier hs-var">mrMerge</span></a><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090986"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679090989"><span class="hs-identifier hs-var">mdb</span></a><span> </span><a href="#local-6989586621679090987"><span class="hs-identifier hs-var">mDB</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1404"></a><span>    </span><a name="local-6989586621679090988"><a href="#local-6989586621679090988"><span class="hs-identifier">mergeName</span></a></a><span> </span><a href="Database.MongoDB.Query.html#Replace"><span class="hs-identifier hs-var">Replace</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;replace&quot;</span><span>
</span><a name="line-1405"></a><span>    </span><span class="hs-identifier">mergeName</span><span> </span><a href="Database.MongoDB.Query.html#Merge"><span class="hs-identifier hs-var">Merge</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;merge&quot;</span><span>
</span><a name="line-1406"></a><span>    </span><span class="hs-identifier">mergeName</span><span> </span><a href="Database.MongoDB.Query.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;reduce&quot;</span><span>
</span><a name="line-1407"></a><span>    </span><a name="local-6989586621679090989"><a href="#local-6989586621679090989"><span class="hs-identifier">mdb</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1408"></a><span>    </span><span class="hs-identifier">mdb</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090990"><a href="#local-6989586621679090990"><span class="hs-identifier">db</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;db&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679090990"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">]</span><span>
</span><a name="line-1409"></a><span>
</span><a name="line-1410"></a><span class="hs-identifier">mapReduce</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#MapFun"><span class="hs-identifier hs-type">MapFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#ReduceFun"><span class="hs-identifier hs-type">ReduceFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-type">MapReduce</span></a><span>
</span><a name="line-1411"></a><span class="hs-comment">-- ^ MapReduce on collection with given map and reduce functions. Remaining attributes are set to their defaults, which are stated in their comments.</span><span>
</span><a name="line-1412"></a><a name="mapReduce"><a href="Database.MongoDB.Query.html#mapReduce"><span class="hs-identifier">mapReduce</span></a></a><span> </span><a name="local-6989586621679090991"><a href="#local-6989586621679090991"><span class="hs-identifier">col</span></a></a><span> </span><a name="local-6989586621679090992"><a href="#local-6989586621679090992"><span class="hs-identifier">map'</span></a></a><span> </span><a name="local-6989586621679090993"><a href="#local-6989586621679090993"><span class="hs-identifier">red</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-var">MapReduce</span></a><span> </span><a href="#local-6989586621679090991"><span class="hs-identifier hs-var">col</span></a><span> </span><a href="#local-6989586621679090992"><span class="hs-identifier hs-var">map'</span></a><span> </span><a href="#local-6989586621679090993"><span class="hs-identifier hs-var">red</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-number">0</span><span> </span><a href="Database.MongoDB.Query.html#Inline"><span class="hs-identifier hs-var">Inline</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1413"></a><span>
</span><a name="line-1414"></a><span class="hs-identifier">runMR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090243"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-type">MapReduce</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090243"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#Cursor"><span class="hs-identifier hs-type">Cursor</span></a><span>
</span><a name="line-1415"></a><span class="hs-comment">-- ^ Run MapReduce and return cursor of results. Error if map/reduce fails (because of bad Javascript)</span><span>
</span><a name="line-1416"></a><a name="runMR"><a href="Database.MongoDB.Query.html#runMR"><span class="hs-identifier">runMR</span></a></a><span> </span><a name="local-6989586621679090994"><a href="#local-6989586621679090994"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1417"></a><span>    </span><a name="local-6989586621679090995"><a href="#local-6989586621679090995"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runMR%27"><span class="hs-identifier hs-var">runMR'</span></a><span> </span><a href="#local-6989586621679090994"><span class="hs-identifier hs-var">mr</span></a><span>
</span><a name="line-1418"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">look</span><span> </span><span class="hs-string">&quot;result&quot;</span><span> </span><a href="#local-6989586621679090995"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1419"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">String</span><span> </span><a name="local-6989586621679090996"><a href="#local-6989586621679090996"><span class="hs-identifier">coll</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679090996"><span class="hs-identifier hs-var">coll</span></a><span>
</span><a name="line-1420"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Doc</span><span> </span><a name="local-6989586621679090997"><a href="#local-6989586621679090997"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;db&quot;</span><span> </span><a href="#local-6989586621679090997"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;collection&quot;</span><span> </span><a href="#local-6989586621679090997"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1421"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679090998"><a href="#local-6989586621679090998"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;unexpected map-reduce result field: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090998"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1422"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#newCursor"><span class="hs-identifier hs-var">newCursor</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#Batch"><span class="hs-identifier hs-var">Batch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;results&quot;</span><span> </span><a href="#local-6989586621679090995"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1423"></a><span>
</span><a name="line-1424"></a><span class="hs-identifier">runMR'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090242"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#MapReduce"><span class="hs-identifier hs-type">MapReduce</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090242"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Query.html#MRResult"><span class="hs-identifier hs-type">MRResult</span></a><span>
</span><a name="line-1425"></a><span class="hs-comment">-- ^ Run MapReduce and return a MR result document containing stats and the results if Inlined. Error if the map/reduce failed (because of bad Javascript).</span><span>
</span><a name="line-1426"></a><a name="runMR%27"><a href="Database.MongoDB.Query.html#runMR%27"><span class="hs-identifier">runMR'</span></a></a><span> </span><a name="local-6989586621679090999"><a href="#local-6989586621679090999"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1427"></a><span>    </span><a name="local-6989586621679091000"><a href="#local-6989586621679091000"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#mrDocument"><span class="hs-identifier hs-var">mrDocument</span></a><span> </span><a href="#local-6989586621679090999"><span class="hs-identifier hs-var">mr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1428"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679091000"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679091000"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;mapReduce error:\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679091000"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\nin:\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679090999"><span class="hs-identifier hs-var">mr</span></a><span>
</span><a name="line-1429"></a><span>
</span><a name="line-1430"></a><span class="hs-comment">-- * Command</span><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><span class="hs-keyword">type</span><span> </span><a name="Command"><a href="Database.MongoDB.Query.html#Command"><span class="hs-identifier">Command</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1433"></a><span class="hs-comment">-- ^ A command is a special query or action against the database. See &lt;http://www.mongodb.org/display/DOCS/Commands&gt; for details.</span><span>
</span><a name="line-1434"></a><span>
</span><a name="line-1435"></a><span class="hs-identifier">runCommand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090241"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Command"><span class="hs-identifier hs-type">Command</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090241"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1436"></a><span class="hs-comment">-- ^ Run command against the database and return its result</span><span>
</span><a name="line-1437"></a><a name="runCommand"><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier">runCommand</span></a></a><span> </span><a name="local-6989586621679091001"><a href="#local-6989586621679091001"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679091002"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#query"><span class="hs-identifier hs-var">query</span></a><span> </span><a href="#local-6989586621679091001"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-string">&quot;$cmd&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1438"></a><span>    </span><a name="local-6989586621679091002"><a href="#local-6989586621679091002"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Nothing returned for command: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679091001"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-1439"></a><span>
</span><a name="line-1440"></a><span class="hs-identifier">runCommand1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090240"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090240"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-1441"></a><span class="hs-comment">-- ^ @runCommand1 foo = runCommand [foo =: 1]@</span><span>
</span><a name="line-1442"></a><a name="runCommand1"><a href="Database.MongoDB.Query.html#runCommand1"><span class="hs-identifier">runCommand1</span></a></a><span> </span><a name="local-6989586621679091003"><a href="#local-6989586621679091003"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679091003"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1443"></a><span>
</span><a name="line-1444"></a><span class="hs-identifier">eval</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679090238"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Val</span><span> </span><a href="#local-6989586621679090239"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Javascript</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679090238"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679090239"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-1445"></a><span class="hs-comment">-- ^ Run code on server</span><span>
</span><a name="line-1446"></a><a name="eval"><a href="Database.MongoDB.Query.html#eval"><span class="hs-identifier">eval</span></a></a><span> </span><a name="local-6989586621679091004"><a href="#local-6989586621679091004"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;retval&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;$eval&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679091004"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">]</span><span>
</span><a name="line-1447"></a><span>
</span><a name="line-1448"></a><span class="hs-identifier">modifyMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="#local-6989586621679090236"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090236"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679090236"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679090237"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679090237"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1449"></a><a name="modifyMVar"><a href="Database.MongoDB.Query.html#modifyMVar"><span class="hs-identifier">modifyMVar</span></a></a><span> </span><a name="local-6989586621679091005"><a href="#local-6989586621679091005"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679091006"><a href="#local-6989586621679091006"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1450"></a><span>  </span><a name="local-6989586621679091007"><a href="#local-6989586621679091007"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-1451"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621679091005"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679091008"><a href="#local-6989586621679091008"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679091006"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679091008"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679091007"><span class="hs-identifier hs-var">ctx</span></a><span class="hs-special">)</span><span>
</span><a name="line-1452"></a><span>
</span><a name="line-1453"></a><span class="hs-identifier">mkWeakMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="#local-6989586621679090235"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Weak</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="#local-6989586621679090235"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1454"></a><a name="mkWeakMVar"><a href="Database.MongoDB.Query.html#mkWeakMVar"><span class="hs-identifier">mkWeakMVar</span></a></a><span> </span><a name="local-6989586621679091009"><a href="#local-6989586621679091009"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679091010"><a href="#local-6989586621679091010"><span class="hs-identifier">closing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1455"></a><span>  </span><a name="local-6989586621679091011"><a href="#local-6989586621679091011"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-1456"></a><span class="hs-cpp">#if MIN_VERSION_base(4,6,0)</span><span>
</span><a name="line-1457"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">MV</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mkWeakMVar</span><span> </span><a href="#local-6989586621679091009"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679091010"><span class="hs-identifier hs-var">closing</span></a><span> </span><a href="#local-6989586621679091011"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-1458"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-1459"></a><span>  </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">MV</span><span class="hs-operator">.</span><span class="hs-identifier">addMVarFinalizer</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-identifier">closing</span><span> </span><span class="hs-identifier">ctx</span><span>
</span><a name="line-1460"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-1461"></a><span>
</span><a name="line-1462"></a><span>
</span><a name="line-1463"></a><span class="hs-comment">{- Authors: Tony Hannan &lt;tony@10gen.com&gt;
   Copyright 2011 10gen Inc.
   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. -}</span><span>
</span><a name="line-1466"></a></pre></body></html>