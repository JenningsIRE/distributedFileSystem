<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Connect to a single server or a replica set of servers</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP, OverloadedStrings, ScopedTypeVariables, TupleSections #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-cpp">#if (__GLASGOW_HASKELL__ &gt;= 706)</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RecursiveDo #-}</span><span>
</span><a name="line-7"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE DoRec #-}</span><span>
</span><a name="line-9"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Connection</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-comment">-- * Util</span><span>
</span><a name="line-13"></a><span>    </span><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier hs-type">Secs</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">-- * Connection</span><span>
</span><a name="line-15"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier hs-var">isClosed</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>    </span><span class="hs-comment">-- * Server</span><span>
</span><a name="line-17"></a><span>    </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PortID</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#defaultPort"><span class="hs-identifier hs-var">defaultPort</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#host"><span class="hs-identifier hs-var">host</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier hs-var">showHostPort</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#readHostPort"><span class="hs-identifier hs-var">readHostPort</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><a href="Database.MongoDB.Connection.html#readHostPortM"><span class="hs-identifier hs-var">readHostPortM</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#globalConnectTimeout"><span class="hs-identifier hs-var">globalConnectTimeout</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#connect"><span class="hs-identifier hs-var">connect</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#connect%27"><span class="hs-identifier hs-var">connect'</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><span class="hs-comment">-- * Replica Set</span><span>
</span><a name="line-20"></a><span>    </span><a href="Database.MongoDB.Connection.html#ReplicaSetName"><span class="hs-identifier hs-type">ReplicaSetName</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#openReplicaSet"><span class="hs-identifier hs-var">openReplicaSet</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#openReplicaSet%27"><span class="hs-identifier hs-var">openReplicaSet'</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>    </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#primary"><span class="hs-identifier hs-var">primary</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#secondaryOk"><span class="hs-identifier hs-var">secondaryOk</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#routedHost"><span class="hs-identifier hs-var">routedHost</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#closeReplicaSet"><span class="hs-identifier hs-var">closeReplicaSet</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#replSetName"><span class="hs-identifier hs-var">replSetName</span></a><span>
</span><a name="line-22"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intersect</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">delete</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,8,0)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forM_</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HostName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PortID</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">connectTo</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Timeout</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">timeout</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">ParserCombinators</span><span class="hs-operator">.</span><span class="hs-identifier">Parsec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parse</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">many1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">letter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">digit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">char</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eof</span><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>                                      </span><span class="hs-identifier hs-var">spaces</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">try</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">List</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runIdentity</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">throwError</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                                       </span><span class="hs-identifier hs-var">readMVar</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">=:</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipe"><span class="hs-identifier hs-var">newPipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier hs-var">isClosed</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Util.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#untilSuccess"><span class="hs-identifier hs-var">untilSuccess</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>                                       </span><a href="Database.MongoDB.Internal.Util.html#updateAssocs"><span class="hs-identifier hs-var">updateAssocs</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#shuffle"><span class="hs-identifier hs-var">shuffle</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#mergesortM"><span class="hs-identifier hs-var">mergesortM</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Query.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Command"><span class="hs-identifier hs-type">Command</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Failure"><span class="hs-identifier hs-type">Failure</span></a><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                              </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier hs-var">retrieveServerData</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">adminCommand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Command"><span class="hs-identifier hs-type">Command</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- ^ Run command against admin database on server connected to pipe. Fail if connection fails.</span><span>
</span><a name="line-59"></a><a name="adminCommand"><a href="Database.MongoDB.Connection.html#adminCommand"><span class="hs-identifier">adminCommand</span></a></a><span> </span><a name="local-6989586621679104630"><a href="#local-6989586621679104630"><span class="hs-identifier">cmd</span></a></a><span> </span><a name="local-6989586621679104631"><a href="#local-6989586621679104631"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-60"></a><span>    </span><a href="Database.MongoDB.Internal.Util.html#liftIOE"><span class="hs-identifier hs-var">liftIOE</span></a><span> </span><a href="#local-6989586621679104632"><span class="hs-identifier hs-var">failureToIOError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span> </span><a href="#local-6989586621679104631"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span> </span><span class="hs-string">&quot;admin&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><a href="#local-6989586621679104630"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-61"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-62"></a><span>    </span><a name="local-6989586621679104632"><a href="#local-6989586621679104632"><span class="hs-identifier">failureToIOError</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#ConnectionFailure"><span class="hs-identifier hs-var">ConnectionFailure</span></a><span> </span><a name="local-6989586621679104633"><a href="#local-6989586621679104633"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679104633"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-identifier">failureToIOError</span><span> </span><a name="local-6989586621679104634"><a href="#local-6989586621679104634"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679104634"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- * Host</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">data</span><span> </span><a name="Host"><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier">Host</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Host"><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier">Host</span></a></a><span> </span><span class="hs-identifier hs-type">HostName</span><span> </span><span class="hs-identifier hs-type">PortID</span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-identifier">defaultPort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PortID</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- ^ Default MongoDB port = 27017</span><span>
</span><a name="line-71"></a><a name="defaultPort"><a href="Database.MongoDB.Connection.html#defaultPort"><span class="hs-identifier">defaultPort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PortNumber</span><span> </span><span class="hs-number">27017</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">host</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HostName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- ^ Host on 'defaultPort'</span><span>
</span><a name="line-75"></a><a name="host"><a href="Database.MongoDB.Connection.html#host"><span class="hs-identifier">host</span></a></a><span> </span><a name="local-6989586621679104635"><a href="#local-6989586621679104635"><span class="hs-identifier">hostname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-var">Host</span></a><span> </span><a href="#local-6989586621679104635"><span class="hs-identifier hs-var">hostname</span></a><span> </span><a href="Database.MongoDB.Connection.html#defaultPort"><span class="hs-identifier hs-var">defaultPort</span></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">showHostPort</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- ^ Display host as \&quot;host:port\&quot;</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- TODO: Distinguish Service and UnixSocket port</span><span>
</span><a name="line-80"></a><a name="showHostPort"><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier">showHostPort</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-var">Host</span></a><span> </span><a name="local-6989586621679104636"><a href="#local-6989586621679104636"><span class="hs-identifier">hostname</span></a></a><span> </span><a name="local-6989586621679104637"><a href="#local-6989586621679104637"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679104636"><span class="hs-identifier hs-var">hostname</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;:&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679104638"><span class="hs-identifier hs-var">portname</span></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621679104638"><a href="#local-6989586621679104638"><span class="hs-identifier">portname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679104637"><span class="hs-identifier hs-var">port</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>        </span><span class="hs-identifier hs-var">Service</span><span> </span><a name="local-6989586621679104639"><a href="#local-6989586621679104639"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104639"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-identifier hs-var">PortNumber</span><span> </span><a name="local-6989586621679104640"><a href="#local-6989586621679104640"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679104640"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-84"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS) &amp;&amp; !defined(cygwin32_HOST_OS) &amp;&amp; !defined(_WIN32)</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">UnixSocket</span><span> </span><a name="local-6989586621679104641"><a href="#local-6989586621679104641"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104641"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-86"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-identifier">readHostPortM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679104629"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104629"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- ^ Read string \&quot;hostname:port\&quot; as @Host hosthame (PortNumber port)@ or \&quot;hostname\&quot; as @host hostname@ (default port). Fail if string does not match either syntax.</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- TODO: handle Service and UnixSocket port</span><span>
</span><a name="line-91"></a><a name="readHostPortM"><a href="Database.MongoDB.Connection.html#readHostPortM"><span class="hs-identifier">readHostPortM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">parse</span><span> </span><a href="#local-6989586621679104643"><span class="hs-identifier hs-var">parser</span></a><span> </span><span class="hs-string">&quot;readHostPort&quot;</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-92"></a><span>    </span><a name="local-6989586621679104642"><a href="#local-6989586621679104642"><span class="hs-identifier">hostname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">letter</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">digit</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'-'</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'.'</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>    </span><a name="local-6989586621679104643"><a href="#local-6989586621679104643"><span class="hs-identifier">parser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-identifier hs-var">spaces</span><span>
</span><a name="line-95"></a><span>        </span><a name="local-6989586621679105257"><a href="#local-6989586621679105257"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679104642"><span class="hs-identifier hs-var">hostname</span></a><span>
</span><a name="line-96"></a><span>        </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">spaces</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">eof</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#host"><span class="hs-identifier hs-var">host</span></a><span> </span><a href="#local-6989586621679105257"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-97"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">':'</span><span>
</span><a name="line-98"></a><span>            </span><a name="local-6989586621679105278"><a href="#local-6989586621679105278"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">many1</span><span> </span><span class="hs-identifier hs-var">digit</span><span>
</span><a name="line-99"></a><span>            </span><span class="hs-identifier hs-var">spaces</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">eof</span><span>
</span><a name="line-100"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-var">Host</span></a><span> </span><a href="#local-6989586621679105257"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PortNumber</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679105278"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-identifier">readHostPort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span>
</span><a name="line-103"></a><span class="hs-comment">-- ^ Read string \&quot;hostname:port\&quot; as @Host hostname (PortNumber port)@ or \&quot;hostname\&quot; as @host hostname@ (default port). Error if string does not match either syntax.</span><span>
</span><a name="line-104"></a><a name="readHostPort"><a href="Database.MongoDB.Connection.html#readHostPort"><span class="hs-identifier">readHostPort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runIdentity</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.MongoDB.Connection.html#readHostPortM"><span class="hs-identifier hs-var">readHostPortM</span></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-keyword">type</span><span> </span><a name="Secs"><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier">Secs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">globalConnectTimeout</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier hs-type">Secs</span></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- ^ 'connect' (and 'openReplicaSet') fails if it can't connect within this many seconds (default is 6 seconds). Use 'connect\'' (and 'openReplicaSet\'') if you want to ignore this global and specify your own timeout. Note, this timeout only applies to initial connection establishment, not when reading/writing to the connection.</span><span>
</span><a name="line-110"></a><a name="globalConnectTimeout"><a href="Database.MongoDB.Connection.html#globalConnectTimeout"><span class="hs-identifier">globalConnectTimeout</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">6</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span class="hs-pragma">{-# NOINLINE globalConnectTimeout #-}</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">connect</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- ^ Connect to Host returning pipelined TCP connection. Throw IOError if connection refused or no response within 'globalConnectTimeout'.</span><span>
</span><a name="line-115"></a><a name="connect"><a href="Database.MongoDB.Connection.html#connect"><span class="hs-identifier">connect</span></a></a><span> </span><a name="local-6989586621679105279"><a href="#local-6989586621679105279"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Database.MongoDB.Connection.html#globalConnectTimeout"><span class="hs-identifier hs-var">globalConnectTimeout</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Database.MongoDB.Connection.html#connect%27"><span class="hs-identifier hs-var">connect'</span></a><span> </span><a href="#local-6989586621679105279"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">connect'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier hs-type">Secs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- ^ Connect to Host returning pipelined TCP connection. Throw IOError if connection refused or no response within given number of seconds.</span><span>
</span><a name="line-119"></a><a name="connect%27"><a href="Database.MongoDB.Connection.html#connect%27"><span class="hs-identifier">connect'</span></a></a><span> </span><a name="local-6989586621679105280"><a href="#local-6989586621679105280"><span class="hs-identifier">timeoutSecs</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-var">Host</span></a><span> </span><a name="local-6989586621679105281"><a href="#local-6989586621679105281"><span class="hs-identifier">hostname</span></a></a><span> </span><a name="local-6989586621679105282"><a href="#local-6989586621679105282"><span class="hs-identifier">port</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>    </span><a name="local-6989586621679105283"><a href="#local-6989586621679105283"><span class="hs-identifier">mh</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">timeout</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">round</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679105280"><span class="hs-identifier hs-var">timeoutSecs</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">1000000</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">connectTo</span><span> </span><a href="#local-6989586621679105281"><span class="hs-identifier hs-var">hostname</span></a><span> </span><a href="#local-6989586621679105282"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>    </span><a name="local-6989586621679105284"><a href="#local-6989586621679105284"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-string">&quot;connect timed out&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679105283"><span class="hs-identifier hs-var">mh</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">rec</span><span>
</span><a name="line-123"></a><span>      </span><a name="local-6989586621679105285"><a href="#local-6989586621679105285"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipe"><span class="hs-identifier hs-var">newPipe</span></a><span> </span><a href="#local-6989586621679105286"><span class="hs-identifier hs-var">sd</span></a><span> </span><a href="#local-6989586621679105284"><span class="hs-identifier hs-var">handle</span></a><span>
</span><a name="line-124"></a><span>      </span><a name="local-6989586621679105286"><a href="#local-6989586621679105286"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span> </span><a href="#local-6989586621679105285"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span> </span><span class="hs-string">&quot;admin&quot;</span><span> </span><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier hs-var">retrieveServerData</span></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679105285"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- * Replica Set</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">type</span><span> </span><a name="ReplicaSetName"><a href="Database.MongoDB.Connection.html#ReplicaSetName"><span class="hs-identifier">ReplicaSetName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- | Maintains a connection (created on demand) to each server in the named replica set</span><span>
</span><a name="line-132"></a><span class="hs-keyword">data</span><span> </span><a name="ReplicaSet"><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier">ReplicaSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ReplicaSet"><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier">ReplicaSet</span></a></a><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSetName"><span class="hs-identifier hs-type">ReplicaSetName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier hs-type">Secs</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">replSetName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- ^ name of connected replica set</span><span>
</span><a name="line-136"></a><a name="replSetName"><a href="Database.MongoDB.Connection.html#replSetName"><span class="hs-identifier">replSetName</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><a name="local-6989586621679105287"><a href="#local-6989586621679105287"><span class="hs-identifier">rsName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679105287"><span class="hs-identifier hs-var">rsName</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">openReplicaSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSetName"><span class="hs-identifier hs-type">ReplicaSetName</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- ^ Open connections (on demand) to servers in replica set. Supplied hosts is seed list. At least one of them must be a live member of the named replica set, otherwise fail. The value of 'globalConnectTimeout' at the time of this call is the timeout used for future member connect attempts. To use your own value call 'openReplicaSet\'' instead.</span><span>
</span><a name="line-140"></a><a name="openReplicaSet"><a href="Database.MongoDB.Connection.html#openReplicaSet"><span class="hs-identifier">openReplicaSet</span></a></a><span> </span><a name="local-6989586621679105288"><a href="#local-6989586621679105288"><span class="hs-identifier">rsSeed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Database.MongoDB.Connection.html#globalConnectTimeout"><span class="hs-identifier hs-var">globalConnectTimeout</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Database.MongoDB.Connection.html#openReplicaSet%27"><span class="hs-identifier hs-var">openReplicaSet'</span></a><span> </span><a href="#local-6989586621679105288"><span class="hs-identifier hs-var">rsSeed</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">openReplicaSet'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#Secs"><span class="hs-identifier hs-type">Secs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSetName"><span class="hs-identifier hs-type">ReplicaSetName</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- ^ Open connections (on demand) to servers in replica set. Supplied hosts is seed list. At least one of them must be a live member of the named replica set, otherwise fail. Supplied seconds timeout is used for connect attempts to members.</span><span>
</span><a name="line-144"></a><a name="openReplicaSet%27"><a href="Database.MongoDB.Connection.html#openReplicaSet%27"><span class="hs-identifier">openReplicaSet'</span></a></a><span> </span><a name="local-6989586621679105289"><a href="#local-6989586621679105289"><span class="hs-identifier">timeoutSecs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679105290"><a href="#local-6989586621679105290"><span class="hs-identifier">rsName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679105291"><a href="#local-6989586621679105291"><span class="hs-identifier">seedList</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-145"></a><span>    </span><a name="local-6989586621679105292"><a href="#local-6989586621679105292"><span class="hs-identifier">vMembers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105291"><span class="hs-identifier hs-var">seedList</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679105293"><a href="#local-6989586621679105293"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><a href="#local-6989586621679105290"><span class="hs-identifier hs-var">rsName</span></a><span> </span><a href="#local-6989586621679105292"><span class="hs-identifier hs-var">vMembers</span></a><span> </span><a href="#local-6989586621679105289"><span class="hs-identifier hs-var">timeoutSecs</span></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#updateMembers"><span class="hs-identifier hs-var">updateMembers</span></a><span> </span><a href="#local-6989586621679105293"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679105293"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">closeReplicaSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- ^ Close all connections to replica set</span><span>
</span><a name="line-152"></a><a name="closeReplicaSet"><a href="Database.MongoDB.Connection.html#closeReplicaSet"><span class="hs-identifier">closeReplicaSet</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679105294"><a href="#local-6989586621679105294"><span class="hs-identifier">vMembers</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679105294"><span class="hs-identifier hs-var">vMembers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-identifier">primary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- ^ Return connection to current primary of replica set. Fail if no primary available.</span><span>
</span><a name="line-156"></a><a name="primary"><a href="Database.MongoDB.Connection.html#primary"><span class="hs-identifier">primary</span></a></a><span> </span><a name="local-6989586621679105295"><a href="#local-6989586621679105295"><span class="hs-identifier">rs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><a name="local-6989586621679105296"><a href="#local-6989586621679105296"><span class="hs-identifier">rsName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-157"></a><span>    </span><a name="local-6989586621679105297"><a href="#local-6989586621679105297"><span class="hs-identifier">mHost</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#statedPrimary"><span class="hs-identifier hs-var">statedPrimary</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#updateMembers"><span class="hs-identifier hs-var">updateMembers</span></a><span> </span><a href="#local-6989586621679105295"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-158"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679105297"><span class="hs-identifier hs-var">mHost</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-159"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679105298"><a href="#local-6989586621679105298"><span class="hs-identifier">host'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#connection"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-6989586621679105295"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679105298"><span class="hs-identifier hs-var">host'</span></a><span>
</span><a name="line-160"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;replica set &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679105296"><span class="hs-identifier hs-var">rsName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; has no primary&quot;</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">secondaryOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- ^ Return connection to a random secondary, or primary if no secondaries available.</span><span>
</span><a name="line-164"></a><a name="secondaryOk"><a href="Database.MongoDB.Connection.html#secondaryOk"><span class="hs-identifier">secondaryOk</span></a></a><span> </span><a name="local-6989586621679105299"><a href="#local-6989586621679105299"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-165"></a><span>    </span><a name="local-6989586621679105300"><a href="#local-6989586621679105300"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#updateMembers"><span class="hs-identifier hs-var">updateMembers</span></a><span> </span><a href="#local-6989586621679105299"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-166"></a><span>    </span><a name="local-6989586621679105301"><a href="#local-6989586621679105301"><span class="hs-identifier">hosts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Util.html#shuffle"><span class="hs-identifier hs-var">shuffle</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#possibleHosts"><span class="hs-identifier hs-var">possibleHosts</span></a><span> </span><a href="#local-6989586621679105300"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679105302"><a href="#local-6989586621679105302"><span class="hs-identifier">hosts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679105301"><span class="hs-identifier hs-var">hosts</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679105303"><a href="#local-6989586621679105303"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">delete</span><span> </span><a href="#local-6989586621679105303"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679105301"><span class="hs-identifier hs-var">hosts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679105303"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#statedPrimary"><span class="hs-identifier hs-var">statedPrimary</span></a><span> </span><a href="#local-6989586621679105300"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>    </span><a href="Database.MongoDB.Internal.Util.html#untilSuccess"><span class="hs-identifier hs-var">untilSuccess</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#connection"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-6989586621679105299"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105302"><span class="hs-identifier hs-var">hosts'</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">routedHost</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-171"></a><span class="hs-comment">-- ^ Return a connection to a host using a user-supplied sorting function, which sorts based on a tuple containing the host and a boolean indicating whether the host is primary.</span><span>
</span><a name="line-172"></a><a name="routedHost"><a href="Database.MongoDB.Connection.html#routedHost"><span class="hs-identifier">routedHost</span></a></a><span> </span><a name="local-6989586621679105435"><a href="#local-6989586621679105435"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679105436"><a href="#local-6989586621679105436"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-173"></a><span>  </span><a name="local-6989586621679105437"><a href="#local-6989586621679105437"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#updateMembers"><span class="hs-identifier hs-var">updateMembers</span></a><span> </span><a href="#local-6989586621679105436"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-174"></a><span>  </span><a name="local-6989586621679105438"><a href="#local-6989586621679105438"><span class="hs-identifier">hosts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Util.html#shuffle"><span class="hs-identifier hs-var">shuffle</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#possibleHosts"><span class="hs-identifier hs-var">possibleHosts</span></a><span> </span><a href="#local-6989586621679105437"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679105439"><a href="#local-6989586621679105439"><span class="hs-identifier">addIsPrimary</span></a></a><span> </span><a name="local-6989586621679105440"><a href="#local-6989586621679105440"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105440"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679105440"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Database.MongoDB.Connection.html#statedPrimary"><span class="hs-identifier hs-var">statedPrimary</span></a><span> </span><a href="#local-6989586621679105437"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-6989586621679105443"><a href="#local-6989586621679105443"><span class="hs-identifier">hosts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Util.html#mergesortM"><span class="hs-identifier hs-var">mergesortM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679105441"><a href="#local-6989586621679105441"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679105442"><a href="#local-6989586621679105442"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679105435"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105439"><span class="hs-identifier hs-var">addIsPrimary</span></a><span> </span><a href="#local-6989586621679105441"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105439"><span class="hs-identifier hs-var">addIsPrimary</span></a><span> </span><a href="#local-6989586621679105442"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105438"><span class="hs-identifier hs-var">hosts</span></a><span>
</span><a name="line-177"></a><span>  </span><a href="Database.MongoDB.Internal.Util.html#untilSuccess"><span class="hs-identifier hs-var">untilSuccess</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#connection"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-6989586621679105436"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105443"><span class="hs-identifier hs-var">hosts'</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-keyword">type</span><span> </span><a name="ReplicaInfo"><a href="Database.MongoDB.Connection.html#ReplicaInfo"><span class="hs-identifier">ReplicaInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- ^ Result of isMaster command on host in replica set. Returned fields are: setName, ismaster, secondary, hosts, [primary]. primary only present when ismaster = false</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-identifier">statedPrimary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaInfo"><span class="hs-identifier hs-type">ReplicaInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- ^ Primary of replica set or Nothing if there isn't one</span><span>
</span><a name="line-184"></a><a name="statedPrimary"><a href="Database.MongoDB.Connection.html#statedPrimary"><span class="hs-identifier">statedPrimary</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679105444"><a href="#local-6989586621679105444"><span class="hs-identifier">host'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679105445"><a href="#local-6989586621679105445"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;ismaster&quot;</span><span> </span><a href="#local-6989586621679105445"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679105444"><span class="hs-identifier hs-var">host'</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="Database.MongoDB.Connection.html#readHostPort"><span class="hs-identifier hs-var">readHostPort</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;primary&quot;</span><span> </span><a href="#local-6989586621679105445"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-identifier">possibleHosts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaInfo"><span class="hs-identifier hs-type">ReplicaInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">]</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- ^ Non-arbiter, non-hidden members of replica set</span><span>
</span><a name="line-188"></a><a name="possibleHosts"><a href="Database.MongoDB.Connection.html#possibleHosts"><span class="hs-identifier">possibleHosts</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679105446"><a href="#local-6989586621679105446"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Connection.html#readHostPort"><span class="hs-identifier hs-var">readHostPort</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;hosts&quot;</span><span> </span><a href="#local-6989586621679105446"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">updateMembers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaInfo"><span class="hs-identifier hs-type">ReplicaInfo</span></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- ^ Fetch replica info from any server and update members accordingly</span><span>
</span><a name="line-192"></a><a name="updateMembers"><a href="Database.MongoDB.Connection.html#updateMembers"><span class="hs-identifier">updateMembers</span></a></a><span> </span><a name="local-6989586621679105447"><a href="#local-6989586621679105447"><span class="hs-identifier">rs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679105448"><a href="#local-6989586621679105448"><span class="hs-identifier">vMembers</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679105456"><a href="#local-6989586621679105456"><span class="hs-identifier">host'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679105457"><a href="#local-6989586621679105457"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Util.html#untilSuccess"><span class="hs-identifier hs-var">untilSuccess</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#fetchReplicaInfo"><span class="hs-identifier hs-var">fetchReplicaInfo</span></a><span> </span><a href="#local-6989586621679105447"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679105448"><span class="hs-identifier hs-var">vMembers</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621679105448"><span class="hs-identifier hs-var">vMembers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679105458"><a href="#local-6989586621679105458"><span class="hs-identifier">members</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-195"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679105459"><a href="#local-6989586621679105459"><span class="hs-identifier">members'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679105460"><a href="#local-6989586621679105460"><span class="hs-identifier">old</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679105461"><a href="#local-6989586621679105461"><span class="hs-identifier">new</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679105449"><span class="hs-identifier hs-var">intersection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Connection.html#readHostPort"><span class="hs-identifier hs-var">readHostPort</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;hosts&quot;</span><span> </span><a href="#local-6989586621679105457"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105458"><span class="hs-identifier hs-var">members</span></a><span>
</span><a name="line-196"></a><span>        </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-6989586621679105460"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679105462"><a href="#local-6989586621679105462"><span class="hs-identifier">mPipe</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679105462"><span class="hs-identifier hs-var">mPipe</span></a><span>
</span><a name="line-197"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105459"><span class="hs-identifier hs-var">members'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105461"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105456"><span class="hs-identifier hs-var">host'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105457"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-identifier">intersection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105451"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105451"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105451"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679105450"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>    </span><a name="local-6989586621679105449"><a href="#local-6989586621679105449"><span class="hs-identifier">intersection</span></a></a><span> </span><a name="local-6989586621679105452"><a href="#local-6989586621679105452"><span class="hs-identifier">keys</span></a></a><span> </span><a name="local-6989586621679105453"><a href="#local-6989586621679105453"><span class="hs-identifier">assocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">elem</span><span> </span><a href="#local-6989586621679105455"><span class="hs-identifier hs-var">inKeys</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105453"><span class="hs-identifier hs-var">assocs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105452"><span class="hs-identifier hs-var">keys</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621679105455"><span class="hs-identifier hs-var">inKeys</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-201"></a><span>        </span><a name="local-6989586621679105454"><a href="#local-6989586621679105454"><span class="hs-identifier">assocKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679105453"><span class="hs-identifier hs-var">assocs</span></a><span>
</span><a name="line-202"></a><span>        </span><a name="local-6989586621679105455"><a href="#local-6989586621679105455"><span class="hs-identifier">inKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intersect</span><span> </span><a href="#local-6989586621679105452"><span class="hs-identifier hs-var">keys</span></a><span> </span><a href="#local-6989586621679105454"><span class="hs-identifier hs-var">assocKeys</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">fetchReplicaInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaInfo"><span class="hs-identifier hs-type">ReplicaInfo</span></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- Connect to host and fetch replica info from host creating new connection if missing or closed (previously failed). Fail if not member of named replica set.</span><span>
</span><a name="line-206"></a><a name="fetchReplicaInfo"><a href="Database.MongoDB.Connection.html#fetchReplicaInfo"><span class="hs-identifier">fetchReplicaInfo</span></a></a><span> </span><a name="local-6989586621679105463"><a href="#local-6989586621679105463"><span class="hs-identifier">rs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><a name="local-6989586621679105464"><a href="#local-6989586621679105464"><span class="hs-identifier">rsName</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679105465"><a href="#local-6989586621679105465"><span class="hs-identifier">host'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679105466"><a href="#local-6989586621679105466"><span class="hs-identifier">mPipe</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621679105467"><a href="#local-6989586621679105467"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#connection"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-6989586621679105463"><span class="hs-identifier hs-var">rs</span></a><span> </span><a href="#local-6989586621679105466"><span class="hs-identifier hs-var">mPipe</span></a><span> </span><a href="#local-6989586621679105465"><span class="hs-identifier hs-var">host'</span></a><span>
</span><a name="line-208"></a><span>    </span><a name="local-6989586621679105468"><a href="#local-6989586621679105468"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Connection.html#adminCommand"><span class="hs-identifier hs-var">adminCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;isMaster&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679105467"><span class="hs-identifier hs-var">pipe</span></a><span>
</span><a name="line-209"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">B</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;setName&quot;</span><span> </span><a href="#local-6989586621679105468"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679105465"><span class="hs-identifier hs-var">host'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; not a member of any replica set, including &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679105464"><span class="hs-identifier hs-var">rsName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679105468"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-211"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679105469"><a href="#local-6989586621679105469"><span class="hs-identifier">setName</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679105469"><span class="hs-identifier hs-var">setName</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679105464"><span class="hs-identifier hs-var">rsName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">userError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679105465"><span class="hs-identifier hs-var">host'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; not a member of replica set &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span><span> </span><a href="#local-6989586621679105464"><span class="hs-identifier hs-var">rsName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679105468"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-212"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105465"><span class="hs-identifier hs-var">host'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105468"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">connection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-type">ReplicaSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- ^ Return new or existing connection to member of replica set. If pipe is already known for host it is given, but we still test if it is open.</span><span>
</span><a name="line-216"></a><a name="connection"><a href="Database.MongoDB.Connection.html#connection"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#ReplicaSet"><span class="hs-identifier hs-var">ReplicaSet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679105470"><a href="#local-6989586621679105470"><span class="hs-identifier">vMembers</span></a></a><span> </span><a name="local-6989586621679105471"><a href="#local-6989586621679105471"><span class="hs-identifier">timeoutSecs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679105472"><a href="#local-6989586621679105472"><span class="hs-identifier">mPipe</span></a></a><span> </span><a name="local-6989586621679105473"><a href="#local-6989586621679105473"><span class="hs-identifier">host'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679105474"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679105480"><a href="#local-6989586621679105480"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier hs-var">isClosed</span></a><span> </span><a href="#local-6989586621679105480"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679105481"><a href="#local-6989586621679105481"><span class="hs-identifier">bad</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679105481"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679105474"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679105480"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105472"><span class="hs-identifier hs-var">mPipe</span></a><span>
</span><a name="line-218"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621679105474"><a href="#local-6989586621679105474"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621679105470"><span class="hs-identifier hs-var">vMembers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679105475"><a href="#local-6989586621679105475"><span class="hs-identifier">members</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-220"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679105476"><a href="#local-6989586621679105476"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Connection.html#connect%27"><span class="hs-identifier hs-var">connect'</span></a><span> </span><a href="#local-6989586621679105471"><span class="hs-identifier hs-var">timeoutSecs</span></a><span> </span><a href="#local-6989586621679105473"><span class="hs-identifier hs-var">host'</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679105477"><a href="#local-6989586621679105477"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#updateAssocs"><span class="hs-identifier hs-var">updateAssocs</span></a><span> </span><a href="#local-6989586621679105473"><span class="hs-identifier hs-var">host'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679105477"><span class="hs-identifier hs-var">pipe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679105475"><span class="hs-identifier hs-var">members</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105477"><span class="hs-identifier hs-var">pipe</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">List</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679105473"><span class="hs-identifier hs-var">host'</span></a><span> </span><a href="#local-6989586621679105475"><span class="hs-identifier hs-var">members</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-222"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679105478"><a href="#local-6989586621679105478"><span class="hs-identifier">pipe</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier hs-var">isClosed</span></a><span> </span><a href="#local-6989586621679105478"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679105479"><a href="#local-6989586621679105479"><span class="hs-identifier">bad</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679105479"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679105476"><span class="hs-identifier hs-var">new</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679105475"><span class="hs-identifier hs-var">members</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679105478"><span class="hs-identifier hs-var">pipe</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679105476"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">{- Authors: Tony Hannan &lt;tony@10gen.com&gt;
   Copyright 2011 10gen Inc.
   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. -}</span><span>
</span><a name="line-229"></a></pre></body></html>