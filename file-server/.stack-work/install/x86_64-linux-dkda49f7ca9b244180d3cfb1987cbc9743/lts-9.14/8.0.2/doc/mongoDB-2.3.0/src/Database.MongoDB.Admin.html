<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Database administrative functions</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP, FlexibleContexts, OverloadedStrings, RecordWildCards #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Admin</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>    </span><span class="hs-comment">-- * Admin</span><span>
</span><a name="line-7"></a><span>    </span><span class="hs-comment">-- ** Collection</span><span>
</span><a name="line-8"></a><span>    </span><a href="Database.MongoDB.Admin.html#CollectionOption"><span class="hs-identifier hs-type">CollectionOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#createCollection"><span class="hs-identifier hs-var">createCollection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#renameCollection"><span class="hs-identifier hs-var">renameCollection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#dropCollection"><span class="hs-identifier hs-var">dropCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="Database.MongoDB.Admin.html#validateCollection"><span class="hs-identifier hs-var">validateCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>    </span><span class="hs-comment">-- ** Index</span><span>
</span><a name="line-11"></a><span>    </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-type">Index</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#index"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#ensureIndex"><span class="hs-identifier hs-var">ensureIndex</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#createIndex"><span class="hs-identifier hs-var">createIndex</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#dropIndex"><span class="hs-identifier hs-var">dropIndex</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>    </span><a href="Database.MongoDB.Admin.html#getIndexes"><span class="hs-identifier hs-var">getIndexes</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#dropIndexes"><span class="hs-identifier hs-var">dropIndexes</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- ** User</span><span>
</span><a name="line-14"></a><span>    </span><a href="Database.MongoDB.Admin.html#allUsers"><span class="hs-identifier hs-var">allUsers</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#addUser"><span class="hs-identifier hs-var">addUser</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#removeUser"><span class="hs-identifier hs-var">removeUser</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- ** Database</span><span>
</span><a name="line-16"></a><span>    </span><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier hs-var">admin</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#cloneDatabase"><span class="hs-identifier hs-var">cloneDatabase</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#copyDatabase"><span class="hs-identifier hs-var">copyDatabase</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#dropDatabase"><span class="hs-identifier hs-var">dropDatabase</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#repairDatabase"><span class="hs-identifier hs-var">repairDatabase</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><span class="hs-comment">-- ** Server</span><span>
</span><a name="line-18"></a><span>    </span><a href="Database.MongoDB.Admin.html#serverBuildInfo"><span class="hs-identifier hs-var">serverBuildInfo</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#serverVersion"><span class="hs-identifier hs-var">serverVersion</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><span class="hs-comment">-- * Diagnotics</span><span>
</span><a name="line-20"></a><span>    </span><span class="hs-comment">-- ** Collection</span><span>
</span><a name="line-21"></a><span>    </span><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier hs-var">collectionStats</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#dataSize"><span class="hs-identifier hs-var">dataSize</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#storageSize"><span class="hs-identifier hs-var">storageSize</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#totalIndexSize"><span class="hs-identifier hs-var">totalIndexSize</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#totalSize"><span class="hs-identifier hs-var">totalSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-comment">-- ** Profiling</span><span>
</span><a name="line-23"></a><span>    </span><a href="Database.MongoDB.Admin.html#ProfilingLevel"><span class="hs-identifier hs-type">ProfilingLevel</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#getProfilingLevel"><span class="hs-identifier hs-var">getProfilingLevel</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#MilliSec"><span class="hs-identifier hs-type">MilliSec</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#setProfilingLevel"><span class="hs-identifier hs-var">setProfilingLevel</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>    </span><span class="hs-comment">-- ** Database</span><span>
</span><a name="line-25"></a><span>    </span><a href="Database.MongoDB.Admin.html#dbStats"><span class="hs-identifier hs-var">dbStats</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#OpNum"><span class="hs-identifier hs-type">OpNum</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#currentOp"><span class="hs-identifier hs-var">currentOp</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#killOp"><span class="hs-identifier hs-var">killOp</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-comment">-- ** Server</span><span>
</span><a name="line-27"></a><span>    </span><a href="Database.MongoDB.Admin.html#serverStatus"><span class="hs-identifier hs-var">serverStatus</span></a><span>
</span><a name="line-28"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,8,0)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forkIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forever</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeToList</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashTable</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">H</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Field</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">at</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">=:</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">=?</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exclude</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">merge</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Connection.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Connection</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier hs-var">showHostPort</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#pwHash"><span class="hs-identifier hs-var">pwHash</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier hs-var">pwKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Util.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Query.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>                               </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#Query"><span class="hs-identifier hs-type">Query</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#accessMode"><span class="hs-identifier hs-var">accessMode</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#master"><span class="hs-identifier hs-var">master</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>                               </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                               </span><a href="Database.MongoDB.Query.html#insert_"><span class="hs-identifier hs-var">insert_</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#save"><span class="hs-identifier hs-var">save</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#delete"><span class="hs-identifier hs-var">delete</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-comment">-- * Admin</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- ** Collection</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">data</span><span> </span><a name="CollectionOption"><a href="Database.MongoDB.Admin.html#CollectionOption"><span class="hs-identifier">CollectionOption</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Capped"><a href="Database.MongoDB.Admin.html#Capped"><span class="hs-identifier">Capped</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="MaxByteSize"><a href="Database.MongoDB.Admin.html#MaxByteSize"><span class="hs-identifier">MaxByteSize</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="MaxItems"><a href="Database.MongoDB.Admin.html#MaxItems"><span class="hs-identifier">MaxItems</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-identifier">coptElem</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Admin.html#CollectionOption"><span class="hs-identifier hs-type">CollectionOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Field</span><span>
</span><a name="line-65"></a><a name="coptElem"><a href="Database.MongoDB.Admin.html#coptElem"><span class="hs-identifier">coptElem</span></a></a><span> </span><a href="Database.MongoDB.Admin.html#Capped"><span class="hs-identifier hs-var">Capped</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;capped&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-66"></a><span class="hs-identifier">coptElem</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Admin.html#MaxByteSize"><span class="hs-identifier hs-var">MaxByteSize</span></a><span> </span><a name="local-6989586621679111886"><a href="#local-6989586621679111886"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;size&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111886"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-67"></a><span class="hs-identifier">coptElem</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Admin.html#MaxItems"><span class="hs-identifier hs-var">MaxItems</span></a><span> </span><a name="local-6989586621679111887"><a href="#local-6989586621679111887"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;max&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111887"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-identifier">createCollection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111885"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Admin.html#CollectionOption"><span class="hs-identifier hs-type">CollectionOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111885"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- ^ Create collection with given options. You only need to call this to set options, otherwise a collection is created automatically on first use with no options.</span><span>
</span><a name="line-71"></a><a name="createCollection"><a href="Database.MongoDB.Admin.html#createCollection"><span class="hs-identifier">createCollection</span></a></a><span> </span><a name="local-6989586621679111888"><a href="#local-6989586621679111888"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621679111889"><a href="#local-6989586621679111889"><span class="hs-identifier">col</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;create&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111889"><span class="hs-identifier hs-var">col</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Admin.html#coptElem"><span class="hs-identifier hs-var">coptElem</span></a><span> </span><a href="#local-6989586621679111888"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">renameCollection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111884"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111884"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- ^ Rename first collection to second collection</span><span>
</span><a name="line-75"></a><a name="renameCollection"><a href="Database.MongoDB.Admin.html#renameCollection"><span class="hs-identifier">renameCollection</span></a></a><span> </span><a name="local-6989586621679111890"><a href="#local-6989586621679111890"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621679111891"><a href="#local-6989586621679111891"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>    </span><a name="local-6989586621679111892"><a href="#local-6989586621679111892"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-77"></a><span>    </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier hs-var">admin</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;renameCollection&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111892"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679111890"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;to&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111892"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679111891"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;dropTarget&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">]</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-identifier">dropCollection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111883"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111883"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- ^ Delete the given collection! Return True if collection existed (and was deleted); return False if collection did not exist (and no action).</span><span>
</span><a name="line-81"></a><a name="dropCollection"><a href="Database.MongoDB.Admin.html#dropCollection"><span class="hs-identifier">dropCollection</span></a></a><span> </span><a name="local-6989586621679111893"><a href="#local-6989586621679111893"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-82"></a><span>    </span><a href="Database.MongoDB.Admin.html#resetIndexCache"><span class="hs-identifier hs-var">resetIndexCache</span></a><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679111894"><a href="#local-6989586621679111894"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;drop&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111893"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">]</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="Database.MongoDB.Internal.Util.html#true1"><span class="hs-identifier hs-var">true1</span></a><span> </span><span class="hs-string">&quot;ok&quot;</span><span> </span><a href="#local-6989586621679111894"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;errmsg&quot;</span><span> </span><a href="#local-6989586621679111894"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;ns not found&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-86"></a><span>            </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;dropCollection failed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679111894"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-identifier">validateCollection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111882"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111882"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- ^ This operation takes a while</span><span>
</span><a name="line-90"></a><a name="validateCollection"><a href="Database.MongoDB.Admin.html#validateCollection"><span class="hs-identifier">validateCollection</span></a></a><span> </span><a name="local-6989586621679111895"><a href="#local-6989586621679111895"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;validate&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111895"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">]</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- ** Index</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-keyword">type</span><span> </span><a name="IndexName"><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier">IndexName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="Index"><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier">Index</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Index"><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier">Index</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-97"></a><span>    </span><a name="iColl"><a href="Database.MongoDB.Admin.html#iColl"><span class="hs-identifier">iColl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>    </span><a name="iKey"><a href="Database.MongoDB.Admin.html#iKey"><span class="hs-identifier">iKey</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>    </span><a name="iName"><a href="Database.MongoDB.Admin.html#iName"><span class="hs-identifier">iName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>    </span><a name="iUnique"><a href="Database.MongoDB.Admin.html#iUnique"><span class="hs-identifier">iUnique</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>    </span><a name="iDropDups"><a href="Database.MongoDB.Admin.html#iDropDups"><span class="hs-identifier">iDropDups</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>    </span><a name="iExpireAfterSeconds"><a href="Database.MongoDB.Admin.html#iExpireAfterSeconds"><span class="hs-identifier">iExpireAfterSeconds</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">idxDocument</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-type">Index</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-106"></a><a name="idxDocument"><a href="Database.MongoDB.Admin.html#idxDocument"><span class="hs-identifier">idxDocument</span></a></a><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-var">Index</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679111902"><a href="#local-6989586621679111902"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-string">&quot;ns&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111902"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679111896"><span class="hs-identifier hs-var">iColl</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-string">&quot;key&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111897"><span class="hs-identifier hs-var">iKey</span></a><span class="hs-special">,</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-string">&quot;name&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111898"><span class="hs-identifier hs-var">iName</span></a><span class="hs-special">,</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-string">&quot;unique&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111899"><span class="hs-identifier hs-var">iUnique</span></a><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-string">&quot;dropDups&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111900"><span class="hs-identifier hs-var">iDropDups</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">=:</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;expireAfterSeconds&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679111901"><span class="hs-identifier hs-var">iExpireAfterSeconds</span></a><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">index</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-type">Index</span></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- ^ Spec of index of ordered keys on collection. Name is generated from keys. Unique and dropDups are False.</span><span>
</span><a name="line-115"></a><a name="index"><a href="Database.MongoDB.Admin.html#index"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621679111903"><a href="#local-6989586621679111903"><span class="hs-identifier">coll</span></a></a><span> </span><a name="local-6989586621679111904"><a href="#local-6989586621679111904"><span class="hs-identifier">keys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-var">Index</span></a><span> </span><a href="#local-6989586621679111903"><span class="hs-identifier hs-var">coll</span></a><span> </span><a href="#local-6989586621679111904"><span class="hs-identifier hs-var">keys</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Admin.html#genName"><span class="hs-identifier hs-var">genName</span></a><span> </span><a href="#local-6989586621679111904"><span class="hs-identifier hs-var">keys</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">genName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Order"><span class="hs-identifier hs-type">Order</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a><span>
</span><a name="line-118"></a><a name="genName"><a href="Database.MongoDB.Admin.html#genName"><span class="hs-identifier">genName</span></a></a><span> </span><a name="local-6989586621679111905"><a href="#local-6989586621679111905"><span class="hs-identifier">keys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679111906"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679111905"><span class="hs-identifier hs-var">keys</span></a><span class="hs-special">)</span><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621679111906"><a href="#local-6989586621679111906"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679111907"><a href="#local-6989586621679111907"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:=</span><span> </span><a name="local-6989586621679111908"><a href="#local-6989586621679111908"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679111907"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679111908"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">ensureIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111881"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-type">Index</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111881"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- ^ Create index if we did not already create one. May be called repeatedly with practically no performance hit, because we remember if we already called this for the same index (although this memory gets wiped out every 15 minutes, in case another client drops the index and we want to create it again).</span><span>
</span><a name="line-123"></a><a name="ensureIndex"><a href="Database.MongoDB.Admin.html#ensureIndex"><span class="hs-identifier">ensureIndex</span></a></a><span> </span><a name="local-6989586621679111909"><a href="#local-6989586621679111909"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679111910"><a href="#local-6989586621679111910"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iColl</span><span> </span><a href="#local-6989586621679111909"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">iName</span><span> </span><a href="#local-6989586621679111909"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-124"></a><span>    </span><a name="local-6989586621679111911"><a href="#local-6989586621679111911"><span class="hs-identifier">icache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Admin.html#fetchIndexCache"><span class="hs-identifier hs-var">fetchIndexCache</span></a><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679111912"><a href="#local-6989586621679111912"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679111911"><span class="hs-identifier hs-var">icache</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span> </span><a href="#local-6989586621679111910"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679111912"><span class="hs-identifier hs-var">set</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-127"></a><span>        </span><a href="Database.MongoDB.Query.html#accessMode"><span class="hs-identifier hs-var">accessMode</span></a><span> </span><a href="Database.MongoDB.Query.html#master"><span class="hs-identifier hs-var">master</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Admin.html#createIndex"><span class="hs-identifier hs-var">createIndex</span></a><span> </span><a href="#local-6989586621679111909"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679111911"><span class="hs-identifier hs-var">icache</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621679111910"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679111912"><span class="hs-identifier hs-var">set</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">createIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111880"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#Index"><span class="hs-identifier hs-type">Index</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111880"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- ^ Create index on the server. This call goes to the server every time.</span><span>
</span><a name="line-132"></a><a name="createIndex"><a href="Database.MongoDB.Admin.html#createIndex"><span class="hs-identifier">createIndex</span></a></a><span> </span><a name="local-6989586621679111913"><a href="#local-6989586621679111913"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#insert_"><span class="hs-identifier hs-var">insert_</span></a><span> </span><span class="hs-string">&quot;system.indexes&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.MongoDB.Admin.html#idxDocument"><span class="hs-identifier hs-var">idxDocument</span></a><span> </span><a href="#local-6989586621679111913"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">dropIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111879"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111879"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- ^ Remove the index</span><span>
</span><a name="line-136"></a><a name="dropIndex"><a href="Database.MongoDB.Admin.html#dropIndex"><span class="hs-identifier">dropIndex</span></a></a><span> </span><a name="local-6989586621679111914"><a href="#local-6989586621679111914"><span class="hs-identifier">coll</span></a></a><span> </span><a name="local-6989586621679111915"><a href="#local-6989586621679111915"><span class="hs-identifier">idxName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-137"></a><span>    </span><a href="Database.MongoDB.Admin.html#resetIndexCache"><span class="hs-identifier hs-var">resetIndexCache</span></a><span>
</span><a name="line-138"></a><span>    </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;deleteIndexes&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111914"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;index&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111915"><span class="hs-identifier hs-var">idxName</span></a><span class="hs-special">]</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-identifier">getIndexes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111878"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111878"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- ^ Get all indexes on this collection</span><span>
</span><a name="line-142"></a><a name="getIndexes"><a href="Database.MongoDB.Admin.html#getIndexes"><span class="hs-identifier">getIndexes</span></a></a><span> </span><a name="local-6989586621679111916"><a href="#local-6989586621679111916"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-143"></a><span>    </span><a name="local-6989586621679111917"><a href="#local-6989586621679111917"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-144"></a><span>    </span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;ns&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111917"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="Database.MongoDB.Internal.Util.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-6989586621679111916"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;system.indexes&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">dropIndexes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111877"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111877"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- ^ Drop all indexes on this collection</span><span>
</span><a name="line-148"></a><a name="dropIndexes"><a href="Database.MongoDB.Admin.html#dropIndexes"><span class="hs-identifier">dropIndexes</span></a></a><span> </span><a name="local-6989586621679111918"><a href="#local-6989586621679111918"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-149"></a><span>    </span><a href="Database.MongoDB.Admin.html#resetIndexCache"><span class="hs-identifier hs-var">resetIndexCache</span></a><span>
</span><a name="line-150"></a><span>    </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;deleteIndexes&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111918"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;index&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;*&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">-- *** Index cache</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-keyword">type</span><span> </span><a name="DbIndexCache"><a href="Database.MongoDB.Admin.html#DbIndexCache"><span class="hs-identifier">DbIndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">H</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">BasicHashTable</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><a href="Database.MongoDB.Admin.html#IndexCache"><span class="hs-identifier hs-type">IndexCache</span></a><span>
</span><a name="line-155"></a><span class="hs-comment">-- ^ Cache the indexes we create so repeatedly calling ensureIndex only hits database the first time. Clear cache every once in a while so if someone else deletes index we will recreate it on ensureIndex.</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-keyword">type</span><span> </span><a name="IndexCache"><a href="Database.MongoDB.Admin.html#IndexCache"><span class="hs-identifier">IndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Admin.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">dbIndexCache</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Admin.html#DbIndexCache"><span class="hs-identifier hs-type">DbIndexCache</span></a><span>
</span><a name="line-160"></a><span class="hs-comment">-- ^ initialize cache and fork thread that clears it every 15 minutes</span><span>
</span><a name="line-161"></a><a name="dbIndexCache"><a href="Database.MongoDB.Admin.html#dbIndexCache"><span class="hs-identifier">dbIndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-162"></a><span>    </span><a name="local-6989586621679111919"><a href="#local-6989586621679111919"><span class="hs-identifier">table</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">H</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">new</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">forever</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">900000000</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#clearDbIndexCache"><span class="hs-identifier hs-var">clearDbIndexCache</span></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679111919"><span class="hs-identifier hs-var">table</span></a><span>
</span><a name="line-165"></a><span class="hs-pragma">{-# NOINLINE dbIndexCache #-}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">clearDbIndexCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><a name="clearDbIndexCache"><a href="Database.MongoDB.Admin.html#clearDbIndexCache"><span class="hs-identifier">clearDbIndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621679111955"><a href="#local-6989586621679111955"><span class="hs-identifier">keys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">H</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="Database.MongoDB.Admin.html#dbIndexCache"><span class="hs-identifier hs-var">dbIndexCache</span></a><span>
</span><a name="line-170"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">H</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><a href="Database.MongoDB.Admin.html#dbIndexCache"><span class="hs-identifier hs-var">dbIndexCache</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679111955"><span class="hs-identifier hs-var">keys</span></a><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-identifier">fetchIndexCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111876"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111876"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Admin.html#IndexCache"><span class="hs-identifier hs-type">IndexCache</span></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- ^ Get index cache for current database</span><span>
</span><a name="line-174"></a><a name="fetchIndexCache"><a href="Database.MongoDB.Admin.html#fetchIndexCache"><span class="hs-identifier">fetchIndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>    </span><a name="local-6989586621679111959"><a href="#local-6989586621679111959"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#thisDatabase"><span class="hs-identifier hs-var">thisDatabase</span></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>        </span><a name="local-6989586621679111960"><a href="#local-6989586621679111960"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">H</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="Database.MongoDB.Admin.html#dbIndexCache"><span class="hs-identifier hs-var">dbIndexCache</span></a><span> </span><a href="#local-6989586621679111959"><span class="hs-identifier hs-var">db</span></a><span>
</span><a name="line-178"></a><span>        </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679111956"><span class="hs-identifier hs-var">newIdxCache</span></a><span> </span><a href="#local-6989586621679111959"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679111960"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-179"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621679111956"><a href="#local-6989586621679111956"><span class="hs-identifier">newIdxCache</span></a></a><span> </span><a name="local-6989586621679111957"><a href="#local-6989586621679111957"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>        </span><a name="local-6989586621679111958"><a href="#local-6989586621679111958"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-identifier hs-var">H</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="Database.MongoDB.Admin.html#dbIndexCache"><span class="hs-identifier hs-var">dbIndexCache</span></a><span> </span><a href="#local-6989586621679111957"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="#local-6989586621679111958"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-183"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679111958"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">resetIndexCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111875"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111875"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- ^ reset index cache for current database</span><span>
</span><a name="line-187"></a><a name="resetIndexCache"><a href="Database.MongoDB.Admin.html#resetIndexCache"><span class="hs-identifier">resetIndexCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-188"></a><span>    </span><a name="local-6989586621679111961"><a href="#local-6989586621679111961"><span class="hs-identifier">icache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Admin.html#fetchIndexCache"><span class="hs-identifier hs-var">fetchIndexCache</span></a><span>
</span><a name="line-189"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679111961"><span class="hs-identifier hs-var">icache</span></a><span> </span><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- ** User</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">allUsers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111874"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111874"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- ^ Fetch all users of this database</span><span>
</span><a name="line-195"></a><a name="allUsers"><a href="Database.MongoDB.Admin.html#allUsers"><span class="hs-identifier">allUsers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exclude</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;_id&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#rest"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Database.MongoDB.Query.html#find"><span class="hs-identifier hs-var">find</span></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;system.users&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">sort</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">project</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;readOnly&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">addUser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111873"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- ^ Add user with password with read-only access if bool is True or read-write access if bool is False</span><span>
</span><a name="line-201"></a><a name="addUser"><a href="Database.MongoDB.Admin.html#addUser"><span class="hs-identifier">addUser</span></a></a><span> </span><a name="local-6989586621679111962"><a href="#local-6989586621679111962"><span class="hs-identifier">readOnly</span></a></a><span> </span><a name="local-6989586621679111963"><a href="#local-6989586621679111963"><span class="hs-identifier">user</span></a></a><span> </span><a name="local-6989586621679111964"><a href="#local-6989586621679111964"><span class="hs-identifier">pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679111965"><a href="#local-6989586621679111965"><span class="hs-identifier">mu</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111963"><span class="hs-identifier hs-var">user</span></a><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;system.users&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679111966"><a href="#local-6989586621679111966"><span class="hs-identifier">usr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">merge</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;readOnly&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111962"><span class="hs-identifier hs-var">readOnly</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;pwd&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwHash"><span class="hs-identifier hs-var">pwHash</span></a><span> </span><a href="#local-6989586621679111963"><span class="hs-identifier hs-var">user</span></a><span> </span><a href="#local-6989586621679111964"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111963"><span class="hs-identifier hs-var">user</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621679111965"><span class="hs-identifier hs-var">mu</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>    </span><a href="Database.MongoDB.Query.html#save"><span class="hs-identifier hs-var">save</span></a><span> </span><span class="hs-string">&quot;system.users&quot;</span><span> </span><a href="#local-6989586621679111966"><span class="hs-identifier hs-var">usr</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">removeUser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111872"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111872"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="removeUser"><a href="Database.MongoDB.Admin.html#removeUser"><span class="hs-identifier">removeUser</span></a></a><span> </span><a name="local-6989586621679111967"><a href="#local-6989586621679111967"><span class="hs-identifier">user</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#delete"><span class="hs-identifier hs-var">delete</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;user&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111967"><span class="hs-identifier hs-var">user</span></a><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;system.users&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">-- ** Database</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-identifier">admin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- ^ \&quot;admin\&quot; database</span><span>
</span><a name="line-214"></a><a name="admin"><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier">admin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;admin&quot;</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-identifier">cloneDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111871"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111871"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- ^ Copy database from given host to the server I am connected to. Fails and returns @&quot;ok&quot; = 0@ if we don't have permission to read from given server (use copyDatabase in this case).</span><span>
</span><a name="line-218"></a><a name="cloneDatabase"><a href="Database.MongoDB.Admin.html#cloneDatabase"><span class="hs-identifier">cloneDatabase</span></a></a><span> </span><a name="local-6989586621679111968"><a href="#local-6989586621679111968"><span class="hs-identifier">db</span></a></a><span> </span><a name="local-6989586621679111969"><a href="#local-6989586621679111969"><span class="hs-identifier">fromHost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="#local-6989586621679111968"><span class="hs-identifier hs-var">db</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;clone&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier hs-var">showHostPort</span></a><span> </span><a href="#local-6989586621679111969"><span class="hs-identifier hs-var">fromHost</span></a><span class="hs-special">]</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">copyDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111870"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Connection.html#Host"><span class="hs-identifier hs-type">Host</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111870"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- ^ Copy database from given host to the server I am connected to. If username &amp; password is supplied use them to read from given host.</span><span>
</span><a name="line-222"></a><a name="copyDatabase"><a href="Database.MongoDB.Admin.html#copyDatabase"><span class="hs-identifier">copyDatabase</span></a></a><span> </span><a name="local-6989586621679111970"><a href="#local-6989586621679111970"><span class="hs-identifier">fromDb</span></a></a><span> </span><a name="local-6989586621679111971"><a href="#local-6989586621679111971"><span class="hs-identifier">fromHost</span></a></a><span> </span><a name="local-6989586621679111972"><a href="#local-6989586621679111972"><span class="hs-identifier">mup</span></a></a><span> </span><a name="local-6989586621679111973"><a href="#local-6989586621679111973"><span class="hs-identifier">toDb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679111974"><a href="#local-6989586621679111974"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;copydb&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;fromhost&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier hs-var">showHostPort</span></a><span> </span><a href="#local-6989586621679111971"><span class="hs-identifier hs-var">fromHost</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;fromdb&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111970"><span class="hs-identifier hs-var">fromDb</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;todb&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111973"><span class="hs-identifier hs-var">toDb</span></a><span class="hs-special">]</span><span>
</span><a name="line-224"></a><span>    </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier hs-var">admin</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679111972"><span class="hs-identifier hs-var">mup</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><a href="#local-6989586621679111974"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-226"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679111975"><a href="#local-6989586621679111975"><span class="hs-identifier">usr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679111976"><a href="#local-6989586621679111976"><span class="hs-identifier">pss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-227"></a><span>            </span><a name="local-6989586621679111977"><a href="#local-6989586621679111977"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;nonce&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;copydbgetnonce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;fromhost&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Connection.html#showHostPort"><span class="hs-identifier hs-var">showHostPort</span></a><span> </span><a href="#local-6989586621679111971"><span class="hs-identifier hs-var">fromHost</span></a><span class="hs-special">]</span><span>
</span><a name="line-228"></a><span>            </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679111974"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;username&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111975"><span class="hs-identifier hs-var">usr</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;nonce&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111977"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;key&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier hs-var">pwKey</span></a><span> </span><a href="#local-6989586621679111977"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679111975"><span class="hs-identifier hs-var">usr</span></a><span> </span><a href="#local-6989586621679111976"><span class="hs-identifier hs-var">pss</span></a><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-identifier">dropDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111869"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111869"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- ^ Delete the given database!</span><span>
</span><a name="line-232"></a><a name="dropDatabase"><a href="Database.MongoDB.Admin.html#dropDatabase"><span class="hs-identifier">dropDatabase</span></a></a><span> </span><a name="local-6989586621679111978"><a href="#local-6989586621679111978"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="#local-6989586621679111978"><span class="hs-identifier hs-var">db</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;dropDatabase&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">repairDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111868"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Database"><span class="hs-identifier hs-type">Database</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111868"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- ^ Attempt to fix any corrupt records. This operation takes a while.</span><span>
</span><a name="line-236"></a><a name="repairDatabase"><a href="Database.MongoDB.Admin.html#repairDatabase"><span class="hs-identifier">repairDatabase</span></a></a><span> </span><a name="local-6989586621679111979"><a href="#local-6989586621679111979"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="#local-6989586621679111979"><span class="hs-identifier hs-var">db</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;repairDatabase&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-comment">-- ** Server</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-identifier">serverBuildInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111867"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111867"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-241"></a><a name="serverBuildInfo"><a href="Database.MongoDB.Admin.html#serverBuildInfo"><span class="hs-identifier">serverBuildInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier hs-var">admin</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;buildinfo&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">serverVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111866"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111866"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-244"></a><a name="serverVersion"><a href="Database.MongoDB.Admin.html#serverVersion"><span class="hs-identifier">serverVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;version&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Admin.html#serverBuildInfo"><span class="hs-identifier hs-var">serverBuildInfo</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- * Diagnostics</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- ** Collection</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-identifier">collectionStats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111865"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111865"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-251"></a><a name="collectionStats"><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier">collectionStats</span></a></a><span> </span><a name="local-6989586621679111980"><a href="#local-6989586621679111980"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;collstats&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111980"><span class="hs-identifier hs-var">coll</span></a><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">dataSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111864"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111864"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-254"></a><a name="dataSize"><a href="Database.MongoDB.Admin.html#dataSize"><span class="hs-identifier">dataSize</span></a></a><span> </span><a name="local-6989586621679111981"><a href="#local-6989586621679111981"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;size&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier hs-var">collectionStats</span></a><span> </span><a href="#local-6989586621679111981"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">storageSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111863"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111863"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-257"></a><a name="storageSize"><a href="Database.MongoDB.Admin.html#storageSize"><span class="hs-identifier">storageSize</span></a></a><span> </span><a name="local-6989586621679111982"><a href="#local-6989586621679111982"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;storageSize&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier hs-var">collectionStats</span></a><span> </span><a href="#local-6989586621679111982"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-identifier">totalIndexSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111862"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111862"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-260"></a><a name="totalIndexSize"><a href="Database.MongoDB.Admin.html#totalIndexSize"><span class="hs-identifier">totalIndexSize</span></a></a><span> </span><a name="local-6989586621679111983"><a href="#local-6989586621679111983"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;totalIndexSize&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier hs-var">collectionStats</span></a><span> </span><a href="#local-6989586621679111983"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-identifier">totalSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111861"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Collection"><span class="hs-identifier hs-type">Collection</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111861"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-263"></a><a name="totalSize"><a href="Database.MongoDB.Admin.html#totalSize"><span class="hs-identifier">totalSize</span></a></a><span> </span><a name="local-6989586621679111984"><a href="#local-6989586621679111984"><span class="hs-identifier">coll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-264"></a><span>    </span><a name="local-6989586621679111987"><a href="#local-6989586621679111987"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Admin.html#storageSize"><span class="hs-identifier hs-var">storageSize</span></a><span> </span><a href="#local-6989586621679111984"><span class="hs-identifier hs-var">coll</span></a><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621679111988"><a href="#local-6989586621679111988"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679111985"><span class="hs-identifier hs-var">isize</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Database.MongoDB.Admin.html#getIndexes"><span class="hs-identifier hs-var">getIndexes</span></a><span> </span><a href="#local-6989586621679111984"><span class="hs-identifier hs-var">coll</span></a><span>
</span><a name="line-266"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679111987"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679111988"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679111985"><a href="#local-6989586621679111985"><span class="hs-identifier">isize</span></a></a><span> </span><a name="local-6989586621679111986"><a href="#local-6989586621679111986"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;storageSize&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Admin.html#collectionStats"><span class="hs-identifier hs-var">collectionStats</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679111984"><span class="hs-identifier hs-var">coll</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;.$&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;name&quot;</span><span> </span><a href="#local-6989586621679111986"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- ** Profiling</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-keyword">data</span><span> </span><a name="ProfilingLevel"><a href="Database.MongoDB.Admin.html#ProfilingLevel"><span class="hs-identifier">ProfilingLevel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Off"><a href="Database.MongoDB.Admin.html#Off"><span class="hs-identifier">Off</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Slow"><a href="Database.MongoDB.Admin.html#Slow"><span class="hs-identifier">Slow</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="All"><a href="Database.MongoDB.Admin.html#All"><span class="hs-identifier">All</span></a></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-identifier">getProfilingLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111860"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111860"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Admin.html#ProfilingLevel"><span class="hs-identifier hs-type">ProfilingLevel</span></a><span>
</span><a name="line-275"></a><a name="getProfilingLevel"><a href="Database.MongoDB.Admin.html#getProfilingLevel"><span class="hs-identifier">getProfilingLevel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">at</span><span> </span><span class="hs-string">&quot;was&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;profile&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-keyword">type</span><span> </span><a name="MilliSec"><a href="Database.MongoDB.Admin.html#MilliSec"><span class="hs-identifier">MilliSec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-identifier">setProfilingLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111859"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#ProfilingLevel"><span class="hs-identifier hs-type">ProfilingLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.MongoDB.Admin.html#MilliSec"><span class="hs-identifier hs-type">MilliSec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111859"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><a name="setProfilingLevel"><a href="Database.MongoDB.Admin.html#setProfilingLevel"><span class="hs-identifier">setProfilingLevel</span></a></a><span> </span><a name="local-6989586621679111989"><a href="#local-6989586621679111989"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679111990"><a href="#local-6989586621679111990"><span class="hs-identifier">mSlowMs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-281"></a><span>    </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-string">&quot;profile&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679111989"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;slowms&quot;</span><span> </span><span class="hs-operator hs-var">=?</span><span> </span><a href="#local-6989586621679111990"><span class="hs-identifier hs-var">mSlowMs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-comment">-- ** Database</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-identifier">dbStats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111858"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111858"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-286"></a><a name="dbStats"><a href="Database.MongoDB.Admin.html#dbStats"><span class="hs-identifier">dbStats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;dbstats&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-identifier">currentOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111857"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111857"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- ^ See currently running operation on the database, if any</span><span>
</span><a name="line-290"></a><a name="currentOp"><a href="Database.MongoDB.Admin.html#currentOp"><span class="hs-identifier">currentOp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;$cmd.sys.inprog&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-keyword">type</span><span> </span><a name="OpNum"><a href="Database.MongoDB.Admin.html#OpNum"><span class="hs-identifier">OpNum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-identifier">killOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111856"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Admin.html#OpNum"><span class="hs-identifier hs-type">OpNum</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111856"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><a name="killOp"><a href="Database.MongoDB.Admin.html#killOp"><span class="hs-identifier">killOp</span></a></a><span> </span><a name="local-6989586621679111991"><a href="#local-6989586621679111991"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#select"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;op&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><a href="#local-6989586621679111991"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">]</span><span> </span><span class="hs-string">&quot;$cmd.sys.killop&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- ** Server</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-identifier">serverStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679111855"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.MongoDB.Query.html#Action"><span class="hs-identifier hs-type">Action</span></a><span> </span><a href="#local-6989586621679111855"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Document</span><span>
</span><a name="line-300"></a><a name="serverStatus"><a href="Database.MongoDB.Admin.html#serverStatus"><span class="hs-identifier">serverStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Query.html#useDb"><span class="hs-identifier hs-var">useDb</span></a><span> </span><a href="Database.MongoDB.Admin.html#admin"><span class="hs-identifier hs-var">admin</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Query.html#runCommand"><span class="hs-identifier hs-var">runCommand</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;serverStatus&quot;</span><span> </span><span class="hs-operator hs-var">=:</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-comment">{- Authors: Tony Hannan &lt;tony@10gen.com&gt;
   Copyright 2011 10gen Inc.
   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. -}</span><span>
</span><a name="line-306"></a></pre></body></html>