<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, FlexibleContexts #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK hide, prune #-}</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Module         : Data.ByteString.Search.Internal.Utils</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Copyright      : Daniel Fischer</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Licence        : BSD3</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Maintainer     : Daniel Fischer &lt;daniel.is.fischer@googlemail.com&gt;</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Stability      : Provisional</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Portabiltity   : non-portable</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Author         : Daniel Fischer</span><span>
</span><a name="line-12"></a><span class="hs-comment">--</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Utilities for several searching algorithms.</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Search</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span><span> </span><span class="hs-special">(</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier hs-var">kmpBorders</span></a><span>
</span><a name="line-16"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-identifier hs-var">automaton</span></a><span>
</span><a name="line-17"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-identifier hs-var">occurs</span></a><span>
</span><a name="line-18"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-identifier hs-var">suffShifts</span></a><span>
</span><a name="line-19"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-var">ldrop</span></a><span>
</span><a name="line-20"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-var">ltake</span></a><span>
</span><a name="line-21"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-var">lsplit</span></a><span>
</span><a name="line-22"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var">release</span></a><span>
</span><a name="line-23"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var">keep</span></a><span>
</span><a name="line-24"></a><span>                                             </span><span class="hs-special">,</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-identifier hs-var">strictify</span></a><span>
</span><a name="line-25"></a><span>                                             </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeIndex</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeRead</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeAt</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">ST</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Array</span><span class="hs-operator">.</span><span class="hs-identifier">Unboxed</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-40"></a><span class="hs-comment">--                              Preprocessing                               --</span><span>
</span><a name="line-41"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-pragma">{-# INLINE automaton #-}</span><span>
</span><a name="line-44"></a><span class="hs-identifier">automaton</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UArray</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-45"></a><a name="automaton"><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-identifier">automaton</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032441"><a href="#local-6989586621679032441"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runSTUArray</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032442"><a href="#local-6989586621679032442"><span class="hs-identifier">patLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032441"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-47"></a><span>        </span><span class="hs-pragma">{-# INLINE patAt #-}</span><span>
</span><a name="line-48"></a><span>        </span><a name="local-6989586621679032443"><a href="#local-6989586621679032443"><span class="hs-identifier">patAt</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032445"><a href="#local-6989586621679032445"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeIndex</span><span> </span><a href="#local-6989586621679032441"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621679032445"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032444"><a href="#local-6989586621679032444"><span class="hs-identifier">bord</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier hs-var">kmpBorders</span></a><span> </span><a href="#local-6989586621679032441"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-50"></a><span>    </span><a name="local-6989586621679032446"><a href="#local-6989586621679032446"><span class="hs-identifier">aut</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032442"><span class="hs-identifier hs-var">patLen</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-operator hs-var">*</span><span class="hs-number">256</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-51"></a><span>    </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032446"><span class="hs-identifier hs-var">aut</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032443"><span class="hs-identifier hs-var">patAt</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679032447"><a href="#local-6989586621679032447"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032448"><a href="#local-6989586621679032448"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-53"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032449"><a href="#local-6989586621679032449"><span class="hs-identifier">base</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-54"></a><span>                </span><a name="local-6989586621679032450"><a href="#local-6989586621679032450"><span class="hs-identifier">inner</span></a></a><span> </span><a name="local-6989586621679032451"><a href="#local-6989586621679032451"><span class="hs-identifier">j</span></a></a><span>
</span><a name="line-55"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032451"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032442"><span class="hs-identifier hs-var">patLen</span></a><span>
</span><a name="line-56"></a><span>                                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032446"><span class="hs-identifier hs-var">aut</span></a><span>
</span><a name="line-57"></a><span>                                    </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679032447"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-59"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032452"><a href="#local-6989586621679032452"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032449"><span class="hs-identifier hs-var">base</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679032443"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032451"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-60"></a><span>                        </span><a name="local-6989586621679032453"><a href="#local-6989586621679032453"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unsafeRead</span><span> </span><a href="#local-6989586621679032446"><span class="hs-identifier hs-var">aut</span></a><span> </span><a href="#local-6989586621679032452"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-61"></a><span>                        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032453"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032446"><span class="hs-identifier hs-var">aut</span></a><span> </span><a href="#local-6989586621679032452"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032451"><span class="hs-identifier hs-var">j</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>                        </span><a href="#local-6989586621679032450"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeAt</span><span> </span><a href="#local-6989586621679032444"><span class="hs-identifier hs-var">bord</span></a><span> </span><a href="#local-6989586621679032451"><span class="hs-identifier hs-var">j</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032442"><span class="hs-identifier hs-var">patLen</span></a><span>
</span><a name="line-64"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679032450"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeAt</span><span> </span><a href="#local-6989586621679032444"><span class="hs-identifier hs-var">bord</span></a><span> </span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>                </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679032450"><span class="hs-identifier hs-var">inner</span></a><span> </span><a href="#local-6989586621679032448"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-66"></a><span>    </span><a href="#local-6989586621679032447"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- kmpBorders calculates the width of the widest borders of the prefixes</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- of the pattern which are not extensible to borders of the next</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- longer prefix. Most entries will be 0.</span><span>
</span><a name="line-71"></a><span class="hs-pragma">{-# INLINE kmpBorders #-}</span><span>
</span><a name="line-72"></a><span class="hs-identifier">kmpBorders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UArray</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-73"></a><a name="kmpBorders"><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier">kmpBorders</span></a></a><span> </span><a name="local-6989586621679032454"><a href="#local-6989586621679032454"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runSTUArray</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032455"><a href="#local-6989586621679032455"><span class="hs-identifier">patLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032454"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-75"></a><span>        </span><span class="hs-pragma">{-# INLINE patAt #-}</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-identifier">patAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word8</span><span>
</span><a name="line-77"></a><span>        </span><a name="local-6989586621679032456"><a href="#local-6989586621679032456"><span class="hs-identifier">patAt</span></a></a><span> </span><a name="local-6989586621679032457"><a href="#local-6989586621679032457"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeIndex</span><span> </span><a href="#local-6989586621679032454"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621679032457"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-78"></a><span>    </span><a name="local-6989586621679032458"><a href="#local-6989586621679032458"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newArray_</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679032455"><span class="hs-identifier hs-var">patLen</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679032459"><a href="#local-6989586621679032459"><span class="hs-identifier">dec</span></a></a><span> </span><a name="local-6989586621679032461"><a href="#local-6989586621679032461"><span class="hs-identifier">w</span></a></a><span> </span><a name="local-6989586621679032462"><a href="#local-6989586621679032462"><span class="hs-identifier">j</span></a></a><span>
</span><a name="line-81"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032462"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679032461"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032456"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032462"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621679032462"><span class="hs-identifier hs-var">j</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-82"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeRead</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032462"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679032459"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679032461"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-83"></a><span>        </span><a name="local-6989586621679032460"><a href="#local-6989586621679032460"><span class="hs-identifier">bordLoop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032463"><a href="#local-6989586621679032463"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032464"><a href="#local-6989586621679032464"><span class="hs-identifier">j</span></a></a><span>
</span><a name="line-84"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032455"><span class="hs-identifier hs-var">patLen</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-85"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032465"><a href="#local-6989586621679032465"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032456"><span class="hs-identifier hs-var">patAt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>                </span><a name="local-6989586621679032466"><a href="#local-6989586621679032466"><span class="hs-identifier">j'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679032459"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679032465"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621679032464"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-88"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032455"><span class="hs-identifier hs-var">patLen</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679032456"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032466"><span class="hs-identifier hs-var">j'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032456"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-89"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">unsafeRead</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032466"><span class="hs-identifier hs-var">j'</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-90"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032458"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679032466"><span class="hs-identifier hs-var">j'</span></a><span>
</span><a name="line-91"></a><span>                </span><a href="#local-6989586621679032460"><span class="hs-identifier hs-var">bordLoop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032463"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032466"><span class="hs-identifier hs-var">j'</span></a><span>
</span><a name="line-92"></a><span>    </span><a href="#local-6989586621679032460"><span class="hs-identifier hs-var">bordLoop</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-95"></a><span class="hs-comment">--                        Boyer-Moore Preprocessing                         --</span><span>
</span><a name="line-96"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">{- Table of last occurrences of bytes in the pattern.

For each byte we record the (negated) position of its last
occurrence in the pattern except at the last position.

Thus, if byte b gives a mismatch at pattern position patPos,
we know that we can shift the window right by at least

patPos - (last occurrence of b in init pat)

or, since we negated the positions,

patPos + (occurs pat)

If the byte doesn't occur in the pattern, we can shift the window
so that the start of the pattern is aligned with the byte after this,
hence the default value of 1.

Complexity: O(patLen + size of alphabet)

-}</span><span>
</span><a name="line-119"></a><span class="hs-comment">{- Precondition: non-empty pattern

This invariant is guaranteed by not exporting occurs,
inside this module, we don't call it for empty patterns.

-}</span><span>
</span><a name="line-125"></a><span class="hs-pragma">{-# INLINE occurs #-}</span><span>
</span><a name="line-126"></a><span class="hs-identifier">occurs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UArray</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-127"></a><a name="occurs"><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-identifier">occurs</span></a></a><span> </span><a name="local-6989586621679032467"><a href="#local-6989586621679032467"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runSTUArray</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032468"><a href="#local-6989586621679032468"><span class="hs-identifier">patEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032467"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-pragma">{-# INLINE patAt #-}</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-identifier">patAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-131"></a><span>        </span><a name="local-6989586621679032469"><a href="#local-6989586621679032469"><span class="hs-identifier">patAt</span></a></a><span> </span><a name="local-6989586621679032470"><a href="#local-6989586621679032470"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeIndex</span><span> </span><a href="#local-6989586621679032467"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621679032470"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>    </span><a name="local-6989586621679032471"><a href="#local-6989586621679032471"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">255</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679032472"><a href="#local-6989586621679032472"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032473"><a href="#local-6989586621679032473"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-134"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032473"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032468"><span class="hs-identifier hs-var">patEnd</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032471"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-135"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>                </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032471"><span class="hs-identifier hs-var">ar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032469"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032473"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><a href="#local-6989586621679032473"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>                </span><a href="#local-6989586621679032472"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032473"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>    </span><a href="#local-6989586621679032472"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">{- Table of suffix-shifts.

When a mismatch occurs at pattern position patPos, assumed to be not the
last position in the pattern, the suffix u of length (patEnd - patPos)
has been successfully matched.
Let c be the byte in the pattern at position patPos.

If the sub-pattern u also occurs in the pattern somewhere *not* preceded
by c, let uPos be the position of the last byte in u for the last of
all such occurrences. Then there can be no match if the window is shifted
less than (patEnd - uPos) places, because either the part of the string
which matched the suffix u is not aligned with an occurrence of u in the
pattern, or it is aligned with an occurrence of u which is preceded by
the same byte c as the originally matched suffix.

If the complete sub-pattern u does not occur again in the pattern, or all
of its occurrences are preceded by the byte c, then we can align the
pattern with the string so that a suffix v of u matches a prefix of the
pattern. If v is chosen maximal, no smaller shift can give a match, so
we can shift by at least (patLen - length v).

If a complete match is encountered, we can shift by at least the same
amount as if the first byte of the pattern was a mismatch, no complete
match is possible between these positions.

For non-periodic patterns, only very short suffixes will usually occur
again in the pattern, so if a longer suffix has been matched before a
mismatch, the window can then be shifted entirely past the partial
match, so that part of the string will not be re-compared.
For periodic patterns, the suffix shifts will be shorter in general,
leading to an O(strLen * patLen) worst-case performance.

To compute the suffix-shifts, we use an array containing the lengths of
the longest common suffixes of the entire pattern and its prefix ending
with position pos.

-}</span><span>
</span><a name="line-177"></a><span class="hs-comment">{- Precondition: non-empty pattern -}</span><span>
</span><a name="line-178"></a><span class="hs-pragma">{-# INLINE suffShifts #-}</span><span>
</span><a name="line-179"></a><span class="hs-identifier">suffShifts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UArray</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-180"></a><a name="suffShifts"><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-identifier">suffShifts</span></a></a><span> </span><a name="local-6989586621679032474"><a href="#local-6989586621679032474"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runSTUArray</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032475"><a href="#local-6989586621679032475"><span class="hs-identifier">patLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032474"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-182"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032476"><a href="#local-6989586621679032476"><span class="hs-identifier">patEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032475"><span class="hs-identifier hs-var">patLen</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032477"><a href="#local-6989586621679032477"><span class="hs-identifier">suff</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-identifier hs-var">suffLengths</span></a><span> </span><a href="#local-6989586621679032474"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-184"></a><span>    </span><a name="local-6989586621679032478"><a href="#local-6989586621679032478"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032475"><span class="hs-identifier hs-var">patLen</span></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679032479"><a href="#local-6989586621679032479"><span class="hs-identifier">preShift</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032481"><a href="#local-6989586621679032481"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032482"><a href="#local-6989586621679032482"><span class="hs-identifier">j</span></a></a><span>
</span><a name="line-186"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032477"><span class="hs-identifier hs-var">suff</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unsafeAt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-188"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032483"><a href="#local-6989586621679032483"><span class="hs-identifier">shf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-189"></a><span>                    </span><a name="local-6989586621679032484"><a href="#local-6989586621679032484"><span class="hs-identifier">fillToShf</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032485"><a href="#local-6989586621679032485"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-190"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032485"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032483"><span class="hs-identifier hs-var">shf</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-192"></a><span>                            </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032478"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032485"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679032483"><span class="hs-identifier hs-var">shf</span></a><span>
</span><a name="line-193"></a><span>                            </span><a href="#local-6989586621679032484"><span class="hs-identifier hs-var">fillToShf</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032485"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>                </span><a href="#local-6989586621679032484"><span class="hs-identifier hs-var">fillToShf</span></a><span> </span><a href="#local-6989586621679032482"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-195"></a><span>                </span><a href="#local-6989586621679032479"><span class="hs-identifier hs-var">preShift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032483"><span class="hs-identifier hs-var">shf</span></a><span>
</span><a name="line-196"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032479"><span class="hs-identifier hs-var">preShift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032481"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032482"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-197"></a><span>        </span><a name="local-6989586621679032480"><a href="#local-6989586621679032480"><span class="hs-identifier">sufShift</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032486"><a href="#local-6989586621679032486"><span class="hs-identifier">idx</span></a></a><span>
</span><a name="line-198"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032486"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032478"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-199"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-200"></a><span>                </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032478"><span class="hs-identifier hs-var">ar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">unsafeAt</span><span> </span><a href="#local-6989586621679032477"><span class="hs-identifier hs-var">suff</span></a><span> </span><a href="#local-6989586621679032486"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032486"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>                </span><a href="#local-6989586621679032480"><span class="hs-identifier hs-var">sufShift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032486"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>    </span><a href="#local-6989586621679032479"><span class="hs-identifier hs-var">preShift</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032476"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-203"></a><span>    </span><a href="#local-6989586621679032480"><span class="hs-identifier hs-var">sufShift</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">{- Table of suffix-lengths.

The value of this array at place i is the length of the longest common
suffix of the entire pattern and the prefix of the pattern ending at
position i.

Usually, most of the entries will be 0. Only if the byte at position i
is the same as the last byte of the pattern can the value be positive.
In any case the value at index patEnd is patLen (since the pattern is
identical to itself) and 0 &lt;= value at i &lt;= (i + 1).

To keep this part of preprocessing linear in the length of the pattern,
the implementation must be non-obvious (the obvious algorithm for this
is quadratic).

When the index under consideration is inside a previously identified
common suffix, we align that suffix with the end of the pattern and
check whether the suffix ending at the position corresponding to idx
is shorter than the part of the suffix up to idx. If that is the case,
the length of the suffix ending at idx is that of the suffix at the
corresponding position. Otherwise extend the suffix as far as possible.
If the index under consideration is not inside a previously identified
common suffix, compare with the last byte of the pattern. If that gives
a suffix of length &gt; 1, for the next index we're in the previous
situation, otherwise we're back in the same situation for the next
index.

-}</span><span>
</span><a name="line-233"></a><span class="hs-comment">{- Precondition: non-empty pattern -}</span><span>
</span><a name="line-234"></a><span class="hs-pragma">{-# INLINE suffLengths #-}</span><span>
</span><a name="line-235"></a><span class="hs-identifier">suffLengths</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UArray</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-236"></a><a name="suffLengths"><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-identifier">suffLengths</span></a></a><span> </span><a name="local-6989586621679032487"><a href="#local-6989586621679032487"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runSTUArray</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032488"><a href="#local-6989586621679032488"><span class="hs-identifier">patLen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032487"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-238"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032489"><a href="#local-6989586621679032489"><span class="hs-identifier">patEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032488"><span class="hs-identifier hs-var">patLen</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032490"><a href="#local-6989586621679032490"><span class="hs-identifier">preEnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-pragma">{-# INLINE patAt #-}</span><span>
</span><a name="line-241"></a><span>        </span><a name="local-6989586621679032491"><a href="#local-6989586621679032491"><span class="hs-identifier">patAt</span></a></a><span> </span><a name="local-6989586621679032494"><a href="#local-6989586621679032494"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeIndex</span><span> </span><a href="#local-6989586621679032487"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621679032494"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-comment">-- last byte for comparisons</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679032492"><a href="#local-6989586621679032492"><span class="hs-identifier">pe</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032491"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- find index preceding the longest suffix</span><span>
</span><a name="line-245"></a><span>        </span><a name="local-6989586621679032493"><a href="#local-6989586621679032493"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032495"><a href="#local-6989586621679032495"><span class="hs-identifier">diff</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032496"><a href="#local-6989586621679032496"><span class="hs-identifier">j</span></a></a><span>
</span><a name="line-246"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032496"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679032491"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032496"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679032491"><span class="hs-identifier hs-var">patAt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032496"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679032495"><span class="hs-identifier hs-var">diff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032496"><span class="hs-identifier hs-var">j</span></a><span>
</span><a name="line-247"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032493"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679032495"><span class="hs-identifier hs-var">diff</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032496"><span class="hs-identifier hs-var">j</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>    </span><a name="local-6989586621679032497"><a href="#local-6989586621679032497"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newArray_</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>    </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><a href="#local-6989586621679032488"><span class="hs-identifier hs-var">patLen</span></a><span>
</span><a name="line-250"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679032498"><a href="#local-6989586621679032498"><span class="hs-identifier">noSuff</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032500"><a href="#local-6989586621679032500"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-251"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-252"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032491"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032492"><span class="hs-identifier hs-var">pe</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-253"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032501"><a href="#local-6989586621679032501"><span class="hs-identifier">diff</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-254"></a><span>                    </span><span class="hs-glyph">!</span><a name="local-6989586621679032502"><a href="#local-6989586621679032502"><span class="hs-identifier">nextI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-255"></a><span>                    </span><span class="hs-glyph">!</span><a name="local-6989586621679032503"><a href="#local-6989586621679032503"><span class="hs-identifier">prevI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032493"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679032501"><span class="hs-identifier hs-var">diff</span></a><span> </span><a href="#local-6989586621679032502"><span class="hs-identifier hs-var">nextI</span></a><span>
</span><a name="line-256"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032503"><span class="hs-identifier hs-var">prevI</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679032502"><span class="hs-identifier hs-var">nextI</span></a><span>
</span><a name="line-257"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679032498"><span class="hs-identifier hs-var">noSuff</span></a><span> </span><a href="#local-6989586621679032502"><span class="hs-identifier hs-var">nextI</span></a><span>
</span><a name="line-258"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032503"><span class="hs-identifier hs-var">prevI</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>                            </span><a href="#local-6989586621679032499"><span class="hs-identifier hs-var">suffLoop</span></a><span> </span><a href="#local-6989586621679032503"><span class="hs-identifier hs-var">prevI</span></a><span> </span><a href="#local-6989586621679032490"><span class="hs-identifier hs-var">preEnd</span></a><span> </span><a href="#local-6989586621679032502"><span class="hs-identifier hs-var">nextI</span></a><span>
</span><a name="line-260"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>                </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-262"></a><span>                </span><a href="#local-6989586621679032498"><span class="hs-identifier hs-var">noSuff</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032500"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>        </span><a name="local-6989586621679032499"><a href="#local-6989586621679032499"><span class="hs-identifier">suffLoop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032504"><a href="#local-6989586621679032504"><span class="hs-identifier">pre</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032505"><a href="#local-6989586621679032505"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032506"><a href="#local-6989586621679032506"><span class="hs-identifier">idx</span></a></a><span>
</span><a name="line-264"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-265"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032504"><span class="hs-identifier hs-var">pre</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-266"></a><span>              </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032491"><span class="hs-identifier hs-var">patAt</span></a><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679032492"><span class="hs-identifier hs-var">pe</span></a><span>
</span><a name="line-267"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679032499"><span class="hs-identifier hs-var">suffLoop</span></a><span> </span><a href="#local-6989586621679032504"><span class="hs-identifier hs-var">pre</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032505"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-269"></a><span>                    </span><a name="local-6989586621679032507"><a href="#local-6989586621679032507"><span class="hs-identifier">prevS</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unsafeRead</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032505"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-270"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679032504"><span class="hs-identifier hs-var">pre</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679032507"><span class="hs-identifier hs-var">prevS</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-271"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><a href="#local-6989586621679032507"><span class="hs-identifier hs-var">prevS</span></a><span>
</span><a name="line-272"></a><span>                                </span><a href="#local-6989586621679032499"><span class="hs-identifier hs-var">suffLoop</span></a><span> </span><a href="#local-6989586621679032504"><span class="hs-identifier hs-var">pre</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032505"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032508"><a href="#local-6989586621679032508"><span class="hs-identifier">prI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032493"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032489"><span class="hs-identifier hs-var">patEnd</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032504"><span class="hs-identifier hs-var">pre</span></a><span>
</span><a name="line-274"></a><span>                                </span><span class="hs-identifier hs-var">unsafeWrite</span><span> </span><a href="#local-6989586621679032497"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032508"><span class="hs-identifier hs-var">prI</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>                                </span><a href="#local-6989586621679032499"><span class="hs-identifier hs-var">suffLoop</span></a><span> </span><a href="#local-6989586621679032508"><span class="hs-identifier hs-var">prI</span></a><span> </span><a href="#local-6989586621679032490"><span class="hs-identifier hs-var">preEnd</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032498"><span class="hs-identifier hs-var">noSuff</span></a><span> </span><a href="#local-6989586621679032506"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-277"></a><span>    </span><a href="#local-6989586621679032498"><span class="hs-identifier hs-var">noSuff</span></a><span> </span><a href="#local-6989586621679032490"><span class="hs-identifier hs-var">preEnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-280"></a><span class="hs-comment">--                             Helper Functions                             --</span><span>
</span><a name="line-281"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-pragma">{-# INLINE strictify #-}</span><span>
</span><a name="line-284"></a><span class="hs-identifier">strictify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">L</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-285"></a><a name="strictify"><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-identifier">strictify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toChunks</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- drop k bytes from a list of strict ByteStrings</span><span>
</span><a name="line-288"></a><span class="hs-pragma">{-# INLINE ldrop #-}</span><span>
</span><a name="line-289"></a><span class="hs-identifier">ldrop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><a name="ldrop"><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier">ldrop</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-291"></a><span class="hs-identifier">ldrop</span><span> </span><a name="local-6989586621679032509"><a href="#local-6989586621679032509"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032510"><a href="#local-6989586621679032510"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679032511"><a href="#local-6989586621679032511"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032509"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032512"><span class="hs-identifier hs-var">l</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621679032509"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679032510"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679032511"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-var">ldrop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032509"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032512"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032511"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-294"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>      </span><span class="hs-glyph">!</span><a name="local-6989586621679032512"><a href="#local-6989586621679032512"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032510"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- take k bytes from a list of strict ByteStrings</span><span>
</span><a name="line-298"></a><span class="hs-pragma">{-# INLINE ltake #-}</span><span>
</span><a name="line-299"></a><span class="hs-identifier">ltake</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span>
</span><a name="line-300"></a><a name="ltake"><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier">ltake</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-301"></a><span class="hs-identifier">ltake</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032513"><a href="#local-6989586621679032513"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032514"><a href="#local-6989586621679032514"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679032515"><a href="#local-6989586621679032515"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032516"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679032513"><span class="hs-identifier hs-var">k</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679032514"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-var">ltake</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032513"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032516"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032515"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679032513"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679032514"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">]</span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-305"></a><span>      </span><span class="hs-glyph">!</span><a name="local-6989586621679032516"><a href="#local-6989586621679032516"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032514"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-comment">-- split a list of strict ByteStrings at byte k</span><span>
</span><a name="line-308"></a><span class="hs-pragma">{-# INLINE lsplit #-}</span><span>
</span><a name="line-309"></a><span class="hs-identifier">lsplit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><a name="lsplit"><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier">lsplit</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span class="hs-identifier">lsplit</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032517"><a href="#local-6989586621679032517"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032518"><a href="#local-6989586621679032518"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679032519"><a href="#local-6989586621679032519"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621679032517"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679032520"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-313"></a><span>      </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679032517"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679032518"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621679032517"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679032518"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679032519"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>      </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679032518"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679032519"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>      </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679032521"><a href="#local-6989586621679032521"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679032522"><a href="#local-6989586621679032522"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-var">lsplit</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032517"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679032520"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032519"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032518"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679032521"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679032522"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-glyph">!</span><a name="local-6989586621679032520"><a href="#local-6989586621679032520"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032518"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-comment">-- release is used to keep the zipper in lazySearcher from remembering</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- the leading part of the searched string.  The deep parameter is the</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- number of characters that the past needs to hold.  This ensures</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- lazy streaming consumption of the searched string.</span><span>
</span><a name="line-324"></a><span class="hs-pragma">{-# INLINE release #-}</span><span>
</span><a name="line-325"></a><span class="hs-identifier">release</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span>
</span><a name="line-326"></a><a name="release"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier">release</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032523"><a href="#local-6989586621679032523"><span class="hs-identifier">deep</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032523"><span class="hs-identifier hs-var">deep</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-328"></a><span class="hs-identifier">release</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032524"><a href="#local-6989586621679032524"><span class="hs-identifier">deep</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032525"><a href="#local-6989586621679032525"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679032526"><a href="#local-6989586621679032526"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032527"><a href="#local-6989586621679032527"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var">release</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032524"><span class="hs-identifier hs-var">deep</span></a><span class="hs-glyph">-</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032525"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032526"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679032525"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679032527"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-329"></a><span class="hs-identifier">release</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;stringsearch.release could not find enough past!&quot;</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-comment">-- keep is like release, only we mustn't forget the part of the past</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- we don't need anymore for matching but have to keep it for</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- breaking, splitting and replacing.</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- The names would be more appropriate the other way round, but that's</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- a historical accident, so what?</span><span>
</span><a name="line-336"></a><span class="hs-pragma">{-# INLINE keep #-}</span><span>
</span><a name="line-337"></a><span class="hs-identifier">keep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><a name="keep"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier">keep</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679032558"><a href="#local-6989586621679032558"><span class="hs-identifier">deep</span></a></a><span> </span><a name="local-6989586621679032559"><a href="#local-6989586621679032559"><span class="hs-identifier">xs</span></a></a><span>
</span><a name="line-339"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032558"><span class="hs-identifier hs-var">deep</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621679032559"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span class="hs-identifier">keep</span><span> </span><a name="local-6989586621679032560"><a href="#local-6989586621679032560"><span class="hs-identifier">deep</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032561"><a href="#local-6989586621679032561"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679032562"><a href="#local-6989586621679032562"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679032563"><a href="#local-6989586621679032563"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621679032564"><a href="#local-6989586621679032564"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var">keep</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032560"><span class="hs-identifier hs-var">deep</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679032561"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679032562"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679032561"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679032563"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><a href="#local-6989586621679032564"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span class="hs-identifier">keep</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Forgot too much&quot;</span><span>
</span><a name="line-342"></a></pre></body></html>