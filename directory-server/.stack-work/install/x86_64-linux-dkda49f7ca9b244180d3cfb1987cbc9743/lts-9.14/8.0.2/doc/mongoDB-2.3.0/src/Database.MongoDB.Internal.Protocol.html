<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Low-level messaging between this client and the MongoDB server, see Mongo</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- Wire Protocol (&lt;http://www.mongodb.org/display/DOCS/Mongo+Wire+Protocol&gt;).</span><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- This module is not intended for direct use. Use the high-level interface at</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- &quot;Database.MongoDB.Query&quot; and &quot;Database.MongoDB.Connection&quot; instead.</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards, StandaloneDeriving, OverloadedStrings #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP, FlexibleContexts, TupleSections, TypeSynonymInstances #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses, FlexibleInstances, UndecidableInstances #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns, ScopedTypeVariables #-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-cpp">#if (__GLASGOW_HASKELL__ &gt;= 706)</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE RecursiveDo #-}</span><span>
</span><a name="line-16"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE DoRec #-}</span><span>
</span><a name="line-18"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-21"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-comment">-- * Pipe</span><span>
</span><a name="line-23"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipe"><span class="hs-identifier hs-var">newPipe</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipeWith"><span class="hs-identifier hs-var">newPipeWith</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier hs-var">send</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#call"><span class="hs-identifier hs-var">call</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>    </span><span class="hs-comment">-- ** Notice</span><span>
</span><a name="line-25"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-comment">-- ** Request</span><span>
</span><a name="line-27"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>    </span><span class="hs-comment">-- ** Reply</span><span>
</span><a name="line-29"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier hs-type">ResponseFlag</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-comment">-- * Authentication</span><span>
</span><a name="line-31"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Nonce"><span class="hs-identifier hs-type">Nonce</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwHash"><span class="hs-identifier hs-var">pwHash</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier hs-var">pwKey</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier hs-var">isClosed</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,8,0)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Get</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Get</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runGet</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Put</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Put</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runPut</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">testBit</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">doesNotExistErrorType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkIOError</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeToList</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Conc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ThreadStatus</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">threadStatus</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forever</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Chan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Chan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newChan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readChan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isEmptyChan</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ThreadId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">killThread</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">forkFinally</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">onException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bson</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getDocument</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putDocument</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putInt32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getInt64</span><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>                         </span><span class="hs-identifier hs-var">putInt64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putCString</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Hash</span><span class="hs-operator">.</span><span class="hs-identifier">MD5</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MD5</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TE</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Util.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Util.html#bitOr"><span class="hs-identifier hs-var">bitOr</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Util.html#byteStringHex"><span class="hs-identifier hs-var">byteStringHex</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Transport.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transport</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.MongoDB.Transport.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transport</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Tr</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-cpp">#if MIN_VERSION_base(4,6,0)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>                                       </span><span class="hs-identifier hs-var">putMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkWeakMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isEmptyMVar</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span class="hs-operator">.</span><span class="hs-identifier">Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newEmptyMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">withMVar</span><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>                                         </span><span class="hs-identifier">putMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">readMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">addMVarFinalizer</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,6,0)</span><span>
</span><a name="line-81"></a><span class="hs-identifier">mkWeakMVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">MVar</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-identifier">mkWeakMVar</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">addMVarFinalizer</span><span>
</span><a name="line-83"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">-- * Pipeline</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- | Thread-safe and pipelined connection</span><span>
</span><a name="line-88"></a><span class="hs-keyword">data</span><span> </span><a name="Pipeline"><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier">Pipeline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Pipeline"><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier">Pipeline</span></a></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="vStream"><a href="Database.MongoDB.Internal.Protocol.html#vStream"><span class="hs-identifier">vStream</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span> </span><span class="hs-comment">-- ^ Mutex on handle, so only one thread at a time can write to it</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="responseQueue"><a href="Database.MongoDB.Internal.Protocol.html#responseQueue"><span class="hs-identifier">responseQueue</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Chan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">IOError</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Response"><span class="hs-identifier hs-type">Response</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Queue of threads waiting for responses. Every time a response arrive we pop the next thread and give it the response.</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="listenThread"><a href="Database.MongoDB.Internal.Protocol.html#listenThread"><span class="hs-identifier">listenThread</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThreadId</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="finished"><a href="Database.MongoDB.Internal.Protocol.html#finished"><span class="hs-identifier">finished</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="serverData"><a href="Database.MongoDB.Internal.Protocol.html#serverData"><span class="hs-identifier">serverData</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span>
</span><a name="line-94"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="ServerData"><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier">ServerData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ServerData"><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier">ServerData</span></a></a><span>
</span><a name="line-97"></a><span>                </span><span class="hs-special">{</span><span> </span><a name="isMaster"><a href="Database.MongoDB.Internal.Protocol.html#isMaster"><span class="hs-identifier">isMaster</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-98"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="minWireVersion"><a href="Database.MongoDB.Internal.Protocol.html#minWireVersion"><span class="hs-identifier">minWireVersion</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-99"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="maxWireVersion"><a href="Database.MongoDB.Internal.Protocol.html#maxWireVersion"><span class="hs-identifier">maxWireVersion</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-100"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="maxMessageSizeBytes"><a href="Database.MongoDB.Internal.Protocol.html#maxMessageSizeBytes"><span class="hs-identifier">maxMessageSizeBytes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-101"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="maxBsonObjectSize"><a href="Database.MongoDB.Internal.Protocol.html#maxBsonObjectSize"><span class="hs-identifier">maxBsonObjectSize</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-102"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="maxWriteBatchSize"><a href="Database.MongoDB.Internal.Protocol.html#maxWriteBatchSize"><span class="hs-identifier">maxWriteBatchSize</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-103"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- | Create new Pipeline over given handle. You should 'close' pipeline when finished, which will also close handle. If pipeline is not closed but eventually garbage collected, it will be closed along with handle.</span><span>
</span><a name="line-106"></a><span class="hs-identifier">newPipeline</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span>
</span><a name="line-107"></a><a name="newPipeline"><a href="Database.MongoDB.Internal.Protocol.html#newPipeline"><span class="hs-identifier">newPipeline</span></a></a><span> </span><a name="local-6989586621679082967"><a href="#local-6989586621679082967"><span class="hs-identifier">serverData</span></a></a><span> </span><a name="local-6989586621679082968"><a href="#local-6989586621679082968"><span class="hs-identifier">stream</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-108"></a><span>    </span><a name="local-6989586621679082969"><a href="#local-6989586621679082969"><span class="hs-identifier">vStream</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="#local-6989586621679082968"><span class="hs-identifier hs-var">stream</span></a><span>
</span><a name="line-109"></a><span>    </span><a name="local-6989586621679082970"><a href="#local-6989586621679082970"><span class="hs-identifier">responseQueue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newChan</span><span>
</span><a name="line-110"></a><span>    </span><a name="local-6989586621679082971"><a href="#local-6989586621679082971"><span class="hs-identifier">finished</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082972"><a href="#local-6989586621679082972"><span class="hs-identifier">drainReplies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>          </span><a name="local-6989586621679082973"><a href="#local-6989586621679082973"><span class="hs-identifier">chanEmpty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isEmptyChan</span><span> </span><a href="#local-6989586621679082970"><span class="hs-identifier hs-var">responseQueue</span></a><span>
</span><a name="line-113"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679082973"><span class="hs-identifier hs-var">chanEmpty</span></a><span>
</span><a name="line-114"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-116"></a><span>              </span><a name="local-6989586621679082974"><a href="#local-6989586621679082974"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679082970"><span class="hs-identifier hs-var">responseQueue</span></a><span>
</span><a name="line-117"></a><span>              </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679082974"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkIOError</span><span>
</span><a name="line-118"></a><span>                                        </span><span class="hs-identifier hs-var">doesNotExistErrorType</span><span>
</span><a name="line-119"></a><span>                                        </span><span class="hs-string">&quot;Handle has been closed&quot;</span><span>
</span><a name="line-120"></a><span>                                        </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-121"></a><span>                                        </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-122"></a><span>              </span><a href="#local-6989586621679082972"><span class="hs-identifier hs-var">drainReplies</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-identifier">rec</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082975"><a href="#local-6989586621679082975"><span class="hs-identifier">pipe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-126"></a><span>        </span><a name="local-6989586621679082976"><a href="#local-6989586621679082976"><span class="hs-identifier">listenThread</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forkFinally</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#listen"><span class="hs-identifier hs-var">listen</span></a><span> </span><a href="#local-6989586621679082975"><span class="hs-identifier hs-var">pipe</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-127"></a><span>                                                       </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679082971"><span class="hs-identifier hs-var">finished</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>                                                       </span><a href="#local-6989586621679082972"><span class="hs-identifier hs-var">drainReplies</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkWeakMVar</span><span> </span><a href="#local-6989586621679082969"><span class="hs-identifier hs-var">vStream</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679082976"><span class="hs-identifier hs-var">listenThread</span></a><span>
</span><a name="line-132"></a><span>        </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">close</span><span> </span><a href="#local-6989586621679082968"><span class="hs-identifier hs-var">stream</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679082975"><span class="hs-identifier hs-var">pipe</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">isFinished</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-136"></a><a name="isFinished"><a href="Database.MongoDB.Internal.Protocol.html#isFinished"><span class="hs-identifier">isFinished</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span> </span><span class="hs-special">{</span><a name="local-6989586621679082977"><a href="#local-6989586621679082977"><span class="hs-identifier">finished</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-137"></a><span>  </span><a name="local-6989586621679082978"><a href="#local-6989586621679082978"><span class="hs-identifier">empty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isEmptyMVar</span><span> </span><a href="#local-6989586621679082977"><span class="hs-identifier hs-var">finished</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679082978"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-identifier">close</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- ^ Close pipe and underlying connection</span><span>
</span><a name="line-142"></a><a name="close"><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier">close</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-identifier hs-var">killThread</span><span> </span><a href="#local-6989586621679082981"><span class="hs-identifier hs-var">listenThread</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">close</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679082979"><span class="hs-identifier hs-var">vStream</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">isClosed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-147"></a><a name="isClosed"><a href="Database.MongoDB.Internal.Protocol.html#isClosed"><span class="hs-identifier">isClosed</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><a name="local-6989586621679082984"><a href="#local-6989586621679082984"><span class="hs-identifier">listenThread</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-148"></a><span>    </span><a name="local-6989586621679082985"><a href="#local-6989586621679082985"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">threadStatus</span><span> </span><a href="#local-6989586621679082984"><span class="hs-identifier hs-var">listenThread</span></a><span>
</span><a name="line-149"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082985"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-identifier hs-var">ThreadRunning</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-identifier hs-var">ThreadFinished</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-identifier hs-var">ThreadBlocked</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-identifier hs-var">ThreadDied</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-154"></a><span class="hs-comment">--isPipeClosed Pipeline{..} = isClosed =&lt;&lt; readMVar vHandle  -- isClosed hangs while listen loop is waiting on read</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">listen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- ^ Listen for responses and supply them to waiting threads in order</span><span>
</span><a name="line-158"></a><a name="listen"><a href="Database.MongoDB.Internal.Protocol.html#listen"><span class="hs-identifier">listen</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-6989586621679082991"><a href="#local-6989586621679082991"><span class="hs-identifier">stream</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679082986"><span class="hs-identifier hs-var">vStream</span></a><span>
</span><a name="line-160"></a><span>    </span><span class="hs-identifier hs-var">forever</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>        </span><a name="local-6989586621679082992"><a href="#local-6989586621679082992"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#readMessage"><span class="hs-identifier hs-var">readMessage</span></a><span> </span><a href="#local-6989586621679082991"><span class="hs-identifier hs-var">stream</span></a><span>
</span><a name="line-162"></a><span>        </span><a name="local-6989586621679082993"><a href="#local-6989586621679082993"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readChan</span><span> </span><a href="#local-6989586621679082987"><span class="hs-identifier hs-var">responseQueue</span></a><span>
</span><a name="line-163"></a><span>        </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679082993"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679082992"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-164"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082992"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-165"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679082994"><a href="#local-6989586621679082994"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">close</span><span> </span><a href="#local-6989586621679082991"><span class="hs-identifier hs-var">stream</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><a href="#local-6989586621679082994"><span class="hs-identifier hs-var">err</span></a><span>  </span><span class="hs-comment">-- close and stop looping</span><span>
</span><a name="line-166"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-identifier">psend</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- ^ Send message to destination; the destination must not response (otherwise future 'call's will get these responses instead of their own).</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- Throw IOError and close pipeline if send fails</span><span>
</span><a name="line-171"></a><a name="psend"><a href="Database.MongoDB.Internal.Protocol.html#psend"><span class="hs-identifier">psend</span></a></a><span> </span><a name="local-6989586621679082995"><a href="#local-6989586621679082995"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679083001"><a href="#local-6989586621679083001"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679082996"><span class="hs-identifier hs-var">vStream</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#writeMessage"><span class="hs-identifier hs-var">writeMessage</span></a><span> </span><a href="#local-6989586621679083001"><span class="hs-identifier hs-var">message</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">onException</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679082995"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">pcall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Response"><span class="hs-identifier hs-type">Response</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- ^ Send message to destination and return /promise/ of response from one message only. The destination must reply to the message (otherwise promises will have the wrong responses in them).</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- Throw IOError and closes pipeline if send fails, likewise for promised response.</span><span>
</span><a name="line-176"></a><a name="pcall"><a href="Database.MongoDB.Internal.Protocol.html#pcall"><span class="hs-identifier">pcall</span></a></a><span> </span><a name="local-6989586621679083002"><a href="#local-6989586621679083002"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-var">Pipeline</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679083008"><a href="#local-6989586621679083008"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>  </span><a name="local-6989586621679083012"><a href="#local-6989586621679083012"><span class="hs-identifier">listenerStopped</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#isFinished"><span class="hs-identifier hs-var">isFinished</span></a><span> </span><a href="#local-6989586621679083002"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-178"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679083012"><span class="hs-identifier hs-var">listenerStopped</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkIOError</span><span> </span><span class="hs-identifier hs-var">doesNotExistErrorType</span><span> </span><span class="hs-string">&quot;Handle has been closed&quot;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621679083003"><span class="hs-identifier hs-var">vStream</span></a><span> </span><a href="#local-6989586621679083009"><span class="hs-identifier hs-var">doCall</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">onException</span><span class="hs-special">`</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><a href="#local-6989586621679083002"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>    </span><a name="local-6989586621679083009"><a href="#local-6989586621679083009"><span class="hs-identifier">doCall</span></a></a><span> </span><a name="local-6989586621679083010"><a href="#local-6989586621679083010"><span class="hs-identifier">stream</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-183"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#writeMessage"><span class="hs-identifier hs-var">writeMessage</span></a><span> </span><a href="#local-6989586621679083010"><span class="hs-identifier hs-var">stream</span></a><span> </span><a href="#local-6989586621679083008"><span class="hs-identifier hs-var">message</span></a><span>
</span><a name="line-184"></a><span>        </span><a name="local-6989586621679083011"><a href="#local-6989586621679083011"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-185"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeChan</span><span> </span><a href="#local-6989586621679083004"><span class="hs-identifier hs-var">responseQueue</span></a><span> </span><a href="#local-6989586621679083011"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-186"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679083011"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-comment">-- return promise</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- * Pipe</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">type</span><span> </span><a name="Pipe"><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier">Pipe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipeline"><span class="hs-identifier hs-type">Pipeline</span></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- ^ Thread-safe TCP connection with pipelined requests</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">newPipe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- ^ Create pipe over handle</span><span>
</span><a name="line-195"></a><a name="newPipe"><a href="Database.MongoDB.Internal.Protocol.html#newPipe"><span class="hs-identifier">newPipe</span></a></a><span> </span><a name="local-6989586621679083013"><a href="#local-6989586621679083013"><span class="hs-identifier">sd</span></a></a><span> </span><a name="local-6989586621679083014"><a href="#local-6989586621679083014"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Transport.html#fromHandle"><span class="hs-identifier hs-var">Tr</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromHandle</span></a><span> </span><a href="#local-6989586621679083014"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#newPipeWith"><span class="hs-identifier hs-var">newPipeWith</span></a><span> </span><a href="#local-6989586621679083013"><span class="hs-identifier hs-var">sd</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-identifier">newPipeWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ServerData"><span class="hs-identifier hs-type">ServerData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- ^ Create pipe over connection</span><span>
</span><a name="line-199"></a><a name="newPipeWith"><a href="Database.MongoDB.Internal.Protocol.html#newPipeWith"><span class="hs-identifier">newPipeWith</span></a></a><span> </span><a name="local-6989586621679083015"><a href="#local-6989586621679083015"><span class="hs-identifier">sd</span></a></a><span> </span><a name="local-6989586621679083016"><a href="#local-6989586621679083016"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipeline"><span class="hs-identifier hs-var">newPipeline</span></a><span> </span><a href="#local-6989586621679083015"><span class="hs-identifier hs-var">sd</span></a><span> </span><a href="#local-6989586621679083016"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-identifier">send</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- ^ Send notices as a contiguous batch to server with no reply. Throw IOError if connection fails.</span><span>
</span><a name="line-203"></a><a name="send"><a href="Database.MongoDB.Internal.Protocol.html#send"><span class="hs-identifier">send</span></a></a><span> </span><a name="local-6989586621679083017"><a href="#local-6989586621679083017"><span class="hs-identifier">pipe</span></a></a><span> </span><a name="local-6989586621679083018"><a href="#local-6989586621679083018"><span class="hs-identifier">notices</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#psend"><span class="hs-identifier hs-var">psend</span></a><span> </span><a href="#local-6989586621679083017"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083018"><span class="hs-identifier hs-var">notices</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-identifier">call</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- ^ Send notices and request as a contiguous batch to server and return reply promise, which will block when invoked until reply arrives. This call and resulting promise will throw IOError if connection fails.</span><span>
</span><a name="line-207"></a><a name="call"><a href="Database.MongoDB.Internal.Protocol.html#call"><span class="hs-identifier">call</span></a></a><span> </span><a name="local-6989586621679083019"><a href="#local-6989586621679083019"><span class="hs-identifier">pipe</span></a></a><span> </span><a name="local-6989586621679083020"><a href="#local-6989586621679083020"><span class="hs-identifier">notices</span></a></a><span> </span><a name="local-6989586621679083021"><a href="#local-6989586621679083021"><span class="hs-identifier">request</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-208"></a><span>    </span><a name="local-6989586621679083026"><a href="#local-6989586621679083026"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#genRequestId"><span class="hs-identifier hs-var">genRequestId</span></a><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621679083027"><a href="#local-6989586621679083027"><span class="hs-identifier">promise</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pcall"><span class="hs-identifier hs-var">pcall</span></a><span> </span><a href="#local-6989586621679083019"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083020"><span class="hs-identifier hs-var">notices</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083021"><span class="hs-identifier hs-var">request</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679083026"><span class="hs-identifier hs-var">requestId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679083022"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621679083026"><span class="hs-identifier hs-var">requestId</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679083027"><span class="hs-identifier hs-var">promise</span></a><span>
</span><a name="line-211"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621679083022"><a href="#local-6989586621679083022"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621679083023"><a href="#local-6989586621679083023"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679083024"><a href="#local-6989586621679083024"><span class="hs-identifier">responseTo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679083025"><a href="#local-6989586621679083025"><span class="hs-identifier">reply</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679083023"><span class="hs-identifier hs-var">requestId</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679083024"><span class="hs-identifier hs-var">responseTo</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679083025"><span class="hs-identifier hs-var">reply</span></a><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;expected response id (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679083024"><span class="hs-identifier hs-var">responseTo</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;) to match request id (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679083023"><span class="hs-identifier hs-var">requestId</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- * Message</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-keyword">type</span><span> </span><a name="Message"><a href="Database.MongoDB.Internal.Protocol.html#Message"><span class="hs-identifier">Message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- ^ A write notice(s) with getLastError request, or just query request.</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- Note, that requestId will be out of order because request ids will be generated for notices after the request id supplied was generated. This is ok because the mongo server does not care about order just uniqueness.</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-identifier">writeMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- ^ Write message to connection</span><span>
</span><a name="line-223"></a><a name="writeMessage"><a href="Database.MongoDB.Internal.Protocol.html#writeMessage"><span class="hs-identifier">writeMessage</span></a></a><span> </span><a name="local-6989586621679083028"><a href="#local-6989586621679083028"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679083029"><a href="#local-6989586621679083029"><span class="hs-identifier">notices</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679083030"><a href="#local-6989586621679083030"><span class="hs-identifier">mRequest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621679083508"><a href="#local-6989586621679083508"><span class="hs-identifier">noticeStrings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621679083029"><span class="hs-identifier hs-var">notices</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679083505"><a href="#local-6989586621679083505"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>          </span><a name="local-6989586621679083506"><a href="#local-6989586621679083506"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#genRequestId"><span class="hs-identifier hs-var">genRequestId</span></a><span>
</span><a name="line-226"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679083507"><a href="#local-6989586621679083507"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#putNotice"><span class="hs-identifier hs-var">putNotice</span></a><span> </span><a href="#local-6989586621679083505"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679083506"><span class="hs-identifier hs-var">requestId</span></a><span>
</span><a name="line-227"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083031"><span class="hs-identifier hs-var">lenBytes</span></a><span> </span><a href="#local-6989586621679083507"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679083507"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679083509"><a href="#local-6989586621679083509"><span class="hs-identifier">requestString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679083510"><a href="#local-6989586621679083510"><span class="hs-identifier">request</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679083511"><a href="#local-6989586621679083511"><span class="hs-identifier">requestId</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679083030"><span class="hs-identifier hs-var">mRequest</span></a><span>
</span><a name="line-231"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679083512"><a href="#local-6989586621679083512"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#putRequest"><span class="hs-identifier hs-var">putRequest</span></a><span> </span><a href="#local-6989586621679083510"><span class="hs-identifier hs-var">request</span></a><span> </span><a href="#local-6989586621679083511"><span class="hs-identifier hs-var">requestId</span></a><span>
</span><a name="line-232"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083031"><span class="hs-identifier hs-var">lenBytes</span></a><span> </span><a href="#local-6989586621679083512"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679083512"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">write</span><span> </span><a href="#local-6989586621679083028"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679083508"><span class="hs-identifier hs-var">noticeStrings</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeToList</span><span> </span><a href="#local-6989586621679083509"><span class="hs-identifier hs-var">requestString</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>    </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">flush</span><span> </span><a href="#local-6989586621679083028"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-236"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><a name="local-6989586621679083031"><a href="#local-6989586621679083031"><span class="hs-identifier">lenBytes</span></a></a><span> </span><a name="local-6989586621679083033"><a href="#local-6989586621679083033"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679083032"><span class="hs-identifier hs-var">encodeSize</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679083033"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-238"></a><span>    </span><a name="local-6989586621679083032"><a href="#local-6989586621679083032"><span class="hs-identifier">encodeSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-keyword">type</span><span> </span><a name="Response"><a href="Database.MongoDB.Internal.Protocol.html#Response"><span class="hs-identifier">Response</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#ResponseTo"><span class="hs-identifier hs-type">ResponseTo</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- ^ Message received from a Mongo server in response to a Request</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">readMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Response"><span class="hs-identifier hs-type">Response</span></a><span>
</span><a name="line-244"></a><span class="hs-comment">-- ^ read response from a connection</span><span>
</span><a name="line-245"></a><a name="readMessage"><a href="Database.MongoDB.Internal.Protocol.html#readMessage"><span class="hs-identifier">readMessage</span></a></a><span> </span><a name="local-6989586621679083513"><a href="#local-6989586621679083513"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679083514"><span class="hs-identifier hs-var">readResp</span></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621679083514"><a href="#local-6989586621679083514"><span class="hs-identifier">readResp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-247"></a><span>        </span><a name="local-6989586621679083516"><a href="#local-6989586621679083516"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679083515"><span class="hs-identifier hs-var">decodeSize</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">read</span><span> </span><a href="#local-6989586621679083513"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-identifier hs-var">runGet</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#getReply"><span class="hs-identifier hs-var">getReply</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">Tr</span><span class="hs-operator">.</span><span class="hs-identifier">read</span><span> </span><a href="#local-6989586621679083513"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679083516"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-249"></a><span>    </span><a name="local-6989586621679083515"><a href="#local-6989586621679083515"><span class="hs-identifier">decodeSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">subtract</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runGet</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-keyword">type</span><span> </span><a name="FullCollection"><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier">FullCollection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- ^ Database name and collection name with period (.) in between. Eg. \&quot;myDb.myCollection\&quot;</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-comment">-- ** Header</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-keyword">type</span><span> </span><a name="Opcode"><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier">Opcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-keyword">type</span><span> </span><a name="RequestId"><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier">RequestId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- ^ A fresh request id is generated for every message</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-keyword">type</span><span> </span><a name="ResponseTo"><a href="Database.MongoDB.Internal.Protocol.html#ResponseTo"><span class="hs-identifier">ResponseTo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">genRequestId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679082966"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679082966"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- ^ Generate fresh request id</span><span>
</span><a name="line-265"></a><a name="genRequestId"><a href="Database.MongoDB.Internal.Protocol.html#genRequestId"><span class="hs-identifier">genRequestId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef</span><span> </span><a href="#local-6989586621679083517"><span class="hs-identifier hs-var">counter</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679083531"><a href="#local-6989586621679083531"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083531"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679083531"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-identifier">counter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span>
</span><a name="line-267"></a><span>    </span><a name="local-6989586621679083517"><a href="#local-6989586621679083517"><span class="hs-identifier">counter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-pragma">{-# NOINLINE counter #-}</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- *** Binary format</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-identifier">putHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier hs-type">Opcode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- ^ Note, does not write message length (first int32), assumes caller will write it</span><span>
</span><a name="line-274"></a><a name="putHeader"><a href="Database.MongoDB.Internal.Protocol.html#putHeader"><span class="hs-identifier">putHeader</span></a></a><span> </span><a name="local-6989586621679083532"><a href="#local-6989586621679083532"><span class="hs-identifier">opcode</span></a></a><span> </span><a name="local-6989586621679083533"><a href="#local-6989586621679083533"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-identifier hs-var">putInt32</span><span> </span><a href="#local-6989586621679083533"><span class="hs-identifier hs-var">requestId</span></a><span>
</span><a name="line-276"></a><span>    </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-277"></a><span>    </span><span class="hs-identifier hs-var">putInt32</span><span> </span><a href="#local-6989586621679083532"><span class="hs-identifier hs-var">opcode</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-identifier">getHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier hs-type">Opcode</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ResponseTo"><span class="hs-identifier hs-type">ResponseTo</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- ^ Note, does not read message length (first int32), assumes it was already read</span><span>
</span><a name="line-281"></a><a name="getHeader"><a href="Database.MongoDB.Internal.Protocol.html#getHeader"><span class="hs-identifier">getHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-282"></a><span>    </span><a name="local-6989586621679083534"><a href="#local-6989586621679083534"><span class="hs-identifier">_requestId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-283"></a><span>    </span><a name="local-6989586621679083535"><a href="#local-6989586621679083535"><span class="hs-identifier">responseTo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-284"></a><span>    </span><a name="local-6989586621679083536"><a href="#local-6989586621679083536"><span class="hs-identifier">opcode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083536"><span class="hs-identifier hs-var">opcode</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679083535"><span class="hs-identifier hs-var">responseTo</span></a><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- ** Notice</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-comment">-- | A notice is a message that is sent with no reply</span><span>
</span><a name="line-290"></a><span class="hs-keyword">data</span><span> </span><a name="Notice"><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier">Notice</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-291"></a><span>      </span><a name="Insert"><a href="Database.MongoDB.Internal.Protocol.html#Insert"><span class="hs-identifier">Insert</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-292"></a><span>        </span><a name="iFullCollection"><a href="Database.MongoDB.Internal.Protocol.html#iFullCollection"><span class="hs-identifier">iFullCollection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-293"></a><span>        </span><a name="iOptions"><a href="Database.MongoDB.Internal.Protocol.html#iOptions"><span class="hs-identifier">iOptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-294"></a><span>        </span><a name="iDocuments"><a href="Database.MongoDB.Internal.Protocol.html#iDocuments"><span class="hs-identifier">iDocuments</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Update"><a href="Database.MongoDB.Internal.Protocol.html#Update"><span class="hs-identifier">Update</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-296"></a><span>        </span><a name="uFullCollection"><a href="Database.MongoDB.Internal.Protocol.html#uFullCollection"><span class="hs-identifier">uFullCollection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-297"></a><span>        </span><a name="uOptions"><a href="Database.MongoDB.Internal.Protocol.html#uOptions"><span class="hs-identifier">uOptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-298"></a><span>        </span><a name="uSelector"><a href="Database.MongoDB.Internal.Protocol.html#uSelector"><span class="hs-identifier">uSelector</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>        </span><a name="uUpdater"><a href="Database.MongoDB.Internal.Protocol.html#uUpdater"><span class="hs-identifier">uUpdater</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Delete"><a href="Database.MongoDB.Internal.Protocol.html#Delete"><span class="hs-identifier">Delete</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-301"></a><span>        </span><a name="dFullCollection"><a href="Database.MongoDB.Internal.Protocol.html#dFullCollection"><span class="hs-identifier">dFullCollection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-302"></a><span>        </span><a name="dOptions"><a href="Database.MongoDB.Internal.Protocol.html#dOptions"><span class="hs-identifier">dOptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-303"></a><span>        </span><a name="dSelector"><a href="Database.MongoDB.Internal.Protocol.html#dSelector"><span class="hs-identifier">dSelector</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">}</span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="KillCursors"><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier">KillCursors</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-305"></a><span>        </span><a name="kCursorIds"><a href="Database.MongoDB.Internal.Protocol.html#kCursorIds"><span class="hs-identifier">kCursorIds</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-keyword">data</span><span> </span><a name="InsertOption"><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier">InsertOption</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="KeepGoing"><a href="Database.MongoDB.Internal.Protocol.html#KeepGoing"><span class="hs-identifier">KeepGoing</span></a></a><span>  </span><span class="hs-comment">-- ^ If set, the database will not stop processing a bulk insert if one fails (eg due to duplicate IDs). This makes bulk insert behave similarly to a series of single inserts, except lastError will be set if any insert fails, not just the last one. (new in 1.9.1)</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-keyword">data</span><span> </span><a name="UpdateOption"><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier">UpdateOption</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-312"></a><span>      </span><a name="Upsert"><a href="Database.MongoDB.Internal.Protocol.html#Upsert"><span class="hs-identifier">Upsert</span></a></a><span>  </span><span class="hs-comment">-- ^ If set, the database will insert the supplied object into the collection if no matching document is found</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="MultiUpdate"><a href="Database.MongoDB.Internal.Protocol.html#MultiUpdate"><span class="hs-identifier">MultiUpdate</span></a></a><span>  </span><span class="hs-comment">-- ^ If set, the database will update all matching objects in the collection. Otherwise only updates first matching doc</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-keyword">data</span><span> </span><a name="DeleteOption"><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier">DeleteOption</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SingleRemove"><a href="Database.MongoDB.Internal.Protocol.html#SingleRemove"><span class="hs-identifier">SingleRemove</span></a></a><span>  </span><span class="hs-comment">-- ^ If set, the database will remove only the first matching document in the collection. Otherwise all matching documents will be removed</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-keyword">type</span><span> </span><a name="CursorId"><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier">CursorId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int64</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">-- *** Binary format</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-identifier">nOpcode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier hs-type">Opcode</span></a><span>
</span><a name="line-324"></a><a name="nOpcode"><a href="Database.MongoDB.Internal.Protocol.html#nOpcode"><span class="hs-identifier">nOpcode</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Update"><span class="hs-identifier hs-var">Update</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2001</span><span>
</span><a name="line-325"></a><span class="hs-identifier">nOpcode</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Insert"><span class="hs-identifier hs-var">Insert</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2002</span><span>
</span><a name="line-326"></a><span class="hs-identifier">nOpcode</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Delete"><span class="hs-identifier hs-var">Delete</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2006</span><span>
</span><a name="line-327"></a><span class="hs-identifier">nOpcode</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier hs-var">KillCursors</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2007</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">putNotice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Notice"><span class="hs-identifier hs-type">Notice</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-330"></a><a name="putNotice"><a href="Database.MongoDB.Internal.Protocol.html#putNotice"><span class="hs-identifier">putNotice</span></a></a><span> </span><a name="local-6989586621679083537"><a href="#local-6989586621679083537"><span class="hs-identifier">notice</span></a></a><span> </span><a name="local-6989586621679083538"><a href="#local-6989586621679083538"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#putHeader"><span class="hs-identifier hs-var">putHeader</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#nOpcode"><span class="hs-identifier hs-var">nOpcode</span></a><span> </span><a href="#local-6989586621679083537"><span class="hs-identifier hs-var">notice</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679083538"><span class="hs-identifier hs-var">requestId</span></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679083537"><span class="hs-identifier hs-var">notice</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-333"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#Insert"><span class="hs-identifier hs-var">Insert</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-334"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#iBits"><span class="hs-identifier hs-var">iBits</span></a><span> </span><a href="#local-6989586621679083540"><span class="hs-identifier hs-var">iOptions</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>            </span><span class="hs-identifier hs-var">putCString</span><span> </span><a href="#local-6989586621679083539"><span class="hs-identifier hs-var">iFullCollection</span></a><span>
</span><a name="line-336"></a><span>            </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083541"><span class="hs-identifier hs-var">iDocuments</span></a><span>
</span><a name="line-337"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#Update"><span class="hs-identifier hs-var">Update</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-338"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-339"></a><span>            </span><span class="hs-identifier hs-var">putCString</span><span> </span><a href="#local-6989586621679083542"><span class="hs-identifier hs-var">uFullCollection</span></a><span>
</span><a name="line-340"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#uBits"><span class="hs-identifier hs-var">uBits</span></a><span> </span><a href="#local-6989586621679083543"><span class="hs-identifier hs-var">uOptions</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>            </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083544"><span class="hs-identifier hs-var">uSelector</span></a><span>
</span><a name="line-342"></a><span>            </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083545"><span class="hs-identifier hs-var">uUpdater</span></a><span>
</span><a name="line-343"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#Delete"><span class="hs-identifier hs-var">Delete</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-344"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-345"></a><span>            </span><span class="hs-identifier hs-var">putCString</span><span> </span><a href="#local-6989586621679083546"><span class="hs-identifier hs-var">dFullCollection</span></a><span>
</span><a name="line-346"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#dBits"><span class="hs-identifier hs-var">dBits</span></a><span> </span><a href="#local-6989586621679083547"><span class="hs-identifier hs-var">dOptions</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>            </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083548"><span class="hs-identifier hs-var">dSelector</span></a><span>
</span><a name="line-348"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#KillCursors"><span class="hs-identifier hs-var">KillCursors</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-349"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-350"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679083549"><span class="hs-identifier hs-var">kCursorIds</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>            </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">putInt64</span><span> </span><a href="#local-6989586621679083549"><span class="hs-identifier hs-var">kCursorIds</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">iBit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-354"></a><a name="iBit"><a href="Database.MongoDB.Internal.Protocol.html#iBit"><span class="hs-identifier">iBit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#KeepGoing"><span class="hs-identifier hs-var">KeepGoing</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">iBits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#InsertOption"><span class="hs-identifier hs-type">InsertOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-357"></a><a name="iBits"><a href="Database.MongoDB.Internal.Protocol.html#iBits"><span class="hs-identifier">iBits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#bitOr"><span class="hs-identifier hs-var">bitOr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#iBit"><span class="hs-identifier hs-var">iBit</span></a><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">uBit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-360"></a><a name="uBit"><a href="Database.MongoDB.Internal.Protocol.html#uBit"><span class="hs-identifier">uBit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Upsert"><span class="hs-identifier hs-var">Upsert</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-361"></a><span class="hs-identifier">uBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#MultiUpdate"><span class="hs-identifier hs-var">MultiUpdate</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">uBits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#UpdateOption"><span class="hs-identifier hs-type">UpdateOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-364"></a><a name="uBits"><a href="Database.MongoDB.Internal.Protocol.html#uBits"><span class="hs-identifier">uBits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#bitOr"><span class="hs-identifier hs-var">bitOr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#uBit"><span class="hs-identifier hs-var">uBit</span></a><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span class="hs-identifier">dBit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-367"></a><a name="dBit"><a href="Database.MongoDB.Internal.Protocol.html#dBit"><span class="hs-identifier">dBit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#SingleRemove"><span class="hs-identifier hs-var">SingleRemove</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">dBits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#DeleteOption"><span class="hs-identifier hs-type">DeleteOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-370"></a><a name="dBits"><a href="Database.MongoDB.Internal.Protocol.html#dBits"><span class="hs-identifier">dBits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#bitOr"><span class="hs-identifier hs-var">bitOr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#dBit"><span class="hs-identifier hs-var">dBit</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-comment">-- ** Request</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-comment">-- | A request is a message that is sent with a 'Reply' expected in return</span><span>
</span><a name="line-375"></a><span class="hs-keyword">data</span><span> </span><a name="Request"><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier">Request</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-376"></a><span>      </span><a name="Query"><a href="Database.MongoDB.Internal.Protocol.html#Query"><span class="hs-identifier">Query</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-377"></a><span>        </span><a name="qOptions"><a href="Database.MongoDB.Internal.Protocol.html#qOptions"><span class="hs-identifier">qOptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-378"></a><span>        </span><a name="qFullCollection"><a href="Database.MongoDB.Internal.Protocol.html#qFullCollection"><span class="hs-identifier">qFullCollection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-379"></a><span>        </span><a name="qSkip"><a href="Database.MongoDB.Internal.Protocol.html#qSkip"><span class="hs-identifier">qSkip</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ Number of initial matching documents to skip</span><span>
</span><a name="line-380"></a><span>        </span><a name="qBatchSize"><a href="Database.MongoDB.Internal.Protocol.html#qBatchSize"><span class="hs-identifier">qBatchSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ The number of document to return in each batch response from the server. 0 means use Mongo default. Negative means close cursor after first batch and use absolute value as batch size.</span><span>
</span><a name="line-381"></a><span>        </span><a name="qSelector"><a href="Database.MongoDB.Internal.Protocol.html#qSelector"><span class="hs-identifier">qSelector</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ \[\] = return all documents in collection</span><span>
</span><a name="line-382"></a><span>        </span><a name="qProjector"><a href="Database.MongoDB.Internal.Protocol.html#qProjector"><span class="hs-identifier">qProjector</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Document</span><span>  </span><span class="hs-comment">-- ^ \[\] = return whole document</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="GetMore"><a href="Database.MongoDB.Internal.Protocol.html#GetMore"><span class="hs-identifier">GetMore</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-384"></a><span>        </span><a name="gFullCollection"><a href="Database.MongoDB.Internal.Protocol.html#gFullCollection"><span class="hs-identifier">gFullCollection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#FullCollection"><span class="hs-identifier hs-type">FullCollection</span></a><span class="hs-special">,</span><span>
</span><a name="line-385"></a><span>        </span><a name="gBatchSize"><a href="Database.MongoDB.Internal.Protocol.html#gBatchSize"><span class="hs-identifier">gBatchSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span>
</span><a name="line-386"></a><span>        </span><a name="gCursorId"><a href="Database.MongoDB.Internal.Protocol.html#gCursorId"><span class="hs-identifier">gCursorId</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span class="hs-special">}</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-keyword">data</span><span> </span><a name="QueryOption"><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier">QueryOption</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-390"></a><span>      </span><a name="TailableCursor"><a href="Database.MongoDB.Internal.Protocol.html#TailableCursor"><span class="hs-identifier">TailableCursor</span></a></a><span>  </span><span class="hs-comment">-- ^ Tailable means cursor is not closed when the last data is retrieved. Rather, the cursor marks the final object's position. You can resume using the cursor later, from where it was located, if more data were received. Like any &quot;latent cursor&quot;, the cursor may become invalid at some point &#8211; for example if the final object it references were deleted. Thus, you should be prepared to requery on CursorNotFound exception.</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="SlaveOK"><a href="Database.MongoDB.Internal.Protocol.html#SlaveOK"><span class="hs-identifier">SlaveOK</span></a></a><span>  </span><span class="hs-comment">-- ^ Allow query of replica slave. Normally these return an error except for namespace &quot;local&quot;.</span><span>
</span><a name="line-392"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="NoCursorTimeout"><a href="Database.MongoDB.Internal.Protocol.html#NoCursorTimeout"><span class="hs-identifier">NoCursorTimeout</span></a></a><span>  </span><span class="hs-comment">-- ^ The server normally times out idle cursors after 10 minutes to prevent a memory leak in case a client forgets to close a cursor. Set this option to allow a cursor to live forever until it is closed.</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="AwaitData"><a href="Database.MongoDB.Internal.Protocol.html#AwaitData"><span class="hs-identifier">AwaitData</span></a></a><span>  </span><span class="hs-comment">-- ^ Use with TailableCursor. If we are at the end of the data, block for a while rather than returning no data. After a timeout period, we do return as normal.</span><span>
</span><a name="line-394"></a><span class="hs-comment">--  | Exhaust  -- ^ Stream the data down full blast in multiple &quot;more&quot; packages, on the assumption that the client will fully read all data queried. Faster when you are pulling a lot of data and know you want to pull it all down. Note: the client is not allowed to not read all the data unless it closes the connection.</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- Exhaust commented out because not compatible with current `Pipeline` implementation</span><span>
</span><a name="line-396"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="Partial"><a href="Database.MongoDB.Internal.Protocol.html#Partial"><span class="hs-identifier">Partial</span></a></a><span>  </span><span class="hs-comment">-- ^ Get partial results from a _mongos_ if some shards are down, instead of throwing an error.</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-- *** Binary format</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-identifier">qOpcode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier hs-type">Opcode</span></a><span>
</span><a name="line-402"></a><a name="qOpcode"><a href="Database.MongoDB.Internal.Protocol.html#qOpcode"><span class="hs-identifier">qOpcode</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Query"><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2004</span><span>
</span><a name="line-403"></a><span class="hs-identifier">qOpcode</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#GetMore"><span class="hs-identifier hs-var">GetMore</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2005</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-identifier">putRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-406"></a><a name="putRequest"><a href="Database.MongoDB.Internal.Protocol.html#putRequest"><span class="hs-identifier">putRequest</span></a></a><span> </span><a name="local-6989586621679083550"><a href="#local-6989586621679083550"><span class="hs-identifier">request</span></a></a><span> </span><a name="local-6989586621679083551"><a href="#local-6989586621679083551"><span class="hs-identifier">requestId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-407"></a><span>    </span><a href="Database.MongoDB.Internal.Protocol.html#putHeader"><span class="hs-identifier hs-var">putHeader</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#qOpcode"><span class="hs-identifier hs-var">qOpcode</span></a><span> </span><a href="#local-6989586621679083550"><span class="hs-identifier hs-var">request</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679083551"><span class="hs-identifier hs-var">requestId</span></a><span>
</span><a name="line-408"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679083550"><span class="hs-identifier hs-var">request</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-409"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#Query"><span class="hs-identifier hs-var">Query</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-410"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#qBits"><span class="hs-identifier hs-var">qBits</span></a><span> </span><a href="#local-6989586621679083552"><span class="hs-identifier hs-var">qOptions</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>            </span><span class="hs-identifier hs-var">putCString</span><span> </span><a href="#local-6989586621679083553"><span class="hs-identifier hs-var">qFullCollection</span></a><span>
</span><a name="line-412"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><a href="#local-6989586621679083554"><span class="hs-identifier hs-var">qSkip</span></a><span>
</span><a name="line-413"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><a href="#local-6989586621679083555"><span class="hs-identifier hs-var">qBatchSize</span></a><span>
</span><a name="line-414"></a><span>            </span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083556"><span class="hs-identifier hs-var">qSelector</span></a><span>
</span><a name="line-415"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679083557"><span class="hs-identifier hs-var">qProjector</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putDocument</span><span> </span><a href="#local-6989586621679083557"><span class="hs-identifier hs-var">qProjector</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>        </span><a href="Database.MongoDB.Internal.Protocol.html#GetMore"><span class="hs-identifier hs-var">GetMore</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-417"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-418"></a><span>            </span><span class="hs-identifier hs-var">putCString</span><span> </span><a href="#local-6989586621679083558"><span class="hs-identifier hs-var">gFullCollection</span></a><span>
</span><a name="line-419"></a><span>            </span><span class="hs-identifier hs-var">putInt32</span><span> </span><a href="#local-6989586621679083559"><span class="hs-identifier hs-var">gBatchSize</span></a><span>
</span><a name="line-420"></a><span>            </span><span class="hs-identifier hs-var">putInt64</span><span> </span><a href="#local-6989586621679083560"><span class="hs-identifier hs-var">gCursorId</span></a><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-identifier">qBit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-423"></a><a name="qBit"><a href="Database.MongoDB.Internal.Protocol.html#qBit"><span class="hs-identifier">qBit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#TailableCursor"><span class="hs-identifier hs-var">TailableCursor</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-424"></a><span class="hs-identifier">qBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#SlaveOK"><span class="hs-identifier hs-var">SlaveOK</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-425"></a><span class="hs-identifier">qBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#NoCursorTimeout"><span class="hs-identifier hs-var">NoCursorTimeout</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-426"></a><span class="hs-identifier">qBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#AwaitData"><span class="hs-identifier hs-var">AwaitData</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-427"></a><span class="hs-comment">--qBit Exhaust = bit 6</span><span>
</span><a name="line-428"></a><span class="hs-identifier">qBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Partial"><span class="hs-identifier hs-var">Partial</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bit</span><span> </span><span class="hs-number">7</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">qBits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#QueryOption"><span class="hs-identifier hs-type">QueryOption</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-431"></a><a name="qBits"><a href="Database.MongoDB.Internal.Protocol.html#qBits"><span class="hs-identifier">qBits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.MongoDB.Internal.Util.html#bitOr"><span class="hs-identifier hs-var">bitOr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#qBit"><span class="hs-identifier hs-var">qBit</span></a><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-comment">-- ** Reply</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-comment">-- | A reply is a message received in response to a 'Request'</span><span>
</span><a name="line-436"></a><span class="hs-keyword">data</span><span> </span><a name="Reply"><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier">Reply</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Reply"><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier">Reply</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-437"></a><span>    </span><a name="rResponseFlags"><a href="Database.MongoDB.Internal.Protocol.html#rResponseFlags"><span class="hs-identifier">rResponseFlags</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier hs-type">ResponseFlag</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-438"></a><span>    </span><a name="rCursorId"><a href="Database.MongoDB.Internal.Protocol.html#rCursorId"><span class="hs-identifier">rCursorId</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorId"><span class="hs-identifier hs-type">CursorId</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ^ 0 = cursor finished</span><span>
</span><a name="line-439"></a><span>    </span><a name="rStartingFrom"><a href="Database.MongoDB.Internal.Protocol.html#rStartingFrom"><span class="hs-identifier">rStartingFrom</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">,</span><span>
</span><a name="line-440"></a><span>    </span><a name="rDocuments"><a href="Database.MongoDB.Internal.Protocol.html#rDocuments"><span class="hs-identifier">rDocuments</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Document</span><span class="hs-special">]</span><span>
</span><a name="line-441"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-keyword">data</span><span> </span><a name="ResponseFlag"><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier">ResponseFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-444"></a><span>      </span><a name="CursorNotFound"><a href="Database.MongoDB.Internal.Protocol.html#CursorNotFound"><span class="hs-identifier">CursorNotFound</span></a></a><span>  </span><span class="hs-comment">-- ^ Set when getMore is called but the cursor id is not valid at the server. Returned with zero results.</span><span>
</span><a name="line-445"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="QueryError"><a href="Database.MongoDB.Internal.Protocol.html#QueryError"><span class="hs-identifier">QueryError</span></a></a><span>  </span><span class="hs-comment">-- ^ Query error. Returned with one document containing an &quot;$err&quot; field holding the error message.</span><span>
</span><a name="line-446"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="AwaitCapable"><a href="Database.MongoDB.Internal.Protocol.html#AwaitCapable"><span class="hs-identifier">AwaitCapable</span></a></a><span>  </span><span class="hs-comment">-- ^ For backward compatability: Set when the server supports the AwaitData query option. if it doesn't, a replica slave client should sleep a little between getMore's</span><span>
</span><a name="line-447"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-comment">-- * Binary format</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">replyOpcode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Opcode"><span class="hs-identifier hs-type">Opcode</span></a><span>
</span><a name="line-452"></a><a name="replyOpcode"><a href="Database.MongoDB.Internal.Protocol.html#replyOpcode"><span class="hs-identifier">replyOpcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-identifier">getReply</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#ResponseTo"><span class="hs-identifier hs-type">ResponseTo</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-type">Reply</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><a name="getReply"><a href="Database.MongoDB.Internal.Protocol.html#getReply"><span class="hs-identifier">getReply</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679083561"><a href="#local-6989586621679083561"><span class="hs-identifier">opcode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679083562"><a href="#local-6989586621679083562"><span class="hs-identifier">responseTo</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a><span>
</span><a name="line-457"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083561"><span class="hs-identifier hs-var">opcode</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#replyOpcode"><span class="hs-identifier hs-var">replyOpcode</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;expected reply opcode (1) but got &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679083561"><span class="hs-identifier hs-var">opcode</span></a><span>
</span><a name="line-458"></a><span>    </span><a name="local-6989586621679083563"><a href="#local-6989586621679083563"><span class="hs-identifier">rResponseFlags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><a href="Database.MongoDB.Internal.Protocol.html#rFlags"><span class="hs-identifier hs-var">rFlags</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-459"></a><span>    </span><a name="local-6989586621679083564"><a href="#local-6989586621679083564"><span class="hs-identifier">rCursorId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getInt64</span><span>
</span><a name="line-460"></a><span>    </span><a name="local-6989586621679083565"><a href="#local-6989586621679083565"><span class="hs-identifier">rStartingFrom</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-461"></a><span>    </span><a name="local-6989586621679083566"><a href="#local-6989586621679083566"><span class="hs-identifier">numDocs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getInt32</span><span>
</span><a name="line-462"></a><span>    </span><a name="local-6989586621679083567"><a href="#local-6989586621679083567"><span class="hs-identifier">rDocuments</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621679083566"><span class="hs-identifier hs-var">numDocs</span></a><span> </span><span class="hs-identifier hs-var">getDocument</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679083562"><span class="hs-identifier hs-var">responseTo</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Reply"><span class="hs-identifier hs-var">Reply</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">rFlags</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier hs-type">ResponseFlag</span></a><span class="hs-special">]</span><span>
</span><a name="line-466"></a><a name="rFlags"><a href="Database.MongoDB.Internal.Protocol.html#rFlags"><span class="hs-identifier">rFlags</span></a></a><span> </span><a name="local-6989586621679083568"><a href="#local-6989586621679083568"><span class="hs-identifier">bits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">testBit</span><span> </span><a href="#local-6989586621679083568"><span class="hs-identifier hs-var">bits</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#rBit"><span class="hs-identifier hs-var">rBit</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Database.MongoDB.Internal.Protocol.html#CursorNotFound"><span class="hs-identifier hs-var">CursorNotFound</span></a><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span class="hs-identifier">rBit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#ResponseFlag"><span class="hs-identifier hs-type">ResponseFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-469"></a><a name="rBit"><a href="Database.MongoDB.Internal.Protocol.html#rBit"><span class="hs-identifier">rBit</span></a></a><span> </span><a href="Database.MongoDB.Internal.Protocol.html#CursorNotFound"><span class="hs-identifier hs-var">CursorNotFound</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-470"></a><span class="hs-identifier">rBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#QueryError"><span class="hs-identifier hs-var">QueryError</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-471"></a><span class="hs-identifier">rBit</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#AwaitCapable"><span class="hs-identifier hs-var">AwaitCapable</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-comment">-- * Authentication</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-keyword">type</span><span> </span><a name="Username"><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier">Username</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-476"></a><span class="hs-keyword">type</span><span> </span><a name="Password"><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier">Password</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-477"></a><span class="hs-keyword">type</span><span> </span><a name="Nonce"><a href="Database.MongoDB.Internal.Protocol.html#Nonce"><span class="hs-identifier">Nonce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">pwHash</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-480"></a><a name="pwHash"><a href="Database.MongoDB.Internal.Protocol.html#pwHash"><span class="hs-identifier">pwHash</span></a></a><span> </span><a name="local-6989586621679083569"><a href="#local-6989586621679083569"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679083570"><a href="#local-6989586621679083570"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.MongoDB.Internal.Util.html#byteStringHex"><span class="hs-identifier hs-var">byteStringHex</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">MD5</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679083569"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;:mongo:&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679083570"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-identifier">pwKey</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Nonce"><span class="hs-identifier hs-type">Nonce</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Username"><span class="hs-identifier hs-type">Username</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Password"><span class="hs-identifier hs-type">Password</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-483"></a><a name="pwKey"><a href="Database.MongoDB.Internal.Protocol.html#pwKey"><span class="hs-identifier">pwKey</span></a></a><span> </span><a name="local-6989586621679083571"><a href="#local-6989586621679083571"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679083572"><a href="#local-6989586621679083572"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679083573"><a href="#local-6989586621679083573"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.MongoDB.Internal.Util.html#byteStringHex"><span class="hs-identifier hs-var">byteStringHex</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">MD5</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hash</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span> </span><a href="#local-6989586621679083571"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span><span> </span><a href="#local-6989586621679083572"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#pwHash"><span class="hs-identifier hs-var">pwHash</span></a><span> </span><a href="#local-6989586621679083572"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679083573"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">{- Authors: Tony Hannan &lt;tony@10gen.com&gt;
   Copyright 2011 10gen Inc.
   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License. -}</span><span>
</span><a name="line-489"></a></pre></body></html>