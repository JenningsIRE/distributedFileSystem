<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-cpp">#if (__GLASGOW_HASKELL__ &gt;= 706)</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RecursiveDo #-}</span><span>
</span><a name="line-7"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE DoRec #-}</span><span>
</span><a name="line-9"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">{-|
Module      : MongoDB TLS
Copyright   : (c)	Yuras Shumovich, 2016
License     : Apache 2.0
Maintainer  : Victor Denisov denisovenator@gmail.com
Stability   : experimental
Portability : POSIX

This module is for connecting to TLS enabled mongodb servers.
ATTENTION!!! Be aware that this module is highly experimental and is
barely tested. The current implementation doesn't verify server's identity.
It only allows you to connect to a mongodb server using TLS protocol.
-}</span><span>
</span><a name="line-24"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transport</span><span class="hs-operator">.</span><span class="hs-identifier">Tls</span><span>
</span><a name="line-25"></a><span class="hs-special">(</span><a href="Database.MongoDB.Transport.Tls.html#connect"><span class="hs-identifier hs-var">connect</span></a><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">where</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">ByteString</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Lazy</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Default</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">def</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bracketOnError</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Internal.Protocol.html#newPipeWith"><span class="hs-identifier hs-var">newPipeWith</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Transport.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transport</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span class="hs-special">(</span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-var">Transport</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.MongoDB.Transport.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Transport</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIOError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eofErrorType</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">connectTo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HostName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PortID</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">TLS</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TLS</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">Extra</span><span class="hs-operator">.</span><span class="hs-identifier">Cipher</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TLS</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Database.MongoDB.Query.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">MongoDB</span><span class="hs-operator">.</span><span class="hs-identifier">Query</span></a><span> </span><span class="hs-special">(</span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span class="hs-special">,</span><span> </span><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier hs-var">retrieveServerData</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- | Connect to mongodb using TLS</span><span>
</span><a name="line-48"></a><span class="hs-identifier">connect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HostName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PortID</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a><span>
</span><a name="line-49"></a><a name="connect"><a href="Database.MongoDB.Transport.Tls.html#connect"><span class="hs-identifier">connect</span></a></a><span> </span><a name="local-6989586621679132297"><a href="#local-6989586621679132297"><span class="hs-identifier">host</span></a></a><span> </span><a name="local-6989586621679132298"><a href="#local-6989586621679132298"><span class="hs-identifier">port</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bracketOnError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">connectTo</span><span> </span><a href="#local-6989586621679132297"><span class="hs-identifier hs-var">host</span></a><span> </span><a href="#local-6989586621679132298"><span class="hs-identifier hs-var">port</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">hClose</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679132299"><a href="#local-6989586621679132299"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679132300"><a href="#local-6989586621679132300"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">defaultParamsClient</span><span> </span><a href="#local-6989586621679132297"><span class="hs-identifier hs-var">host</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">clientSupported</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">def</span><span>
</span><a name="line-53"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">supportedCiphers</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ciphersuite_all</span><span class="hs-special">}</span><span>
</span><a name="line-54"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">clientHooks</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">def</span><span>
</span><a name="line-55"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">onServerCertificate</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-56"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-57"></a><span>  </span><a name="local-6989586621679132686"><a href="#local-6989586621679132686"><span class="hs-identifier">context</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextNew</span><span> </span><a href="#local-6989586621679132299"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621679132300"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">handshake</span><span> </span><a href="#local-6989586621679132686"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>  </span><a name="local-6989586621679132697"><a href="#local-6989586621679132697"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Transport.Tls.html#tlsConnection"><span class="hs-identifier hs-var">tlsConnection</span></a><span> </span><a href="#local-6989586621679132686"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-identifier">rec</span><span>
</span><a name="line-62"></a><span>    </span><a name="local-6989586621679132698"><a href="#local-6989586621679132698"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Internal.Protocol.html#newPipeWith"><span class="hs-identifier hs-var">newPipeWith</span></a><span> </span><a href="#local-6989586621679132699"><span class="hs-identifier hs-var">sd</span></a><span> </span><a href="#local-6989586621679132697"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-63"></a><span>    </span><a name="local-6989586621679132699"><a href="#local-6989586621679132699"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.MongoDB.Query.html#access"><span class="hs-identifier hs-var">access</span></a><span> </span><a href="#local-6989586621679132698"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Database.MongoDB.Query.html#slaveOk"><span class="hs-identifier hs-var">slaveOk</span></a><span> </span><span class="hs-string">&quot;admin&quot;</span><span> </span><a href="Database.MongoDB.Query.html#retrieveServerData"><span class="hs-identifier hs-var">retrieveServerData</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679132698"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-identifier">tlsConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TLS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Context</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-type">Transport</span></a><span>
</span><a name="line-67"></a><a name="tlsConnection"><a href="Database.MongoDB.Transport.Tls.html#tlsConnection"><span class="hs-identifier">tlsConnection</span></a></a><span> </span><a name="local-6989586621679132700"><a href="#local-6989586621679132700"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621679132701"><a href="#local-6989586621679132701"><span class="hs-identifier">restRef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Database.MongoDB.Transport.html#Transport"><span class="hs-identifier hs-var">Transport</span></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">T</span><span class="hs-operator">.</span><span class="hs-identifier">read</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679132702"><a href="#local-6989586621679132702"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-71"></a><span>          </span><a name="local-6989586621679132703"><a href="#local-6989586621679132703"><span class="hs-identifier">readSome</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-72"></a><span>            </span><a name="local-6989586621679132707"><a href="#local-6989586621679132707"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679132701"><span class="hs-identifier hs-var">restRef</span></a><span>
</span><a name="line-73"></a><span>            </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679132701"><span class="hs-identifier hs-var">restRef</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-74"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679132707"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-75"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">recvData</span><span> </span><a href="#local-6989586621679132700"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-76"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679132707"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-77"></a><span>          </span><a name="local-6989586621679132704"><a href="#local-6989586621679132704"><span class="hs-identifier">unread</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679132734"><a href="#local-6989586621679132734"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-78"></a><span>            </span><span class="hs-identifier hs-var">modifyIORef</span><span> </span><a href="#local-6989586621679132701"><span class="hs-identifier hs-var">restRef</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679132734"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>          </span><a name="local-6989586621679132705"><a href="#local-6989586621679132705"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679132735"><a href="#local-6989586621679132735"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621679132736"><a href="#local-6989586621679132736"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-80"></a><span>            </span><span class="hs-comment">-- read until get enough bytes</span><span>
</span><a name="line-81"></a><span>            </span><a name="local-6989586621679132737"><a href="#local-6989586621679132737"><span class="hs-identifier">chunk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679132703"><span class="hs-identifier hs-var">readSome</span></a><span>
</span><a name="line-82"></a><span>            </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679132737"><span class="hs-identifier hs-var">chunk</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-83"></a><span>              </span><span class="hs-identifier hs-var">ioError</span><span> </span><a href="#local-6989586621679132706"><span class="hs-identifier hs-var">eof</span></a><span>
</span><a name="line-84"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679132738"><a href="#local-6989586621679132738"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679132737"><span class="hs-identifier hs-var">chunk</span></a><span>
</span><a name="line-85"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679132738"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679132736"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-86"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-87"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679132739"><a href="#local-6989586621679132739"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679132740"><a href="#local-6989586621679132740"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621679132736"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679132737"><span class="hs-identifier hs-var">chunk</span></a><span>
</span><a name="line-88"></a><span>                </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-89"></a><span>                  </span><a href="#local-6989586621679132704"><span class="hs-identifier hs-var">unread</span></a><span> </span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-90"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679132735"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">Lazy</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><a href="#local-6989586621679132739"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679132705"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679132735"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">Lazy</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><a href="#local-6989586621679132737"><span class="hs-identifier hs-var">chunk</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679132736"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679132738"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>          </span><a name="local-6989586621679132706"><a href="#local-6989586621679132706"><span class="hs-identifier">eof</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIOError</span><span> </span><span class="hs-identifier hs-var">eofErrorType</span><span> </span><span class="hs-string">&quot;Database.MongoDB.Transport&quot;</span><span>
</span><a name="line-93"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-94"></a><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Lazy</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679132705"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><a href="#local-6989586621679132702"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-95"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">T</span><span class="hs-operator">.</span><span class="hs-identifier">write</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendData</span><span> </span><a href="#local-6989586621679132700"><span class="hs-identifier hs-var">ctx</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Lazy</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ByteString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">T</span><span class="hs-operator">.</span><span class="hs-identifier">flush</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextFlush</span><span> </span><a href="#local-6989586621679132700"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">T</span><span class="hs-operator">.</span><span class="hs-identifier">close</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextClose</span><span> </span><a href="#local-6989586621679132700"><span class="hs-identifier hs-var">ctx</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-99"></a></pre></body></html>